package io.spring.identityadmin.resource.service;

import io.spring.identityadmin.domain.entity.ConditionTemplate;
import io.spring.identityadmin.domain.entity.ManagedResource;
import io.spring.identityadmin.domain.entity.Permission;
import io.spring.identityadmin.repository.ConditionTemplateRepository;
import io.spring.identityadmin.repository.ManagedResourceRepository;
import io.spring.identityadmin.repository.PermissionRepository;
import io.spring.identityadmin.resource.MethodPatternAnalyzer;
import io.spring.identityadmin.resource.MethodPatternAnalyzer.MethodAnalysisResult;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Slf4j
public class AutoConditionTemplateService {

    private final ConditionTemplateRepository conditionTemplateRepository;
    private final MethodPatternAnalyzer methodPatternAnalyzer;
    private final PermissionRepository permissionRepository;
    private final ManagedResourceRepository managedResourceRepository;

    /**
     * ìë™ ìƒì„±ëœ ì¡°ê±´ í…œí”Œë¦¿ ì •ë³´ë¥¼ ë‹´ëŠ” DTO
     */
    public static class AutoGeneratedTemplate {
        private String name;
        private String description;
        private String spelTemplate;
        private String templateType;
        private String sourceMethod;
        private boolean isUniversal;
        private Map<String, Object> metadata;

        // ìƒì„±ì, getter, setter
        public AutoGeneratedTemplate(String name, String description, String spelTemplate, 
                                   String templateType, String sourceMethod, boolean isUniversal) {
            this.name = name;
            this.description = description;
            this.spelTemplate = spelTemplate;
            this.templateType = templateType;
            this.sourceMethod = sourceMethod;
            this.isUniversal = isUniversal;
            this.metadata = new HashMap<>();
        }

        // Getters and Setters
        public String getName() { return name; }
        public void setName(String name) { this.name = name; }
        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }
        public String getSpelTemplate() { return spelTemplate; }
        public void setSpelTemplate(String spelTemplate) { this.spelTemplate = spelTemplate; }
        public String getTemplateType() { return templateType; }
        public void setTemplateType(String templateType) { this.templateType = templateType; }
        public String getSourceMethod() { return sourceMethod; }
        public void setSourceMethod(String sourceMethod) { this.sourceMethod = sourceMethod; }
        public boolean isUniversal() { return isUniversal; }
        public void setUniversal(boolean universal) { isUniversal = universal; }
        public Map<String, Object> getMetadata() { return metadata; }
        public void setMetadata(Map<String, Object> metadata) { this.metadata = metadata; }
    }

    /**
     * ë©”ì„œë“œ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¡°ê±´ í…œí”Œë¦¿ì„ ìë™ ìƒì„±í•©ë‹ˆë‹¤.
     */
    @Transactional
    public List<ConditionTemplate> generateTemplatesFromAnalysis(List<MethodAnalysisResult> analysisResults) {
        log.info("ğŸ”„ ìë™ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì‹œì‘: {} ê°œ ë¶„ì„ ê²°ê³¼", analysisResults.size());

        List<ConditionTemplate> generatedTemplates = new ArrayList<>();

        // 1. ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± (í•œ ë²ˆë§Œ)
        List<ConditionTemplate> universalTemplates = generateUniversalTemplates();
        generatedTemplates.addAll(universalTemplates);

        // 2. ë©”ì„œë“œë³„ íŠ¹í™” í…œí”Œë¦¿ ìƒì„±
        for (MethodAnalysisResult analysis : analysisResults) {
            List<ConditionTemplate> methodTemplates = generateMethodSpecificTemplates(analysis);
            generatedTemplates.addAll(methodTemplates);
        }

        // 3. ì¤‘ë³µ ì œê±° ë° DB ì €ì¥
        List<ConditionTemplate> savedTemplates = saveDedupedTemplates(generatedTemplates);

        log.info("âœ… ìë™ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì™„ë£Œ: {} ê°œ í…œí”Œë¦¿ ì €ì¥", savedTemplates.size());
        return savedTemplates;
    }

    /**
     * ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ë“¤ì„ ìƒì„±í•©ë‹ˆë‹¤.
     */
    private List<ConditionTemplate> generateUniversalTemplates() {
        List<AutoGeneratedTemplate> universalTemplates = Arrays.asList(
            // ì‹œê°„ ê¸°ë°˜ ì¡°ê±´ë“¤
            new AutoGeneratedTemplate(
                "ì—…ë¬´ì‹œê°„ ì ‘ê·¼",
                "í‰ì¼ ì˜¤ì „ 9ì‹œë¶€í„° ì˜¤í›„ 6ì‹œê¹Œì§€ë§Œ ì ‘ê·¼ í—ˆìš©",
                "T(java.time.LocalTime).now().hour >= 9 and T(java.time.LocalTime).now().hour <= 18",
                "universal", "system_generated", true),
            
            new AutoGeneratedTemplate(
                "í‰ì¼ ì ‘ê·¼",
                "ì›”ìš”ì¼ë¶€í„° ê¸ˆìš”ì¼ê¹Œì§€ë§Œ ì ‘ê·¼ í—ˆìš©",
                "T(java.time.LocalDate).now().dayOfWeek.value <= 5",
                "universal", "system_generated", true),

            // IP ê¸°ë°˜ ì¡°ê±´ë“¤
            new AutoGeneratedTemplate(
                "ë‚´ë¶€ë§ ì ‘ê·¼",
                "192.168.x.x ëŒ€ì—­ì—ì„œë§Œ ì ‘ê·¼ í—ˆìš©",
                "#request.remoteAddr matches '^192\\\\.168\\\\..*'",
                "universal", "system_generated", true),

            new AutoGeneratedTemplate(
                "ì‚¬ë‚´ë§ ì ‘ê·¼",
                "10.x.x.x ëŒ€ì—­ì—ì„œë§Œ ì ‘ê·¼ í—ˆìš©",
                "#request.remoteAddr matches '^10\\\\..*'",
                "universal", "system_generated", true),

            // ì—­í•  ê¸°ë°˜ ì¡°ê±´ë“¤
            new AutoGeneratedTemplate(
                "ê´€ë¦¬ì ê¶Œí•œ",
                "ADMIN ì—­í• ì„ ê°€ì§„ ì‚¬ìš©ìë§Œ ì ‘ê·¼ í—ˆìš©",
                "hasRole('ADMIN')",
                "universal", "system_generated", true),

            new AutoGeneratedTemplate(
                "ë§¤ë‹ˆì € ê¶Œí•œ",
                "MANAGER ì—­í• ì„ ê°€ì§„ ì‚¬ìš©ìë§Œ ì ‘ê·¼ í—ˆìš©",
                "hasRole('MANAGER')",
                "universal", "system_generated", true),

            new AutoGeneratedTemplate(
                "ì‹œìŠ¤í…œ ê´€ë¦¬ì",
                "SYSTEM_ADMIN ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìë§Œ ì ‘ê·¼ í—ˆìš©",
                "hasAuthority('SYSTEM_ADMIN')",
                "universal", "system_generated", true)
        );

        return universalTemplates.stream()
            .map(this::convertToConditionTemplate)
            .collect(Collectors.toList());
    }

    /**
     * íŠ¹ì • ë©”ì„œë“œì— ëŒ€í•œ ì¡°ê±´ í…œí”Œë¦¿ë“¤ì„ ìƒì„±í•©ë‹ˆë‹¤.
     */
    private List<ConditionTemplate> generateMethodSpecificTemplates(MethodAnalysisResult analysis) {
        List<AutoGeneratedTemplate> templates = new ArrayList<>();

        switch (analysis.getDetectedPattern()) {
            case OBJECT_RETURN_PATTERN:
                templates.addAll(generateObjectReturnTemplates(analysis));
                break;
            case ID_PARAMETER_PATTERN:
                templates.addAll(generateIdParameterTemplates(analysis));
                break;
            case UNIVERSAL_PATTERN:
                // ë²”ìš© íŒ¨í„´ì€ ì´ë¯¸ ì²˜ë¦¬ë¨
                break;
            default:
                log.debug("ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒ¨í„´ìœ¼ë¡œ í…œí”Œë¦¿ ìƒì„± ìŠ¤í‚µ: {}", analysis.getDetectedPattern());
        }

        return templates.stream()
            .map(this::convertToConditionTemplate)
            .collect(Collectors.toList());
    }

    /**
     * ê°ì²´ ë°˜í™˜ íŒ¨í„´ í…œí”Œë¦¿ ìƒì„±
     */
    private List<AutoGeneratedTemplate> generateObjectReturnTemplates(MethodAnalysisResult analysis) {
        String entityType = (String) analysis.getMetadata().get("entityType");
        String methodId = analysis.getMethodIdentifier();

        // ğŸ”„ ê°œì„ : í•œêµ­ì–´ ì¹œí™”ì ì¸ ì¡°ê±´ëª… ìƒì„±
        String koreanEntityName = getKoreanEntityName(entityType);
        String methodName = extractMethodName(methodId);

        return Arrays.asList(
            new AutoGeneratedTemplate(
                String.format("%s ì¡°íšŒ í›„ ì ‘ê·¼ ê¶Œí•œ", koreanEntityName),
                String.format("ì¡°íšŒëœ %sì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤ [ë©”ì„œë“œ: %s]", koreanEntityName, methodName),
                "hasPermission(#returnObject, 'READ')",
                "object_return", methodId, false),

            new AutoGeneratedTemplate(
                String.format("%s ì¡°íšŒ í›„ ìˆ˜ì • ê¶Œí•œ", koreanEntityName),
                String.format("ì¡°íšŒëœ %sì— ëŒ€í•œ ìˆ˜ì • ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤ [ë©”ì„œë“œ: %s]", koreanEntityName, methodName),
                "hasPermission(#returnObject, 'UPDATE')",
                "object_return", methodId, false),

            new AutoGeneratedTemplate(
                String.format("%s ì¡°íšŒ í›„ ì‚­ì œ ê¶Œí•œ", koreanEntityName),
                String.format("ì¡°íšŒëœ %sì— ëŒ€í•œ ì‚­ì œ ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤ [ë©”ì„œë“œ: %s]", koreanEntityName, methodName),
                "hasPermission(#returnObject, 'DELETE')",
                "object_return", methodId, false),

            new AutoGeneratedTemplate(
                String.format("%s ì†Œìœ ì ì—¬ë¶€ í™•ì¸", koreanEntityName),
                String.format("ì¡°íšŒëœ %sì˜ ì†Œìœ ìì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤ [ë©”ì„œë“œ: %s]", koreanEntityName, methodName),
                "#returnObject.owner == #authentication.name",
                "ownership", methodId, false),

            new AutoGeneratedTemplate(
                String.format("%s ìƒì„±ì ì—¬ë¶€ í™•ì¸", koreanEntityName),
                String.format("ì¡°íšŒëœ %sì˜ ìƒì„±ìì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤ [ë©”ì„œë“œ: %s]", koreanEntityName, methodName),
                "#returnObject.createdBy == #authentication.name",
                "ownership", methodId, false)
        );
    }

    /**
     * ID íŒŒë¼ë¯¸í„° íŒ¨í„´ í…œí”Œë¦¿ ìƒì„±
     */
    private List<AutoGeneratedTemplate> generateIdParameterTemplates(MethodAnalysisResult analysis) {
        String entityType = (String) analysis.getMetadata().get("entityType");
        String idParamName = (String) analysis.getMetadata().get("idParameterName");
        String methodId = analysis.getMethodIdentifier();

        List<AutoGeneratedTemplate> templates = new ArrayList<>();

        // ğŸ”„ ê°œì„ : ì‹¤ì œ ê¶Œí•œëª…ê³¼ ì—°ê´€ì„±ì„ ë†’ì´ëŠ” ì¡°ê±´ëª… ìƒì„±
        String koreanEntityName = getKoreanEntityName(entityType);
        String methodName = extractMethodName(methodId);
        String actionType = extractActionFromMethod(methodName);

        templates.add(new AutoGeneratedTemplate(
            String.format("%s %s ê¶Œí•œ í™•ì¸", koreanEntityName, actionType),
            String.format("IDë¡œ %s %s ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤ [ë©”ì„œë“œ: %s]", koreanEntityName, actionType, methodName),
            String.format("hasPermission(#%s, '%s', 'UPDATE')", idParamName, entityType),
            "id_parameter", methodId, false));

        templates.add(new AutoGeneratedTemplate(
            String.format("%s ì‚­ì œ ê¶Œí•œ í™•ì¸", koreanEntityName),
            String.format("IDë¡œ %s ì‚­ì œ ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤ [ë©”ì„œë“œ: %s]", koreanEntityName, methodName),
            String.format("hasPermission(#%s, '%s', 'DELETE')", idParamName, entityType),
            "id_parameter", methodId, false));

        // User ì—”í‹°í‹°ì˜ ê²½ìš° ìê¸° ìì‹  ì²´í¬ ì¶”ê°€
        if ("User".equals(entityType)) {
            templates.add(new AutoGeneratedTemplate(
                String.format("ë³¸ì¸ %s í™•ì¸", actionType),
                String.format("ìš”ì²­í•œ ì‚¬ìš©ìê°€ ë³¸ì¸ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤ [ë©”ì„œë“œ: %s]", methodName),
                String.format("#%s == #authentication.id", idParamName),
                "self_check", methodId, false));
        }

        return templates;
    }

    /**
     * ğŸ”„ ê°œì„ : ì—”í‹°í‹° íƒ€ì…ì„ í•œêµ­ì–´ë¡œ ë³€í™˜
     */
    private String getKoreanEntityName(String entityType) {
        if (entityType == null) return "ë¦¬ì†ŒìŠ¤";
        
        Map<String, String> entityNames = Map.of(
            "User", "ì‚¬ìš©ì",
            "Document", "ë¬¸ì„œ", 
            "Group", "ê·¸ë£¹",
            "Role", "ì—­í• ",
            "Permission", "ê¶Œí•œ",
            "Policy", "ì •ì±…",
            "Resource", "ë¦¬ì†ŒìŠ¤",
            "File", "íŒŒì¼",
            "Project", "í”„ë¡œì íŠ¸",
            "Organization", "ì¡°ì§"
        );
        
        return entityNames.getOrDefault(entityType, entityType.toLowerCase());
    }

    /**
     * ğŸ”„ ê°œì„ : ë©”ì„œë“œëª…ì—ì„œ ì•¡ì…˜ íƒ€ì… ì¶”ì¶œ
     */
    private String extractActionFromMethod(String methodName) {
        if (methodName == null) return "ì²˜ë¦¬";
        
        String lowerMethod = methodName.toLowerCase();
        
        if (lowerMethod.contains("update") || lowerMethod.contains("modify") || lowerMethod.contains("edit")) {
            return "ìˆ˜ì •";
        } else if (lowerMethod.contains("delete") || lowerMethod.contains("remove")) {
            return "ì‚­ì œ";
        } else if (lowerMethod.contains("create") || lowerMethod.contains("add") || lowerMethod.contains("insert")) {
            return "ìƒì„±";
        } else if (lowerMethod.contains("read") || lowerMethod.contains("get") || lowerMethod.contains("find") || lowerMethod.contains("view")) {
            return "ì¡°íšŒ";
        } else if (lowerMethod.contains("approve")) {
            return "ìŠ¹ì¸";
        } else if (lowerMethod.contains("reject")) {
            return "ê±°ë¶€";
        } else if (lowerMethod.contains("assign")) {
            return "í• ë‹¹";
        } else if (lowerMethod.contains("revoke")) {
            return "ì·¨ì†Œ";
        }
        
        return "ì²˜ë¦¬";
    }

    /**
     * ğŸ”„ ê°œì„ : ë©”ì„œë“œ IDì—ì„œ ë©”ì„œë“œëª…ë§Œ ì¶”ì¶œ
     */
    private String extractMethodName(String methodId) {
        if (methodId == null) return "unknown";
        
        String[] parts = methodId.split("\\.");
        return parts.length > 0 ? parts[parts.length - 1] : methodId;
    }
    
    /**
     * ë©”ì„œë“œ IDì—ì„œ ê³ ìœ í•œ ì ‘ë¯¸ì‚¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
     */
    private String generateMethodSuffix(String methodId) {
        // ë©”ì„œë“œ IDì—ì„œ í´ë˜ìŠ¤ëª…ê³¼ ë©”ì„œë“œëª…ì„ ì¶”ì¶œí•˜ì—¬ ì§§ì€ ì ‘ë¯¸ì‚¬ ìƒì„±
        if (methodId == null) return "AUTO";
        
        String[] parts = methodId.split("\\.");
        if (parts.length >= 2) {
            String className = parts[parts.length - 2];
            String methodName = parts[parts.length - 1];
            
            // í´ë˜ìŠ¤ëª…ì˜ ì²« ê¸€ì + ë©”ì„œë“œëª…ì˜ ì²« 3ê¸€ì
            String classPrefix = className.length() > 0 ? className.substring(0, 1).toUpperCase() : "X";
            String methodPrefix = methodName.length() >= 3 ? methodName.substring(0, 3).toUpperCase() : methodName.toUpperCase();
            
            return classPrefix + methodPrefix;
        }
        
        // í•´ì‹œ ì½”ë“œë¥¼ ì‚¬ìš©í•œ ê³ ìœ  ì ‘ë¯¸ì‚¬
        return String.valueOf(Math.abs(methodId.hashCode()) % 10000);
    }

    /**
     * AutoGeneratedTemplateì„ ConditionTemplate ì—”í‹°í‹°ë¡œ ë³€í™˜
     * ğŸ”„ 2ë‹¨ê³„: ìë™ ë¶„ë¥˜ ì‹œìŠ¤í…œ ì ìš©
     */
    private ConditionTemplate convertToConditionTemplate(AutoGeneratedTemplate template) {
        ConditionTemplate entity = new ConditionTemplate();
        entity.setName(template.getName());
        entity.setDescription(template.getDescription());
        entity.setSpelTemplate(template.getSpelTemplate());
        entity.setIsAutoGenerated(true);
        entity.setTemplateType(template.getTemplateType());
        entity.setSourceMethod(template.getSourceMethod());
        entity.setIsUniversal(template.isUniversal());
        entity.setCreatedAt(LocalDateTime.now());
        entity.setUpdatedAt(LocalDateTime.now());
        
        // ğŸ”„ 2ë‹¨ê³„: ìë™ ìƒì„± í…œí”Œë¦¿ì˜ ë¶„ë¥˜ ê²°ì •
        if (template.isUniversal()) {
            // ë²”ìš© ì¡°ê±´
            entity.setClassification(ConditionTemplate.ConditionClassification.UNIVERSAL);
            entity.setRiskLevel(ConditionTemplate.RiskLevel.LOW);
            entity.setComplexityScore(1);
            entity.setApprovalRequired(false);
            entity.setContextDependent(false);
        } else {
            // í…œí”Œë¦¿ íƒ€ì…ì— ë”°ë¥¸ ë¶„ë¥˜
            switch (template.getTemplateType()) {
                case "object_return", "id_parameter", "ownership" -> {
                    entity.setClassification(ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT);
                    entity.setRiskLevel(ConditionTemplate.RiskLevel.MEDIUM);
                    entity.setComplexityScore(calculateAutoTemplateComplexity(template.getSpelTemplate()));
                    entity.setApprovalRequired(false); // AI ê²€ì¦ë§Œ í•„ìš”
                    entity.setContextDependent(true);
                }
                case "self_check" -> {
                    entity.setClassification(ConditionTemplate.ConditionClassification.UNIVERSAL);
                    entity.setRiskLevel(ConditionTemplate.RiskLevel.LOW);
                    entity.setComplexityScore(2);
                    entity.setApprovalRequired(false);
                    entity.setContextDependent(false);
                }
                default -> {
                    entity.setClassification(ConditionTemplate.ConditionClassification.CUSTOM_COMPLEX);
                    entity.setRiskLevel(ConditionTemplate.RiskLevel.HIGH);
                    entity.setComplexityScore(calculateAutoTemplateComplexity(template.getSpelTemplate()));
                    entity.setApprovalRequired(true);
                    entity.setContextDependent(true);
                }
            }
        }
        
        return entity;
    }
    
    /**
     * ìë™ ìƒì„± í…œí”Œë¦¿ì˜ ë³µì¡ë„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
     */
    private int calculateAutoTemplateComplexity(String spelTemplate) {
        if (spelTemplate == null) return 1;
        
        int score = 1;
        String spel = spelTemplate.toLowerCase();
        
        // hasPermission ì‚¬ìš© ì‹œ +2ì 
        if (spel.contains("haspermission")) score += 2;
        
        // ë³€ìˆ˜ ê°œìˆ˜ì— ë”°ë¥¸ ì ìˆ˜
        score += (spel.length() - spel.replace("#", "").length());
        
        // ë…¼ë¦¬ ì—°ì‚°ì
        if (spel.contains("&&") || spel.contains("||")) score += 1;
        
        return Math.min(score, 10);
    }

    /**
     * ğŸ”§ ê°œì„ : ì¤‘ë³µì„ ì œê±°í•˜ê³  DBì— ì €ì¥ (ê³ ìœ  ì´ë¦„ ë³´ì¥)
     * ì´ë¦„ê³¼ SpEL í…œí”Œë¦¿ ëª¨ë‘ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µ ì²´í¬í•˜ë©°, í•„ìš”ì‹œ ì´ë¦„ì— ì ‘ë¯¸ì‚¬ ì¶”ê°€
     */
    @Transactional
    private List<ConditionTemplate> saveDedupedTemplates(List<ConditionTemplate> templates) {
        // ì „ì²´ ê¸°ì¡´ í…œí”Œë¦¿ë“¤ ì¡°íšŒ (ìë™/ìˆ˜ë™ ìƒì„± ëª¨ë‘)
        List<ConditionTemplate> allExistingTemplates = conditionTemplateRepository.findAll();
        
        // ì¤‘ë³µ ì²´í¬ë¥¼ ìœ„í•œ Set ìƒì„± (ì´ë¦„ê³¼ SpEL í…œí”Œë¦¿ ëª¨ë‘)
        Set<String> existingNames = allExistingTemplates.stream()
            .map(ConditionTemplate::getName)
            .collect(Collectors.toSet());
            
        Set<String> existingSpelTemplates = allExistingTemplates.stream()
            .map(ConditionTemplate::getSpelTemplate)
            .collect(Collectors.toSet());

        // ì²˜ë¦¬ ì¤‘ì¸ í…œí”Œë¦¿ë“¤ì˜ ì´ë¦„ë„ ì¶”ì  (ë°°ì¹˜ ë‚´ì—ì„œ ì¤‘ë³µ ë°©ì§€)
        Set<String> processingNames = new HashSet<>();

        // ìƒˆ í…œí”Œë¦¿ë“¤ì„ í•„í„°ë§í•˜ê³  ì¤‘ë³µ ì‹œ ì´ë¦„ ìˆ˜ì •
        List<ConditionTemplate> newTemplates = templates.stream()
            .filter(template -> {
                // SpEL ì¤‘ë³µ ì²´í¬ (SpELì´ ì¤‘ë³µë˜ë©´ ì™„ì „íˆ ì œì™¸)
                if (existingSpelTemplates.contains(template.getSpelTemplate())) {
                    log.debug("âš ï¸ SpEL ì¤‘ë³µìœ¼ë¡œ ê±´ë„ˆëœ€: {} -> {}", template.getName(), template.getSpelTemplate());
                    return false;
                }
                
                // ì´ë¦„ ì¤‘ë³µ ì²´í¬ ë° í•´ê²°
                String originalName = template.getName();
                String uniqueName = makeUniqueName(originalName, existingNames, processingNames);
                
                if (!originalName.equals(uniqueName)) {
                    log.info("ğŸ”„ ì´ë¦„ ì¤‘ë³µ í•´ê²°: '{}' -> '{}'", originalName, uniqueName);
                    template.setName(uniqueName);
                }
                
                // ì²˜ë¦¬ ì¤‘ì¸ ì´ë¦„ì— ì¶”ê°€
                processingNames.add(uniqueName);
                existingNames.add(uniqueName); // ë‹¤ìŒ í…œí”Œë¦¿ ì²˜ë¦¬ ì‹œ ê³ ë ¤ë˜ë„ë¡
                
                return true;
            })
            .collect(Collectors.toList());

        log.info("ğŸ’¾ ìƒˆë¡œìš´ í…œí”Œë¦¿ ì €ì¥: {} ê°œ (ì „ì²´: {} ê°œ, SpEL ì¤‘ë³µ ì œì™¸: {} ê°œ)", 
            newTemplates.size(), templates.size(), templates.size() - newTemplates.size());

        return newTemplates.isEmpty() ? new ArrayList<>() : conditionTemplateRepository.saveAll(newTemplates);
    }

    /**
     * ğŸ”§ ê³ ìœ í•œ ì´ë¦„ ìƒì„± (ì¤‘ë³µ ì‹œ ì ‘ë¯¸ì‚¬ ì¶”ê°€)
     */
    private String makeUniqueName(String baseName, Set<String> existingNames, Set<String> processingNames) {
        if (!existingNames.contains(baseName) && !processingNames.contains(baseName)) {
            return baseName;
        }
        
        // ì¤‘ë³µ ì‹œ ì ‘ë¯¸ì‚¬ ì¶”ê°€ ì‹œë„
        for (int i = 2; i <= 100; i++) {
            String candidateName = baseName + " (" + i + ")";
            if (!existingNames.contains(candidateName) && !processingNames.contains(candidateName)) {
                return candidateName;
            }
        }
        
        // ìµœí›„ ìˆ˜ë‹¨: íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
        String timestampName = baseName + " (" + System.currentTimeMillis() % 10000 + ")";
        log.warn("âš ï¸ ê³ ìœ  ì´ë¦„ ìƒì„±ì„ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ì‚¬ìš©: {}", timestampName);
        return timestampName;
    }

    /**
     * ğŸš€ ê°œì„ : ManagedResource ê¸°ë°˜ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„±
     * ManagedResourceì˜ friendlyNameì„ ê¸°ë°˜ìœ¼ë¡œ ì¡°ê±´ëª…ì„ ìƒì„±í•˜ì—¬ ë§¤ì¹­ ë¬¸ì œ í•´ê²°
     */
    @Transactional
    public List<ConditionTemplate> generateManagedResourceBasedTemplates() {
        log.info("ğŸ¯ ManagedResource ê¸°ë°˜ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì‹œì‘");
        
        // ê´€ë¦¬ ëŒ€ìƒì¸ ëª¨ë“  ë¦¬ì†ŒìŠ¤ ì¡°íšŒ (EXCLUDED ìƒíƒœ ì œì™¸)
        List<ManagedResource> managedResources = managedResourceRepository.findByStatusInWithPermission(
            Arrays.asList(
                ManagedResource.Status.NEEDS_DEFINITION,
                ManagedResource.Status.PERMISSION_CREATED,
                ManagedResource.Status.POLICY_CONNECTED
            )
        );
        log.info("ğŸ“‹ ê´€ë¦¬ ëŒ€ìƒ ë¦¬ì†ŒìŠ¤ ìˆ˜: {} ê°œ", managedResources.size());
        
        List<ConditionTemplate> generatedTemplates = new ArrayList<>();
        
        for (ManagedResource resource : managedResources) {
            List<ConditionTemplate> resourceTemplates = generateTemplatesForManagedResource(resource);
            generatedTemplates.addAll(resourceTemplates);
        }
        
        // ì¤‘ë³µ ì œê±° ë° ì €ì¥
        List<ConditionTemplate> savedTemplates = saveDedupedTemplates(generatedTemplates);
        
        log.info("âœ… ManagedResource ê¸°ë°˜ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì™„ë£Œ: {} ê°œ ì €ì¥", savedTemplates.size());
        return savedTemplates;
    }

    /**
     * ğŸš€ ê°œì„ : Permission ê¸°ë°˜ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„±
     * ì‹¤ì œ ê¶Œí•œëª…(friendlyName)ì„ ê¸°ë°˜ìœ¼ë¡œ ì¡°ê±´ëª…ì„ ìƒì„±í•˜ì—¬ ë§¤ì¹­ ë¬¸ì œ í•´ê²°
     */
    @Transactional
    public List<ConditionTemplate> generatePermissionBasedTemplates() {
        log.info("ğŸ¯ Permission ê¸°ë°˜ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì‹œì‘");
        
        // ì •ì˜ëœ ëª¨ë“  ê¶Œí•œ ì¡°íšŒ
        List<Permission> allPermissions = permissionRepository.findDefinedPermissionsWithDetails();
        log.info("ğŸ“‹ ì •ì˜ëœ ê¶Œí•œ ìˆ˜: {} ê°œ", allPermissions.size());
        
        List<ConditionTemplate> generatedTemplates = new ArrayList<>();
        
        for (Permission permission : allPermissions) {
            List<ConditionTemplate> permissionTemplates = generateTemplatesForPermission(permission);
            generatedTemplates.addAll(permissionTemplates);
        }
        
        // ì¤‘ë³µ ì œê±° ë° ì €ì¥
        List<ConditionTemplate> savedTemplates = saveDedupedTemplates(generatedTemplates);
        
        log.info("âœ… Permission ê¸°ë°˜ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì™„ë£Œ: {} ê°œ ì €ì¥", savedTemplates.size());
        return savedTemplates;
    }

    /**
     * íŠ¹ì • ManagedResourceì— ëŒ€í•œ ì¡°ê±´ í…œí”Œë¦¿ë“¤ ìƒì„±
     */
    private List<ConditionTemplate> generateTemplatesForManagedResource(ManagedResource resource) {
        List<AutoGeneratedTemplate> templates = new ArrayList<>();
        
        String friendlyName = resource.getFriendlyName();
        String resourceIdentifier = resource.getResourceIdentifier();
        String resourceType = resource.getResourceType().name();
        
        // friendlyNameì´ ì—†ìœ¼ë©´ resourceIdentifierì—ì„œ ì¶”ì¶œ
        String displayName = (friendlyName != null && !friendlyName.trim().isEmpty()) 
            ? friendlyName : extractFriendlyNameFromIdentifier(resourceIdentifier);
        
        log.debug("ğŸ”„ ì¡°ê±´ ìƒì„± ì¤‘: {} ({})", displayName, resourceIdentifier);
        
        // ê¸°ë³¸ ì ‘ê·¼ ê¶Œí•œ í™•ì¸
        templates.add(new AutoGeneratedTemplate(
            String.format("%s ì ‘ê·¼ ê¶Œí•œ", displayName),
            String.format("'%s' ê¸°ëŠ¥ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤", displayName),
            String.format("hasAuthority('%s')", generatePermissionNameFromResource(resource)),
            "resource_access", resourceIdentifier, false));
        
        // ì—­í•  ê¸°ë°˜ ì ‘ê·¼ (íŠ¹ì • í‚¤ì›Œë“œê°€ í¬í•¨ëœ ê²½ìš°)
        if (containsAdminKeywords(displayName)) {
            templates.add(new AutoGeneratedTemplate(
                String.format("%s ê´€ë¦¬ì ê¶Œí•œ", displayName),
                String.format("'%s' ê¸°ëŠ¥ì— ëŒ€í•œ ê´€ë¦¬ì ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤", displayName),
                "hasRole('ADMIN')",
                "admin_access", resourceIdentifier, false));
        }
        
        if (containsManagerKeywords(displayName)) {
            templates.add(new AutoGeneratedTemplate(
                String.format("%s ë§¤ë‹ˆì € ê¶Œí•œ", displayName),
                String.format("'%s' ê¸°ëŠ¥ì— ëŒ€í•œ ë§¤ë‹ˆì € ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤", displayName),
                "hasRole('MANAGER')",
                "manager_access", resourceIdentifier, false));
        }
        
        // ë©”ì„œë“œ íƒ€ì…ì¸ ê²½ìš° ê°ì²´ ë ˆë²¨ ê¶Œí•œ ì²´í¬
        if (resource.getResourceType() == ManagedResource.ResourceType.METHOD) {
            String actionType = extractActionFromResourceName(displayName);
            if (actionType != null) {
                templates.add(new AutoGeneratedTemplate(
                    String.format("%s ê°ì²´ ê¶Œí•œ", displayName),
                    String.format("íŠ¹ì • ê°ì²´ì— ëŒ€í•œ %s ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤", actionType),
                    String.format("hasPermission(#targetObject, '%s')", actionType.toUpperCase()),
                    "object_level", resourceIdentifier, false));
            }
        }
        
        // ì¤‘ìš”í•œ ì‘ì—…ì— ëŒ€í•œ ì‹œê°„ ì œí•œ (ìƒì„±, ìˆ˜ì •, ì‚­ì œ)
        if (containsImportantActions(displayName)) {
            templates.add(new AutoGeneratedTemplate(
                String.format("%s + ì—…ë¬´ì‹œê°„ ì œí•œ", displayName),
                String.format("'%s' ì‘ì—…ì€ ì—…ë¬´ì‹œê°„ì—ë§Œ í—ˆìš©ë©ë‹ˆë‹¤", displayName),
                String.format("hasAuthority('%s') && T(java.time.LocalTime).now().hour >= 9 && T(java.time.LocalTime).now().hour <= 18", 
                    generatePermissionNameFromResource(resource)),
                "time_restricted", resourceIdentifier, false));
        }
        
        // IP ì œí•œì´ í•„ìš”í•œ ë¯¼ê°í•œ ì‘ì—…
        if (containsSensitiveKeywords(displayName)) {
            templates.add(new AutoGeneratedTemplate(
                String.format("%s + ë‚´ë¶€ë§ ì œí•œ", displayName),
                String.format("'%s' ì‘ì—…ì€ ë‚´ë¶€ë§ì—ì„œë§Œ í—ˆìš©ë©ë‹ˆë‹¤", displayName),
                String.format("hasAuthority('%s') && #request.remoteAddr matches '^192\\\\.168\\\\..*'", 
                    generatePermissionNameFromResource(resource)),
                "ip_restricted", resourceIdentifier, false));
        }
        
        return templates.stream()
            .map(this::convertToConditionTemplate)
            .collect(Collectors.toList());
    }

    /**
     * íŠ¹ì • Permissionì— ëŒ€í•œ ì¡°ê±´ í…œí”Œë¦¿ë“¤ ìƒì„±
     */
    private List<ConditionTemplate> generateTemplatesForPermission(Permission permission) {
        List<AutoGeneratedTemplate> templates = new ArrayList<>();
        
        String friendlyName = permission.getFriendlyName();
        String targetType = permission.getTargetType();
        String actionType = permission.getActionType();
        String permissionName = permission.getName();
        
        // friendlyNameì´ ì—†ìœ¼ë©´ name ì‚¬ìš©
        String displayName = (friendlyName != null && !friendlyName.trim().isEmpty()) 
            ? friendlyName : permissionName;
        
        log.debug("ğŸ”„ ì¡°ê±´ ìƒì„± ì¤‘: {} ({})", displayName, permissionName);
        
        // ê¸°ë³¸ ê¶Œí•œ í™•ì¸ ì¡°ê±´
        templates.add(new AutoGeneratedTemplate(
            String.format("%s ê¶Œí•œ í™•ì¸", displayName),
            String.format("'%s' ê¶Œí•œì„ ë³´ìœ í•˜ê³  ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤", displayName),
            String.format("hasAuthority('%s')", permissionName),
            "permission_check", permissionName, false));
        
        // ì—­í•  ê¸°ë°˜ ê¶Œí•œ í™•ì¸ (ê¶Œí•œëª…ì— ROLEì´ í¬í•¨ëœ ê²½ìš°)
        if (permissionName.toUpperCase().contains("ROLE") || 
            (displayName != null && displayName.contains("ì—­í• "))) {
            templates.add(new AutoGeneratedTemplate(
                String.format("%s ì—­í•  í™•ì¸", displayName),
                String.format("'%s' ì—­í• ì„ ë³´ìœ í•˜ê³  ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤", displayName),
                String.format("hasRole('%s')", permissionName.replace("ROLE_", "")),
                "role_check", permissionName, false));
        }
        
        // targetTypeê³¼ actionTypeì´ ìˆëŠ” ê²½ìš° ê°ì²´ ë ˆë²¨ ê¶Œí•œ í™•ì¸
        if (targetType != null && actionType != null) {
            templates.add(new AutoGeneratedTemplate(
                String.format("%s ê°ì²´ ê¶Œí•œ í™•ì¸", displayName),
                String.format("íŠ¹ì • %s ê°ì²´ì— ëŒ€í•œ %s ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤", 
                    getKoreanEntityName(targetType), getKoreanActionName(actionType)),
                String.format("hasPermission(#targetObject, '%s')", actionType),
                "object_permission", permissionName, false));
        }
        
        // ê´€ë¦¬ì ê¶Œí•œì´ í¬í•¨ëœ ê²½ìš°
        if (displayName != null && (displayName.contains("ê´€ë¦¬") || displayName.contains("admin"))) {
            templates.add(new AutoGeneratedTemplate(
                String.format("%s + ê´€ë¦¬ì í™•ì¸", displayName),
                String.format("'%s' ê¶Œí•œê³¼ ê´€ë¦¬ì ì—­í• ì„ ëª¨ë‘ í™•ì¸í•©ë‹ˆë‹¤", displayName),
                String.format("hasAuthority('%s') && hasRole('ADMIN')", permissionName),
                "admin_permission", permissionName, false));
        }
        
        // ì‹œê°„ ì œí•œì´ í•„ìš”í•  ìˆ˜ ìˆëŠ” ê¶Œí•œë“¤ (ìƒì„±, ìˆ˜ì •, ì‚­ì œ)
        if (actionType != null && (actionType.contains("CREATE") || actionType.contains("UPDATE") || actionType.contains("DELETE")) ||
            displayName != null && (displayName.contains("ìƒì„±") || displayName.contains("ìˆ˜ì •") || displayName.contains("ì‚­ì œ"))) {
            templates.add(new AutoGeneratedTemplate(
                String.format("%s + ì—…ë¬´ì‹œê°„ ì œí•œ", displayName),
                String.format("'%s' ê¶Œí•œê³¼ ì—…ë¬´ì‹œê°„ ì œí•œì„ í•¨ê»˜ í™•ì¸í•©ë‹ˆë‹¤", displayName),
                String.format("hasAuthority('%s') && T(java.time.LocalTime).now().hour >= 9 && T(java.time.LocalTime).now().hour <= 18", permissionName),
                "time_restricted_permission", permissionName, false));
        }
        
        return templates.stream()
            .map(this::convertToConditionTemplate)
            .collect(Collectors.toList());
    }

    /**
     * ì•¡ì…˜ íƒ€ì…ì„ í•œêµ­ì–´ë¡œ ë³€í™˜
     */
    private String getKoreanActionName(String actionType) {
        if (actionType == null) return "ì²˜ë¦¬";
        
        Map<String, String> actionNames = Map.of(
            "READ", "ì¡°íšŒ",
            "CREATE", "ìƒì„±", 
            "UPDATE", "ìˆ˜ì •",
            "DELETE", "ì‚­ì œ",
            "EXECUTE", "ì‹¤í–‰",
            "APPROVE", "ìŠ¹ì¸",
            "REJECT", "ê±°ë¶€"
        );
        
        return actionNames.getOrDefault(actionType.toUpperCase(), actionType.toLowerCase());
    }

    /**
     * ê¸°ì¡´ ìë™ ìƒì„± í…œí”Œë¦¿ë“¤ì„ ëª¨ë‘ ì œê±°í•˜ê³  ìƒˆë¡œ ìƒì„±
     */
    @Transactional
    public List<ConditionTemplate> regenerateAllTemplates(List<MethodAnalysisResult> analysisResults) {
        log.info("ğŸ”„ ê¸°ì¡´ ìë™ ìƒì„± í…œí”Œë¦¿ ì œê±° ë° ì¬ìƒì„± ì‹œì‘");

        // ê¸°ì¡´ ìë™ ìƒì„± í…œí”Œë¦¿ë“¤ ì‚­ì œ
        conditionTemplateRepository.deleteByIsAutoGenerated(true);

        // ìƒˆë¡œ ìƒì„±
        return generateTemplatesFromAnalysis(analysisResults);
    }

    /**
     * íŠ¹ì • ë©”ì„œë“œì— ëŒ€í•œ í…œí”Œë¦¿ë“¤ë§Œ ê°±ì‹ 
     */
    @Transactional
    public List<ConditionTemplate> updateTemplatesForMethod(MethodAnalysisResult analysis) {
        log.info("ğŸ”„ ë©”ì„œë“œë³„ í…œí”Œë¦¿ ê°±ì‹ : {}", analysis.getMethodIdentifier());

        // í•´ë‹¹ ë©”ì„œë“œì˜ ê¸°ì¡´ í…œí”Œë¦¿ë“¤ ì‚­ì œ
        conditionTemplateRepository.deleteBySourceMethod(analysis.getMethodIdentifier());

        // ìƒˆ í…œí”Œë¦¿ë“¤ ìƒì„±
        List<ConditionTemplate> methodTemplates = generateMethodSpecificTemplates(analysis);
        
        return conditionTemplateRepository.saveAll(methodTemplates);
    }

    /**
     * resourceIdentifierì—ì„œ ì¹œí™”ì ì¸ ì´ë¦„ì„ ì¶”ì¶œ
     */
    private String extractFriendlyNameFromIdentifier(String resourceIdentifier) {
        if (resourceIdentifier == null || resourceIdentifier.trim().isEmpty()) {
            return "ë¯¸ì •ì˜ ë¦¬ì†ŒìŠ¤";
        }
        
        // URL íŒ¨í„´ì¸ ê²½ìš°
        if (resourceIdentifier.startsWith("/")) {
            String[] segments = resourceIdentifier.split("/");
            String lastSegment = segments[segments.length - 1];
            return lastSegment.isEmpty() ? segments[segments.length - 2] : lastSegment;
        }
        
        // ë©”ì„œë“œ íŒ¨í„´ì¸ ê²½ìš° (io.spring.identityadmin.service.UserService.updateUser)
        if (resourceIdentifier.contains(".")) {
            String[] parts = resourceIdentifier.split("\\.");
            String methodPart = parts[parts.length - 1];
            
            // ë©”ì„œë“œëª…ì—ì„œ íŒŒë¼ë¯¸í„° ì œê±° (updateUser(Long) -> updateUser)
            if (methodPart.contains("(")) {
                methodPart = methodPart.substring(0, methodPart.indexOf("("));
            }
            
            return camelCaseToKorean(methodPart);
        }
        
        return resourceIdentifier;
    }
    
    /**
     * camelCaseë¥¼ í•œêµ­ì–´ ì¹œí™”ì ìœ¼ë¡œ ë³€í™˜
     */
    private String camelCaseToKorean(String camelCase) {
        if (camelCase == null || camelCase.isEmpty()) {
            return camelCase;
        }
        
        // ì¼ë°˜ì ì¸ ì•¡ì…˜ íŒ¨í„´ ë§¤í•‘
        Map<String, String> actionMappings = Map.of(
            "get", "ì¡°íšŒ",
            "find", "ê²€ìƒ‰",
            "create", "ìƒì„±",
            "add", "ì¶”ê°€",
            "update", "ìˆ˜ì •",
            "modify", "ë³€ê²½",
            "delete", "ì‚­ì œ",
            "remove", "ì œê±°",
            "save", "ì €ì¥",
            "load", "ë¡œë“œ"
        );
        
        // ì—”í‹°í‹° íŒ¨í„´ ë§¤í•‘
        Map<String, String> entityMappings = Map.of(
            "User", "ì‚¬ìš©ì",
            "Document", "ë¬¸ì„œ",
            "Group", "ê·¸ë£¹",
            "Role", "ì—­í• ",
            "Permission", "ê¶Œí•œ",
            "Policy", "ì •ì±…"
        );
        
        StringBuilder result = new StringBuilder();
        String[] words = camelCase.split("(?=[A-Z])");
        
        for (String word : words) {
            if (word.isEmpty()) continue;
            
            String lowerWord = word.toLowerCase();
            if (actionMappings.containsKey(lowerWord)) {
                result.append(actionMappings.get(lowerWord));
            } else if (entityMappings.containsKey(word)) {
                result.append(entityMappings.get(word));
            } else {
                result.append(word);
            }
            result.append(" ");
        }
        
        return result.toString().trim();
    }
    
    /**
     * ManagedResourceë¡œë¶€í„° ê¶Œí•œëª… ìƒì„±
     */
    private String generatePermissionNameFromResource(ManagedResource resource) {
        if (resource.getPermission() != null && resource.getPermission().getName() != null) {
            return resource.getPermission().getName();
        }
        
        // ê¶Œí•œì´ ì—†ëŠ” ê²½ìš° ë¦¬ì†ŒìŠ¤ ì‹ë³„ì ê¸°ë°˜ìœ¼ë¡œ ìƒì„±
        String resourceType = resource.getResourceType().name();
        String identifier = resource.getResourceIdentifier()
            .replaceAll("[^a-zA-Z0-9]", "_")
            .toUpperCase();
        
        return String.format("%s_%s", resourceType, identifier);
    }
    
    /**
     * ê´€ë¦¬ì í‚¤ì›Œë“œ í¬í•¨ ì—¬ë¶€ í™•ì¸
     */
    private boolean containsAdminKeywords(String text) {
        if (text == null) return false;
        String lowerText = text.toLowerCase();
        return lowerText.contains("ê´€ë¦¬") || lowerText.contains("admin") || 
               lowerText.contains("ì‹œìŠ¤í…œ") || lowerText.contains("ì„¤ì •");
    }
    
    /**
     * ë§¤ë‹ˆì € í‚¤ì›Œë“œ í¬í•¨ ì—¬ë¶€ í™•ì¸
     */
    private boolean containsManagerKeywords(String text) {
        if (text == null) return false;
        String lowerText = text.toLowerCase();
        return lowerText.contains("ë§¤ë‹ˆì €") || lowerText.contains("manager") ||
               lowerText.contains("íŒ€ì¥") || lowerText.contains("ìŠ¹ì¸");
    }
    
    /**
     * ë¦¬ì†ŒìŠ¤ëª…ì—ì„œ ì•¡ì…˜ íƒ€ì… ì¶”ì¶œ
     */
    private String extractActionFromResourceName(String resourceName) {
        if (resourceName == null) return null;
        
        String lowerName = resourceName.toLowerCase();
        
        if (lowerName.contains("ì¡°íšŒ") || lowerName.contains("get") || lowerName.contains("find")) {
            return "read";
        } else if (lowerName.contains("ìƒì„±") || lowerName.contains("create") || lowerName.contains("add")) {
            return "create";
        } else if (lowerName.contains("ìˆ˜ì •") || lowerName.contains("update") || lowerName.contains("modify")) {
            return "update";
        } else if (lowerName.contains("ì‚­ì œ") || lowerName.contains("delete") || lowerName.contains("remove")) {
            return "delete";
        } else if (lowerName.contains("ì‹¤í–‰") || lowerName.contains("execute")) {
            return "execute";
        }
        
        return null;
    }
    
    /**
     * ì¤‘ìš”í•œ ì‘ì—… í‚¤ì›Œë“œ í¬í•¨ ì—¬ë¶€ í™•ì¸ (ì‹œê°„ ì œí•œ í•„ìš”)
     */
    private boolean containsImportantActions(String text) {
        if (text == null) return false;
        String lowerText = text.toLowerCase();
        return lowerText.contains("ìƒì„±") || lowerText.contains("create") ||
               lowerText.contains("ìˆ˜ì •") || lowerText.contains("update") ||
               lowerText.contains("ì‚­ì œ") || lowerText.contains("delete") ||
               lowerText.contains("ìŠ¹ì¸") || lowerText.contains("approve");
    }
    
    /**
     * ë¯¼ê°í•œ ì‘ì—… í‚¤ì›Œë“œ í¬í•¨ ì—¬ë¶€ í™•ì¸ (IP ì œí•œ í•„ìš”)
     */
    private boolean containsSensitiveKeywords(String text) {
        if (text == null) return false;
        String lowerText = text.toLowerCase();
        return lowerText.contains("ì‹œìŠ¤í…œ") || lowerText.contains("system") ||
               lowerText.contains("ì„¤ì •") || lowerText.contains("config") ||
               lowerText.contains("ê¶Œí•œ") || lowerText.contains("permission") ||
               lowerText.contains("ì •ì±…") || lowerText.contains("policy");
    }

    /**
     * Repository ì ‘ê·¼ì„ ìœ„í•œ getter ë©”ì„œë“œ
     */
    public ConditionTemplateRepository getConditionTemplateRepository() {
        return conditionTemplateRepository;
    }
} 