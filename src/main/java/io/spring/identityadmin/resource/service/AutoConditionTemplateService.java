package io.spring.identityadmin.resource.service;

import io.spring.identityadmin.ai.AINativeIAMAdvisor;
import io.spring.identityadmin.domain.entity.ConditionTemplate;
import io.spring.identityadmin.domain.entity.ManagedResource;
import io.spring.identityadmin.domain.entity.Permission;
import io.spring.identityadmin.repository.ConditionTemplateRepository;
import io.spring.identityadmin.repository.ManagedResourceRepository;
import io.spring.identityadmin.repository.PermissionRepository;
import io.spring.identityadmin.resource.MethodPatternAnalyzer;
import io.spring.identityadmin.resource.MethodPatternAnalyzer.MethodAnalysisResult;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Slf4j
public class AutoConditionTemplateService {

    private final ConditionTemplateRepository conditionTemplateRepository;
    private final MethodPatternAnalyzer methodPatternAnalyzer;
    private final PermissionRepository permissionRepository;
    private final ManagedResourceRepository managedResourceRepository;
    private final AINativeIAMAdvisor aiAdvisor;
    private final ObjectMapper objectMapper;

    /**
     * ìë™ ìƒì„±ëœ ì¡°ê±´ í…œí”Œë¦¿ ì •ë³´ë¥¼ ë‹´ëŠ” DTO
     */
    public static class AutoGeneratedTemplate {
        private String name;
        private String description;
        private String spelTemplate;
        private String templateType;
        private String sourceMethod;
        private boolean isUniversal;
        private Map<String, Object> metadata;

        // ìƒì„±ì, getter, setter
        public AutoGeneratedTemplate(String name, String description, String spelTemplate, 
                                   String templateType, String sourceMethod, boolean isUniversal) {
            this.name = name;
            this.description = description;
            this.spelTemplate = spelTemplate;
            this.templateType = templateType;
            this.sourceMethod = sourceMethod;
            this.isUniversal = isUniversal;
            this.metadata = new HashMap<>();
        }

        // Getters and Setters
        public String getName() { return name; }
        public void setName(String name) { this.name = name; }
        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }
        public String getSpelTemplate() { return spelTemplate; }
        public void setSpelTemplate(String spelTemplate) { this.spelTemplate = spelTemplate; }
        public String getTemplateType() { return templateType; }
        public void setTemplateType(String templateType) { this.templateType = templateType; }
        public String getSourceMethod() { return sourceMethod; }
        public void setSourceMethod(String sourceMethod) { this.sourceMethod = sourceMethod; }
        public boolean isUniversal() { return isUniversal; }
        public void setUniversal(boolean universal) { isUniversal = universal; }
        public Map<String, Object> getMetadata() { return metadata; }
        public void setMetadata(Map<String, Object> metadata) { this.metadata = metadata; }
    }

    /**
     * ë©”ì„œë“œ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¡°ê±´ í…œí”Œë¦¿ì„ ìë™ ìƒì„±í•©ë‹ˆë‹¤.
     */
    @Transactional
    public List<ConditionTemplate> generateTemplatesFromAnalysis(List<MethodAnalysisResult> analysisResults) {
        log.info("ğŸ”„ ìë™ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì‹œì‘: {} ê°œ ë¶„ì„ ê²°ê³¼", analysisResults.size());

        List<ConditionTemplate> generatedTemplates = new ArrayList<>();

        // 1. ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± (í•œ ë²ˆë§Œ)
        List<ConditionTemplate> universalTemplates = generateUniversalTemplates();
        generatedTemplates.addAll(universalTemplates);

        // 2. ë©”ì„œë“œë³„ íŠ¹í™” í…œí”Œë¦¿ ìƒì„±
        for (MethodAnalysisResult analysis : analysisResults) {
            List<ConditionTemplate> methodTemplates = generateMethodSpecificTemplates(analysis);
            generatedTemplates.addAll(methodTemplates);
        }

        // 3. ì¤‘ë³µ ì œê±° ë° DB ì €ì¥
        List<ConditionTemplate> savedTemplates = saveDedupedTemplates(generatedTemplates);

        log.info("âœ… ìë™ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì™„ë£Œ: {} ê°œ í…œí”Œë¦¿ ì €ì¥", savedTemplates.size());
        return savedTemplates;
    }

    /**
     * ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ë“¤ì„ ìƒì„±í•©ë‹ˆë‹¤. (hasPermission ë°©ì‹)
     */
    private List<ConditionTemplate> generateUniversalTemplates() {
        List<AutoGeneratedTemplate> universalTemplates = Arrays.asList(
            // ì‹œê°„ ê¸°ë°˜ ì¡°ê±´ë“¤
            new AutoGeneratedTemplate(
                "ì—…ë¬´ì‹œê°„ ì ‘ê·¼",
                "í‰ì¼ ì˜¤ì „ 9ì‹œë¶€í„° ì˜¤í›„ 6ì‹œê¹Œì§€ë§Œ ì ‘ê·¼ í—ˆìš©",
                "T(java.time.LocalTime).now().hour >= 9 and T(java.time.LocalTime).now().hour <= 18",
                "universal", "system_generated", true),
            
            new AutoGeneratedTemplate(
                "í‰ì¼ ì ‘ê·¼",
                "ì›”ìš”ì¼ë¶€í„° ê¸ˆìš”ì¼ê¹Œì§€ë§Œ ì ‘ê·¼ í—ˆìš©",
                "T(java.time.LocalDate).now().dayOfWeek.value <= 5",
                "universal", "system_generated", true),

            // IP ê¸°ë°˜ ì¡°ê±´ë“¤
            new AutoGeneratedTemplate(
                "ë‚´ë¶€ë§ ì ‘ê·¼",
                "192.168.x.x ëŒ€ì—­ì—ì„œë§Œ ì ‘ê·¼ í—ˆìš©",
                "#request.remoteAddr matches '^192\\\\.168\\\\..*'",
                "universal", "system_generated", true),

            new AutoGeneratedTemplate(
                "ì‚¬ë‚´ë§ ì ‘ê·¼",
                "10.x.x.x ëŒ€ì—­ì—ì„œë§Œ ì ‘ê·¼ í—ˆìš©",
                "#request.remoteAddr matches '^10\\\\..*'",
                "universal", "system_generated", true),

            // ì¸ì¦ëœ ì‚¬ìš©ì ê¸°ë°˜ ì¡°ê±´ë“¤
            new AutoGeneratedTemplate(
                "ì¸ì¦ëœ ì‚¬ìš©ì",
                "ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ì ‘ê·¼ í—ˆìš©",
                "isAuthenticated()",
                "universal", "system_generated", true),

            new AutoGeneratedTemplate(
                "ì™„ì „ ì¸ì¦ëœ ì‚¬ìš©ì",
                "ì™„ì „íˆ ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ì ‘ê·¼ í—ˆìš© (Remember-me ì œì™¸)",
                "isFullyAuthenticated()",
                "universal", "system_generated", true)
        );

        return universalTemplates.stream()
            .map(this::convertToConditionTemplate)
            .collect(Collectors.toList());
    }

    /**
     * íŠ¹ì • ë©”ì„œë“œì— ëŒ€í•œ ì¡°ê±´ í…œí”Œë¦¿ë“¤ì„ ìƒì„±í•©ë‹ˆë‹¤.
     */
    private List<ConditionTemplate> generateMethodSpecificTemplates(MethodAnalysisResult analysis) {
        List<AutoGeneratedTemplate> templates = new ArrayList<>();

        switch (analysis.getDetectedPattern()) {
            case OBJECT_RETURN_PATTERN:
                templates.addAll(generateObjectReturnTemplates(analysis));
                break;
            case ID_PARAMETER_PATTERN:
                templates.addAll(generateIdParameterTemplates(analysis));
                break;
            case UNIVERSAL_PATTERN:
                // ë²”ìš© íŒ¨í„´ì€ ì´ë¯¸ ì²˜ë¦¬ë¨
                break;
            default:
                log.debug("ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒ¨í„´ìœ¼ë¡œ í…œí”Œë¦¿ ìƒì„± ìŠ¤í‚µ: {}", analysis.getDetectedPattern());
        }

        return templates.stream()
            .map(this::convertToConditionTemplate)
            .collect(Collectors.toList());
    }

    /**
     * ê°ì²´ ë°˜í™˜ íŒ¨í„´ í…œí”Œë¦¿ ìƒì„± (hasPermission ë°©ì‹)
     */
    private List<AutoGeneratedTemplate> generateObjectReturnTemplates(MethodAnalysisResult analysis) {
        String entityType = (String) analysis.getMetadata().get("entityType");
        String methodId = analysis.getMethodIdentifier();

        // ğŸ”„ ê°œì„ : í•œêµ­ì–´ ì¹œí™”ì ì¸ ì¡°ê±´ëª… ìƒì„±
        String koreanEntityName = getKoreanEntityName(entityType);
        String methodName = extractMethodName(methodId);

        return Arrays.asList(
            new AutoGeneratedTemplate(
                String.format("íŠ¹ì • %s ì½ê¸° ê¶Œí•œ", koreanEntityName),
                String.format("ì¡°íšŒëœ íŠ¹ì • %s ê°ì²´ì— ëŒ€í•œ ê°œë³„ ì½ê¸° ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤ [ë©”ì„œë“œ: %s]", koreanEntityName, methodName),
                "hasPermission(#returnObject, 'READ')",
                "object_return", methodId, false),

            new AutoGeneratedTemplate(
                String.format("íŠ¹ì • %s ìˆ˜ì • ê¶Œí•œ", koreanEntityName),
                String.format("ì¡°íšŒëœ íŠ¹ì • %s ê°ì²´ì— ëŒ€í•œ ê°œë³„ ìˆ˜ì • ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤ [ë©”ì„œë“œ: %s]", koreanEntityName, methodName),
                "hasPermission(#returnObject, 'UPDATE')",
                "object_return", methodId, false),

            new AutoGeneratedTemplate(
                String.format("íŠ¹ì • %s ì‚­ì œ ê¶Œí•œ", koreanEntityName),
                String.format("ì¡°íšŒëœ íŠ¹ì • %s ê°ì²´ì— ëŒ€í•œ ê°œë³„ ì‚­ì œ ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤ [ë©”ì„œë“œ: %s]", koreanEntityName, methodName),
                "hasPermission(#returnObject, 'DELETE')",
                "object_return", methodId, false)
        );
    }

    /**
     * ID íŒŒë¼ë¯¸í„° íŒ¨í„´ í…œí”Œë¦¿ ìƒì„± (hasPermission ë°©ì‹)
     */
    private List<AutoGeneratedTemplate> generateIdParameterTemplates(MethodAnalysisResult analysis) {
        String entityType = (String) analysis.getMetadata().get("entityType");
        String idParamName = (String) analysis.getMetadata().get("idParameterName");
        String methodId = analysis.getMethodIdentifier();

        // ğŸ”„ ê°œì„ : í•œêµ­ì–´ ì¹œí™”ì ì¸ ì¡°ê±´ëª… ìƒì„±
        String koreanEntityName = getKoreanEntityName(entityType);
        String actionName = extractActionFromMethod(methodId);

        return Arrays.asList(
            new AutoGeneratedTemplate(
                String.format("ê°œë³„ %s %s ê¶Œí•œ", koreanEntityName, actionName),
                String.format("íŠ¹ì • IDì˜ %s ê°ì²´ì— ëŒ€í•œ ê°œë³„ %s ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤", koreanEntityName, actionName),
                String.format("hasPermission(#%s, '%s', 'UPDATE')", idParamName, entityType.toUpperCase()),
                "id_parameter", methodId, false),

            new AutoGeneratedTemplate(
                String.format("ê°œë³„ %s ì‚­ì œ ê¶Œí•œ", koreanEntityName),
                String.format("íŠ¹ì • IDì˜ %s ê°ì²´ì— ëŒ€í•œ ê°œë³„ ì‚­ì œ ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤", koreanEntityName),
                String.format("hasPermission(#%s, '%s', 'DELETE')", idParamName, entityType.toUpperCase()),
                "id_parameter", methodId, false)
        );
    }

    /**
     * ğŸ”„ ê°œì„ : ì—”í‹°í‹° íƒ€ì…ì„ í•œêµ­ì–´ë¡œ ë³€í™˜
     */
    private String getKoreanEntityName(String entityType) {
        if (entityType == null) return "ë¦¬ì†ŒìŠ¤";
        
        Map<String, String> entityNames = Map.of(
            "User", "ì‚¬ìš©ì",
            "Document", "ë¬¸ì„œ", 
            "Group", "ê·¸ë£¹",
            "Role", "ì—­í• ",
            "Permission", "ê¶Œí•œ",
            "Policy", "ì •ì±…",
            "Resource", "ë¦¬ì†ŒìŠ¤",
            "File", "íŒŒì¼",
            "Project", "í”„ë¡œì íŠ¸",
            "Organization", "ì¡°ì§"
        );
        
        return entityNames.getOrDefault(entityType, entityType.toLowerCase());
    }

    /**
     * ğŸ”„ ê°œì„ : ë©”ì„œë“œëª…ì—ì„œ ì•¡ì…˜ íƒ€ì… ì¶”ì¶œ
     */
    private String extractActionFromMethod(String methodName) {
        if (methodName == null) return "ì²˜ë¦¬";
        
        String lowerMethod = methodName.toLowerCase();
        
        if (lowerMethod.contains("update") || lowerMethod.contains("modify") || lowerMethod.contains("edit")) {
            return "ìˆ˜ì •";
        } else if (lowerMethod.contains("delete") || lowerMethod.contains("remove")) {
            return "ì‚­ì œ";
        } else if (lowerMethod.contains("create") || lowerMethod.contains("add") || lowerMethod.contains("insert")) {
            return "ìƒì„±";
        } else if (lowerMethod.contains("read") || lowerMethod.contains("get") || lowerMethod.contains("find") || lowerMethod.contains("view")) {
            return "ì¡°íšŒ";
        } else if (lowerMethod.contains("approve")) {
            return "ìŠ¹ì¸";
        } else if (lowerMethod.contains("reject")) {
            return "ê±°ë¶€";
        } else if (lowerMethod.contains("assign")) {
            return "í• ë‹¹";
        } else if (lowerMethod.contains("revoke")) {
            return "ì·¨ì†Œ";
        }
        
        return "ì²˜ë¦¬";
    }

    /**
     * ğŸ”„ ê°œì„ : ë©”ì„œë“œ IDì—ì„œ ë©”ì„œë“œëª…ë§Œ ì¶”ì¶œ
     */
    private String extractMethodName(String methodId) {
        if (methodId == null) return "unknown";
        
        String[] parts = methodId.split("\\.");
        return parts.length > 0 ? parts[parts.length - 1] : methodId;
    }
    
    /**
     * ë©”ì„œë“œ IDì—ì„œ ê³ ìœ í•œ ì ‘ë¯¸ì‚¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
     */
    private String generateMethodSuffix(String methodId) {
        // ë©”ì„œë“œ IDì—ì„œ í´ë˜ìŠ¤ëª…ê³¼ ë©”ì„œë“œëª…ì„ ì¶”ì¶œí•˜ì—¬ ì§§ì€ ì ‘ë¯¸ì‚¬ ìƒì„±
        if (methodId == null) return "AUTO";
        
        String[] parts = methodId.split("\\.");
        if (parts.length >= 2) {
            String className = parts[parts.length - 2];
            String methodName = parts[parts.length - 1];
            
            // í´ë˜ìŠ¤ëª…ì˜ ì²« ê¸€ì + ë©”ì„œë“œëª…ì˜ ì²« 3ê¸€ì
            String classPrefix = className.length() > 0 ? className.substring(0, 1).toUpperCase() : "X";
            String methodPrefix = methodName.length() >= 3 ? methodName.substring(0, 3).toUpperCase() : methodName.toUpperCase();
            
            return classPrefix + methodPrefix;
        }
        
        // í•´ì‹œ ì½”ë“œë¥¼ ì‚¬ìš©í•œ ê³ ìœ  ì ‘ë¯¸ì‚¬
        return String.valueOf(Math.abs(methodId.hashCode()) % 10000);
    }

    /**
     * AutoGeneratedTemplateì„ ConditionTemplate ì—”í‹°í‹°ë¡œ ë³€í™˜
     * ğŸ”„ 2ë‹¨ê³„: ìë™ ë¶„ë¥˜ ì‹œìŠ¤í…œ ì ìš©
     */
    private ConditionTemplate convertToConditionTemplate(AutoGeneratedTemplate template) {
        ConditionTemplate entity = new ConditionTemplate();
        entity.setName(template.getName());
        entity.setDescription(template.getDescription());
        entity.setSpelTemplate(template.getSpelTemplate());
        entity.setIsAutoGenerated(true);
        entity.setTemplateType(template.getTemplateType());
        entity.setSourceMethod(template.getSourceMethod());
        entity.setIsUniversal(template.isUniversal());
        entity.setCreatedAt(LocalDateTime.now());
        entity.setUpdatedAt(LocalDateTime.now());
        
        // ğŸ”„ 2ë‹¨ê³„: ìë™ ìƒì„± í…œí”Œë¦¿ì˜ ë¶„ë¥˜ ê²°ì •
        if (template.isUniversal()) {
            // ë²”ìš© ì¡°ê±´
            entity.setClassification(ConditionTemplate.ConditionClassification.UNIVERSAL);
            entity.setRiskLevel(ConditionTemplate.RiskLevel.LOW);
            entity.setComplexityScore(1);
            entity.setApprovalRequired(false);
            entity.setContextDependent(false);
        } else {
            // í…œí”Œë¦¿ íƒ€ì…ì— ë”°ë¥¸ ë¶„ë¥˜
            switch (template.getTemplateType()) {
                case "object_return", "id_parameter", "ownership" -> {
                    entity.setClassification(ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT);
                    entity.setRiskLevel(ConditionTemplate.RiskLevel.MEDIUM);
                    entity.setComplexityScore(calculateAutoTemplateComplexity(template.getSpelTemplate()));
                    entity.setApprovalRequired(false); // AI ê²€ì¦ë§Œ í•„ìš”
                    entity.setContextDependent(true);
                }
                case "self_check" -> {
                    entity.setClassification(ConditionTemplate.ConditionClassification.UNIVERSAL);
                    entity.setRiskLevel(ConditionTemplate.RiskLevel.LOW);
                    entity.setComplexityScore(2);
                    entity.setApprovalRequired(false);
                    entity.setContextDependent(false);
                }
                default -> {
                    entity.setClassification(ConditionTemplate.ConditionClassification.CUSTOM_COMPLEX);
                    entity.setRiskLevel(ConditionTemplate.RiskLevel.HIGH);
                    entity.setComplexityScore(calculateAutoTemplateComplexity(template.getSpelTemplate()));
                    entity.setApprovalRequired(true);
                    entity.setContextDependent(true);
                }
            }
        }
        
        return entity;
    }
    
    /**
     * ìë™ ìƒì„± í…œí”Œë¦¿ì˜ ë³µì¡ë„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
     */
    private int calculateAutoTemplateComplexity(String spelTemplate) {
        if (spelTemplate == null) return 1;
        
        int score = 1;
        String spel = spelTemplate.toLowerCase();
        
        // hasPermission ì‚¬ìš© ì‹œ +2ì 
        if (spel.contains("haspermission")) score += 2;
        
        // ë³€ìˆ˜ ê°œìˆ˜ì— ë”°ë¥¸ ì ìˆ˜
        score += (spel.length() - spel.replace("#", "").length());
        
        // ë…¼ë¦¬ ì—°ì‚°ì
        if (spel.contains("&&") || spel.contains("||")) score += 1;
        
        return Math.min(score, 10);
    }

    /**
     * ğŸ”§ ê°œì„ : ì¤‘ë³µì„ ì œê±°í•˜ê³  DBì— ì €ì¥ (ê³ ìœ  ì´ë¦„ ë³´ì¥)
     * ì´ë¦„ê³¼ SpEL í…œí”Œë¦¿ ëª¨ë‘ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µ ì²´í¬í•˜ë©°, í•„ìš”ì‹œ ì´ë¦„ì— ì ‘ë¯¸ì‚¬ ì¶”ê°€
     */
    @Transactional
    public List<ConditionTemplate> saveDedupedTemplates(List<ConditionTemplate> templates) {
        // ì „ì²´ ê¸°ì¡´ í…œí”Œë¦¿ë“¤ ì¡°íšŒ (ìë™/ìˆ˜ë™ ìƒì„± ëª¨ë‘)
        List<ConditionTemplate> allExistingTemplates = conditionTemplateRepository.findAll();
        
        // ì¤‘ë³µ ì²´í¬ë¥¼ ìœ„í•œ Set ìƒì„± (ì´ë¦„ê³¼ SpEL í…œí”Œë¦¿ ëª¨ë‘)
        Set<String> existingNames = allExistingTemplates.stream()
            .map(ConditionTemplate::getName)
            .collect(Collectors.toSet());
            
        Set<String> existingSpelTemplates = allExistingTemplates.stream()
            .map(ConditionTemplate::getSpelTemplate)
            .collect(Collectors.toSet());

        // ì²˜ë¦¬ ì¤‘ì¸ í…œí”Œë¦¿ë“¤ì˜ ì´ë¦„ë„ ì¶”ì  (ë°°ì¹˜ ë‚´ì—ì„œ ì¤‘ë³µ ë°©ì§€)
        Set<String> processingNames = new HashSet<>();

        // ìƒˆ í…œí”Œë¦¿ë“¤ì„ í•„í„°ë§í•˜ê³  ì¤‘ë³µ ì‹œ ì´ë¦„ ìˆ˜ì •
        List<ConditionTemplate> newTemplates = templates.stream()
            .filter(template -> {
                // SpEL ì¤‘ë³µ ì²´í¬ (SpELì´ ì¤‘ë³µë˜ë©´ ì™„ì „íˆ ì œì™¸)
                if (existingSpelTemplates.contains(template.getSpelTemplate())) {
                    log.debug("âš ï¸ SpEL ì¤‘ë³µìœ¼ë¡œ ê±´ë„ˆëœ€: {} -> {}", template.getName(), template.getSpelTemplate());
                    return false;
                }
                
                // ì´ë¦„ ì¤‘ë³µ ì²´í¬ ë° í•´ê²°
                String originalName = template.getName();
                String uniqueName = makeUniqueName(originalName, existingNames, processingNames);
                
                if (!originalName.equals(uniqueName)) {
                    log.info("ğŸ”„ ì´ë¦„ ì¤‘ë³µ í•´ê²°: '{}' -> '{}'", originalName, uniqueName);
                    template.setName(uniqueName);
                }
                
                // ì²˜ë¦¬ ì¤‘ì¸ ì´ë¦„ì— ì¶”ê°€
                processingNames.add(uniqueName);
                existingNames.add(uniqueName); // ë‹¤ìŒ í…œí”Œë¦¿ ì²˜ë¦¬ ì‹œ ê³ ë ¤ë˜ë„ë¡
                
                return true;
            })
            .collect(Collectors.toList());

        log.info("ğŸ’¾ ìƒˆë¡œìš´ í…œí”Œë¦¿ ì €ì¥: {} ê°œ (ì „ì²´: {} ê°œ, SpEL ì¤‘ë³µ ì œì™¸: {} ê°œ)", 
            newTemplates.size(), templates.size(), templates.size() - newTemplates.size());

        return newTemplates.isEmpty() ? new ArrayList<>() : conditionTemplateRepository.saveAll(newTemplates);
    }

    /**
     * ğŸ”§ ê³ ìœ í•œ ì´ë¦„ ìƒì„± (ì¤‘ë³µ ì‹œ ì ‘ë¯¸ì‚¬ ì¶”ê°€)
     */
    private String makeUniqueName(String baseName, Set<String> existingNames, Set<String> processingNames) {
        if (!existingNames.contains(baseName) && !processingNames.contains(baseName)) {
            return baseName;
        }
        
        // ì¤‘ë³µ ì‹œ ì ‘ë¯¸ì‚¬ ì¶”ê°€ ì‹œë„
        for (int i = 2; i <= 100; i++) {
            String candidateName = baseName + " (" + i + ")";
            if (!existingNames.contains(candidateName) && !processingNames.contains(candidateName)) {
                return candidateName;
            }
        }
        
        // ìµœí›„ ìˆ˜ë‹¨: íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
        String timestampName = baseName + " (" + System.currentTimeMillis() % 10000 + ")";
        log.warn("âš ï¸ ê³ ìœ  ì´ë¦„ ìƒì„±ì„ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ì‚¬ìš©: {}", timestampName);
        return timestampName;
    }

    /**
     * ğŸ”§ í†µí•©: ë¦¬ì†ŒìŠ¤ì™€ ê¶Œí•œì„ ëª¨ë‘ ê³ ë ¤í•œ í†µí•© ì¡°ê±´ í…œí”Œë¦¿ ìƒì„±
     */
    @Transactional
    public List<ConditionTemplate> generateConditionTemplates() {
        log.info("ğŸ¯ AI ê¸°ë°˜ METHOD ë¦¬ì†ŒìŠ¤ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì‹œì‘");
        
        // ABACëŠ” ì„œë¹„ìŠ¤ ë ˆì´ì–´ì—ì„œë§Œ ì²´í¬ - METHOD íƒ€ì… ë¦¬ì†ŒìŠ¤ë§Œ ëŒ€ìƒ
        List<ManagedResource> methodResources = managedResourceRepository.findAll()
            .stream()
            .filter(resource -> resource.getResourceType() == ManagedResource.ResourceType.METHOD)
            .filter(resource -> resource.getStatus() != ManagedResource.Status.EXCLUDED)
            .collect(Collectors.toList());
        
        if (methodResources.isEmpty()) {
            log.warn("âš ï¸ METHOD íƒ€ì… ë¦¬ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì¡°ê±´ í…œí”Œë¦¿ì„ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return new ArrayList<>();
        }
        
        log.info("ğŸ“‹ AI ë¶„ì„ ëŒ€ìƒ METHOD ë¦¬ì†ŒìŠ¤: {} ê°œ", methodResources.size());
        
        List<ConditionTemplate> templates = new ArrayList<>();
        
        // 1. ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ (AIë¡œ ìƒì„±)
        templates.addAll(generateAIUniversalTemplates());
        
        // 2. METHOD ë¦¬ì†ŒìŠ¤ë³„ AI íŠ¹í™” ì¡°ê±´ í…œí”Œë¦¿  
        for (ManagedResource resource : methodResources) {
            try {
                templates.addAll(generateAISpecificTemplates(resource));
            } catch (Exception e) {
                log.warn("âš ï¸ AI ë©”ì„œë“œ ë¶„ì„ ì‹¤íŒ¨: {} - {}", resource.getResourceIdentifier(), e.getMessage());
            }
        }
        
        // ì¤‘ë³µ ì œê±° ë° ì €ì¥
        List<ConditionTemplate> savedTemplates = saveDedupedTemplates(templates);
        
        log.info("ğŸ‰ AI ê¸°ë°˜ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì™„ë£Œ: {} ê°œ", savedTemplates.size());
        return savedTemplates;
    }

    /**
     * AIë¥¼ í†µí•œ ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ ìƒì„±
     */
    private List<ConditionTemplate> generateAIUniversalTemplates() {
        log.info("ğŸ¤– AI ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì‹œì‘");

        // ê°œì„ ëœ í”„ë¡¬í”„íŠ¸ ì—†ì´ ë°”ë¡œ AINativeIAMAdvisor í˜¸ì¶œ
        String userPrompt = "ì„œë¹„ìŠ¤ ë ˆì´ì–´ì—ì„œ ì •ë§ í•„ìš”í•œ í•µì‹¬ ë²”ìš© ì¡°ê±´ 4-5ê°œë§Œ ìƒì„±í•´ì£¼ì„¸ìš”.";

        try {
            String aiResponse = callAI("", userPrompt);
            return parseAITemplateResponse(aiResponse, "ë²”ìš©");
        } catch (Exception e) {
            log.error("ğŸ”¥ AI ë²”ìš© í…œí”Œë¦¿ ìƒì„± ì‹¤íŒ¨", e);
            return generateFallbackUniversalTemplates();
        }
    }

    /**
     * AIë¥¼ í†µí•œ íŠ¹ì • ë©”ì„œë“œë³„ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„±
     */
    private List<ConditionTemplate> generateAISpecificTemplates(ManagedResource resource) {
        log.debug("ğŸ¤– AI íŠ¹í™” ì¡°ê±´ ìƒì„±: {}", resource.getResourceIdentifier());

        String methodInfo = String.format("""
            ë©”ì„œë“œ ì •ë³´:
            - ì‹ë³„ì: %s
            - ì¹œí™”ì  ì´ë¦„: %s
            - ì„¤ëª…: %s
            - íŒŒë¼ë¯¸í„° íƒ€ì…: %s
            - ë°˜í™˜ íƒ€ì…: %s
            - ì„œë¹„ìŠ¤ ì†Œìœ ì: %s
            
            ì´ ë©”ì„œë“œì— ëŒ€í•´ ì •í™•íˆ í•˜ë‚˜ì˜ hasPermission() ì¡°ê±´ë§Œ ìƒì„±í•˜ì„¸ìš”.
            ë©”ì„œë“œ ì´ë¦„ê³¼ íŒŒë¼ë¯¸í„°ë¥¼ ì •í™•íˆ ë¶„ì„í•˜ì—¬ í•œêµ­ì–´ ì´ë¦„ìœ¼ë¡œ ë§Œë“œì„¸ìš”.
            """,
            resource.getResourceIdentifier(),
            resource.getFriendlyName() != null ? resource.getFriendlyName() : "ì—†ìŒ",
            resource.getDescription() != null ? resource.getDescription() : "ì—†ìŒ",
            resource.getParameterTypes() != null ? resource.getParameterTypes() : "ì—†ìŒ",
            resource.getReturnType() != null ? resource.getReturnType() : "void",
            resource.getServiceOwner() != null ? resource.getServiceOwner() : "ì•Œ ìˆ˜ ì—†ìŒ");

        try {
            String aiResponse = callAI("", methodInfo);
            return parseAITemplateResponse(aiResponse, resource.getResourceIdentifier());
        } catch (Exception e) {
            log.warn("ğŸ”¥ AI íŠ¹í™” í…œí”Œë¦¿ ìƒì„± ì‹¤íŒ¨: {}", resource.getResourceIdentifier(), e);
            return new ArrayList<>();
        }
    }

    /**
     * AI í˜¸ì¶œ í—¬í¼ ë©”ì„œë“œ - AINativeIAMAdvisorë¥¼ í†µí•œ ì‹¤ì œ AI í˜¸ì¶œ
     */
    private String callAI(String systemPrompt, String userPrompt) {
        try {
            log.info("ğŸ¤– AINativeIAMAdvisorë¥¼ í†µí•œ AI í˜¸ì¶œ ì‹œì‘");

            // ë²”ìš© ì¡°ê±´ì¸ì§€ íŠ¹í™” ì¡°ê±´ì¸ì§€ êµ¬ë¶„í•˜ì—¬ ì ì ˆí•œ ë©”ì„œë“œ í˜¸ì¶œ
            if (userPrompt.contains("ë²”ìš©") || userPrompt.contains("ì—…ë¬´ í™˜ê²½ì—ì„œ ìì£¼ ì‚¬ìš©ë˜ëŠ”")) {
                log.info("ğŸŒ ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ìš”ì²­");
                log.info("ğŸ“ ë²”ìš© ì¡°ê±´ ì…ë ¥: {}", userPrompt);
                String response = aiAdvisor.generateUniversalConditionTemplates();
                log.info("ğŸ¤– AI ë²”ìš© ì‘ë‹µ: {}", response);
                return response;
            } else {
                log.info("ğŸ¯ íŠ¹í™” ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ìš”ì²­");
                log.info("ğŸ“ íŠ¹í™” ì¡°ê±´ ì…ë ¥: {}", userPrompt);
                String response = aiAdvisor.generateSpecificConditionTemplates("METHOD", userPrompt);
                log.info("ğŸ¤– AI íŠ¹í™” ì‘ë‹µ: {}", response);
                return response;
            }

        } catch (Exception e) {
            log.error("ğŸ”¥ AINativeIAMAdvisor í˜¸ì¶œ ì‹¤íŒ¨", e);
            // í´ë°± ì œê±° - AI ì‹¤íŒ¨ ì‹œ ë¹ˆ ì‘ë‹µ ë°˜í™˜
            return "[]";
        }
    }

    // í´ë°± ë©”ì„œë“œ ì œê±°ë¨ - AI ì‘ë‹µë§Œ ë¶„ì„

    /**
     * AI ì‘ë‹µì„ ConditionTemplate ê°ì²´ë¡œ íŒŒì‹±
     */
    private List<ConditionTemplate> parseAITemplateResponse(String aiResponse, String sourceMethod) {
        List<ConditionTemplate> templates = new ArrayList<>();

        log.info("ğŸ” AI ì‘ë‹µ íŒŒì‹± ì‹œì‘ - ì†ŒìŠ¤: {}", sourceMethod);
        log.info("ğŸ“„ ì›ë³¸ AI ì‘ë‹µ: {}", aiResponse);

        try {
            // JSON ì •ì œ - ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±° ë° ë¶ˆí•„ìš”í•œ í…ìŠ¤íŠ¸ ì œê±°
            String cleanedJson = extractAndCleanJson(aiResponse);
            log.info("ğŸ” ì •ì œëœ JSON: {}", cleanedJson);

            // JSON ë°°ì—´ íŒŒì‹± ì‹œë„
            List<Map<String, Object>> rawTemplates = objectMapper.readValue(
                cleanedJson, new TypeReference<List<Map<String, Object>>>() {});

            log.info("ğŸ“Š íŒŒì‹±ëœ í…œí”Œë¦¿ ê°œìˆ˜: {} ê°œ", rawTemplates.size());

            for (int i = 0; i < rawTemplates.size(); i++) {
                Map<String, Object> raw = rawTemplates.get(i);
                log.info("ğŸ¯ í…œí”Œë¦¿ {} íŒŒì‹±: {}", i+1, raw);

                try {
                    ConditionTemplate template = ConditionTemplate.builder()
                        .name((String) raw.get("name"))
                        .description((String) raw.get("description"))
                        .spelTemplate((String) raw.get("spelTemplate"))
                        .category((String) raw.getOrDefault("category", "AI ìƒì„±"))
                        .classification(parseClassification((String) raw.get("classification")))
                        .sourceMethod(sourceMethod)
                        .isAutoGenerated(true)
                        .templateType("ai_generated")
                        .createdAt(LocalDateTime.now())
                        .build();

                    // SpEL í…œí”Œë¦¿ì´ ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°ë§Œ ì¶”ê°€
                    if (template.getSpelTemplate() != null && !template.getSpelTemplate().trim().isEmpty()) {
                        templates.add(template);
                        log.info("âœ… í…œí”Œë¦¿ ì¶”ê°€ë¨: {} - {}", template.getName(), template.getSpelTemplate());
                    } else {
                        log.warn("âš ï¸ ë¹ˆ SpEL í…œí”Œë¦¿ìœ¼ë¡œ ì¸í•´ ì œì™¸ë¨: {}", raw);
                    }
                } catch (Exception itemError) {
                    log.error("ğŸ”¥ í…œí”Œë¦¿ í•­ëª© íŒŒì‹± ì‹¤íŒ¨: {}", raw, itemError);
                }
            }

            log.info("âœ… AI ì‘ë‹µ íŒŒì‹± ì™„ë£Œ: {} ê°œ í…œí”Œë¦¿ ìµœì¢… ìƒì„±", templates.size());

        } catch (Exception e) {
            log.error("ğŸ”¥ AI ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: {}", aiResponse, e);
            // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
        }

        return templates;
    }

    /**
     * AI ì‘ë‹µì—ì„œ JSON ë¶€ë¶„ë§Œ ì¶”ì¶œí•˜ê³  ì •ì œ
     */
    private String extractAndCleanJson(String aiResponse) {
        if (aiResponse == null || aiResponse.trim().isEmpty()) {
            return "[]";
        }

        // ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±°
        String cleaned = aiResponse.replaceAll("```json\\s*", "").replaceAll("```\\s*", "");

        // JSON ë°°ì—´ ì‹œì‘ê³¼ ë ì°¾ê¸°
        int startIdx = cleaned.indexOf('[');
        int endIdx = cleaned.lastIndexOf(']');

        if (startIdx != -1 && endIdx != -1 && startIdx < endIdx) {
            return cleaned.substring(startIdx, endIdx + 1).trim();
        }

        // JSON ê°ì²´ í˜•íƒœì¸ ê²½ìš° ë°°ì—´ë¡œ ê°ì‹¸ê¸°
        startIdx = cleaned.indexOf('{');
        endIdx = cleaned.lastIndexOf('}');

        if (startIdx != -1 && endIdx != -1 && startIdx < endIdx) {
            String jsonObject = cleaned.substring(startIdx, endIdx + 1).trim();
            return "[" + jsonObject + "]";
        }

        // íŒŒì‹±í•  ìˆ˜ ìˆëŠ” JSONì´ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜
        log.warn("ğŸ”¥ AI ì‘ë‹µì—ì„œ ìœ íš¨í•œ JSONì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: {}", aiResponse.substring(0, Math.min(100, aiResponse.length())));
        return "[]";
    }

    private ConditionTemplate.ConditionClassification parseClassification(String classification) {
        if (classification == null) return ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT;

        try {
            return ConditionTemplate.ConditionClassification.valueOf(classification.toUpperCase());
        } catch (Exception e) {
            return ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT;
        }
    }

    /**
     * AI ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ë²”ìš© í…œí”Œë¦¿ë“¤
     */
    private List<ConditionTemplate> generateFallbackUniversalTemplates() {
        log.info("ğŸ”„ AI ì‹¤íŒ¨ë¡œ ì¸í•œ ê¸°ë³¸ ë²”ìš© í…œí”Œë¦¿ ìƒì„±");

        List<ConditionTemplate> templates = new ArrayList<>();

        // hasPermission ê¸°ë°˜ ê¶Œí•œ ì²´í¬
        templates.add(ConditionTemplate.builder()
            .name("ê°ì²´ ì½ê¸° ê¶Œí•œ")
            .description("ë©”ì„œë“œê°€ ë°˜í™˜í•˜ëŠ” ê°ì²´ì— ëŒ€í•œ ì½ê¸° ê¶Œí•œ í™•ì¸")
            .category("ê¶Œí•œ ê¸°ë°˜")
            .classification(ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT)
            .spelTemplate("hasPermission(#returnObject, 'READ')")
            .sourceMethod("ê¸°ë³¸")
            .isAutoGenerated(true)
            .templateType("fallback")
            .createdAt(LocalDateTime.now())
            .build());

        // Spring Security ê¸°ë³¸ í‘œí˜„ì‹
        templates.add(ConditionTemplate.builder()
            .name("ì¸ì¦ í™•ì¸")
            .description("ì‚¬ìš©ìê°€ ì¸ì¦ë˜ì—ˆëŠ”ì§€ í™•ì¸")
            .category("ì¸ì¦ ê¸°ë°˜")
            .classification(ConditionTemplate.ConditionClassification.UNIVERSAL)
            .spelTemplate("isAuthenticated()")
            .sourceMethod("ê¸°ë³¸")
            .isAutoGenerated(true)
            .templateType("fallback")
            .createdAt(LocalDateTime.now())
            .build());

        return templates;
    }

    private String generateFallbackUniversalResponse() {
        return """
        [
          {
            "name": "ì¸ì¦ëœ ì‚¬ìš©ì í™•ì¸",
            "description": "ì‚¬ìš©ìê°€ ì •ìƒì ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸",
            "spelTemplate": "isAuthenticated()",
            "category": "ì¸ì¦ ê¸°ë°˜",
            "classification": "UNIVERSAL"
          },
          {
            "name": "ì™„ì „ ì¸ì¦ í™•ì¸", 
            "description": "Remember-meê°€ ì•„ë‹Œ ì™„ì „í•œ ì¸ì¦ í™•ì¸",
            "spelTemplate": "isFullyAuthenticated()",
            "category": "ì¸ì¦ ê¸°ë°˜",
            "classification": "UNIVERSAL"
          },
          {
            "name": "ì—…ë¬´ì‹œê°„ ì ‘ê·¼",
            "description": "ì˜¤ì „ 9ì‹œë¶€í„° ì˜¤í›„ 6ì‹œ ì‚¬ì´ì—ë§Œ ì ‘ê·¼ í—ˆìš©",
            "spelTemplate": "T(java.time.LocalTime).now().hour >= 9 and T(java.time.LocalTime).now().hour < 18",
            "category": "ì‹œê°„ ê¸°ë°˜",
            "classification": "UNIVERSAL"
          },
          {
            "name": "ë°˜í™˜ ê°ì²´ ì½ê¸° ê¶Œí•œ",
            "description": "ë©”ì„œë“œê°€ ë°˜í™˜í•˜ëŠ” ê°ì²´ì— ëŒ€í•œ ì½ê¸° ê¶Œí•œ",
            "spelTemplate": "hasPermission(#returnObject, 'READ')",
            "category": "ê¶Œí•œ ê¸°ë°˜", 
            "classification": "CONTEXT_DEPENDENT"
          }
        ]
        """;
    }

    private String generateFallbackSpecificResponse(String methodInfo) {
        // ë©”ì„œë“œ ì •ë³´ì—ì„œ ê°„ë‹¨í•œ íŒ¨í„´ ì¶”ì¶œ
        if (methodInfo.contains("getDocument") || methodInfo.contains("Document")) {
            return """
            [
              {
                "name": "ë¬¸ì„œ ì¡°íšŒ ê¶Œí•œ",
                "description": "íŠ¹ì • ë¬¸ì„œ IDì— ëŒ€í•œ ì¡°íšŒ ê¶Œí•œ í™•ì¸",
                "spelTemplate": "hasPermission(#id, 'DOCUMENT', 'READ')",
                "category": "ê¶Œí•œ ê¸°ë°˜",
                "classification": "CONTEXT_DEPENDENT"
              }
            ]
            """;
        }

        return """
        [
          {
            "name": "ê¸°ë³¸ ì‹¤í–‰ ê¶Œí•œ",
            "description": "ë©”ì„œë“œ ì‹¤í–‰ì— ëŒ€í•œ ê¸°ë³¸ ê¶Œí•œ",
            "spelTemplate": "hasPermission(#id, 'RESOURCE', 'EXECUTE')",
            "category": "ê¶Œí•œ ê¸°ë°˜", 
            "classification": "CONTEXT_DEPENDENT"
          }
        ]
        """;
    }
}