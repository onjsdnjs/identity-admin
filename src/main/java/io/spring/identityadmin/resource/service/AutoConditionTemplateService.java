package io.spring.identityadmin.resource.service;

import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import io.spring.identityadmin.aiam.AINativeIAMAdvisor;
import io.spring.identityadmin.domain.entity.ConditionTemplate;
import io.spring.identityadmin.domain.entity.ManagedResource;
import io.spring.identityadmin.repository.ConditionTemplateRepository;
import io.spring.identityadmin.repository.ManagedResourceRepository;
import io.spring.identityadmin.repository.PermissionRepository;
import io.spring.identityadmin.resource.MethodPatternAnalyzer;
import io.spring.identityadmin.resource.MethodPatternAnalyzer.MethodAnalysisResult;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Slf4j
public class AutoConditionTemplateService {

    private final ConditionTemplateRepository conditionTemplateRepository;
    private final MethodPatternAnalyzer methodPatternAnalyzer;
    private final PermissionRepository permissionRepository;
    private final ManagedResourceRepository managedResourceRepository;
    private final AINativeIAMAdvisor aiAdvisor;
    private final ObjectMapper objectMapper;

    /**
     * ìë™ ìƒì„±ëœ ì¡°ê±´ í…œí”Œë¦¿ ì •ë³´ë¥¼ ë‹´ëŠ” DTO
     */
    public static class AutoGeneratedTemplate {
        private String name;
        private String description;
        private String spelTemplate;
        private String templateType;
        private String sourceMethod;
        private boolean isUniversal;
        private Map<String, Object> metadata;

        // ìƒì„±ì, getter, setter
        public AutoGeneratedTemplate(String name, String description, String spelTemplate,
                                     String templateType, String sourceMethod, boolean isUniversal) {
            this.name = name;
            this.description = description;
            this.spelTemplate = spelTemplate;
            this.templateType = templateType;
            this.sourceMethod = sourceMethod;
            this.isUniversal = isUniversal;
            this.metadata = new HashMap<>();
        }

        // Getters and Setters
        public String getName() { return name; }
        public void setName(String name) { this.name = name; }
        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }
        public String getSpelTemplate() { return spelTemplate; }
        public void setSpelTemplate(String spelTemplate) { this.spelTemplate = spelTemplate; }
        public String getTemplateType() { return templateType; }
        public void setTemplateType(String templateType) { this.templateType = templateType; }
        public String getSourceMethod() { return sourceMethod; }
        public void setSourceMethod(String sourceMethod) { this.sourceMethod = sourceMethod; }
        public boolean isUniversal() { return isUniversal; }
        public void setUniversal(boolean universal) { isUniversal = universal; }
        public Map<String, Object> getMetadata() { return metadata; }
        public void setMetadata(Map<String, Object> metadata) { this.metadata = metadata; }
    }

    /**
     * ë©”ì„œë“œ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¡°ê±´ í…œí”Œë¦¿ì„ ìë™ ìƒì„±í•©ë‹ˆë‹¤.
     */
    @Transactional
    public List<ConditionTemplate> generateTemplatesFromAnalysis(List<MethodAnalysisResult> analysisResults) {
        log.info("ğŸ”„ ìë™ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì‹œì‘: {} ê°œ ë¶„ì„ ê²°ê³¼", analysisResults.size());

        List<ConditionTemplate> generatedTemplates = new ArrayList<>();

        // 1. ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± (í•œ ë²ˆë§Œ)
        List<ConditionTemplate> universalTemplates = generateUniversalTemplates();
        generatedTemplates.addAll(universalTemplates);

        // 2. ë©”ì„œë“œë³„ íŠ¹í™” í…œí”Œë¦¿ ìƒì„±
        for (MethodAnalysisResult analysis : analysisResults) {
            List<ConditionTemplate> methodTemplates = generateMethodSpecificTemplates(analysis);
            generatedTemplates.addAll(methodTemplates);
        }

        // 3. ì¤‘ë³µ ì œê±° ë° DB ì €ì¥
        List<ConditionTemplate> savedTemplates = saveDedupedTemplates(generatedTemplates);

        log.info("âœ… ìë™ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì™„ë£Œ: {} ê°œ í…œí”Œë¦¿ ì €ì¥", savedTemplates.size());
        return savedTemplates;
    }

    /**
     * ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ë“¤ì„ ìƒì„±í•©ë‹ˆë‹¤. (hasPermission ë°©ì‹)
     */
    private List<ConditionTemplate> generateUniversalTemplates() {
        List<AutoGeneratedTemplate> universalTemplates = Arrays.asList(
                // ì‹œê°„ ê¸°ë°˜ ì¡°ê±´ë“¤
                new AutoGeneratedTemplate(
                        "ì—…ë¬´ì‹œê°„ ì ‘ê·¼",
                        "í‰ì¼ ì˜¤ì „ 9ì‹œë¶€í„° ì˜¤í›„ 6ì‹œê¹Œì§€ë§Œ ì ‘ê·¼ í—ˆìš©",
                        "T(java.time.LocalTime).now().hour >= 9 and T(java.time.LocalTime).now().hour <= 18",
                        "universal", "system_generated", true),

                new AutoGeneratedTemplate(
                        "í‰ì¼ ì ‘ê·¼",
                        "ì›”ìš”ì¼ë¶€í„° ê¸ˆìš”ì¼ê¹Œì§€ë§Œ ì ‘ê·¼ í—ˆìš©",
                        "T(java.time.LocalDate).now().dayOfWeek.value <= 5",
                        "universal", "system_generated", true),

                // IP ê¸°ë°˜ ì¡°ê±´ë“¤
                new AutoGeneratedTemplate(
                        "ë‚´ë¶€ë§ ì ‘ê·¼",
                        "192.168.x.x ëŒ€ì—­ì—ì„œë§Œ ì ‘ê·¼ í—ˆìš©",
                        "#request.remoteAddr matches '^192\\\\.168\\\\..*'",
                        "universal", "system_generated", true),

                new AutoGeneratedTemplate(
                        "ì‚¬ë‚´ë§ ì ‘ê·¼",
                        "10.x.x.x ëŒ€ì—­ì—ì„œë§Œ ì ‘ê·¼ í—ˆìš©",
                        "#request.remoteAddr matches '^10\\\\..*'",
                        "universal", "system_generated", true),

                // ì¸ì¦ëœ ì‚¬ìš©ì ê¸°ë°˜ ì¡°ê±´ë“¤
                new AutoGeneratedTemplate(
                        "ì¸ì¦ëœ ì‚¬ìš©ì",
                        "ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ì ‘ê·¼ í—ˆìš©",
                        "isAuthenticated()",
                        "universal", "system_generated", true),

                new AutoGeneratedTemplate(
                        "ì™„ì „ ì¸ì¦ëœ ì‚¬ìš©ì",
                        "ì™„ì „íˆ ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ì ‘ê·¼ í—ˆìš© (Remember-me ì œì™¸)",
                        "isFullyAuthenticated()",
                        "universal", "system_generated", true)
        );

        return universalTemplates.stream()
                .map(this::convertToConditionTemplate)
                .collect(Collectors.toList());
    }

    /**
     * íŠ¹ì • ë©”ì„œë“œì— ëŒ€í•œ ì¡°ê±´ í…œí”Œë¦¿ë“¤ì„ ìƒì„±í•©ë‹ˆë‹¤.
     */
    private List<ConditionTemplate> generateMethodSpecificTemplates(MethodAnalysisResult analysis) {
        List<AutoGeneratedTemplate> templates = new ArrayList<>();

        switch (analysis.getDetectedPattern()) {
            case OBJECT_RETURN_PATTERN:
                templates.addAll(generateObjectReturnTemplates(analysis));
                break;
            case ID_PARAMETER_PATTERN:
                templates.addAll(generateIdParameterTemplates(analysis));
                break;
            case UNIVERSAL_PATTERN:
                // ë²”ìš© íŒ¨í„´ì€ ì´ë¯¸ ì²˜ë¦¬ë¨
                break;
            default:
                log.debug("ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒ¨í„´ìœ¼ë¡œ í…œí”Œë¦¿ ìƒì„± ìŠ¤í‚µ: {}", analysis.getDetectedPattern());
        }

        return templates.stream()
                .map(this::convertToConditionTemplate)
                .collect(Collectors.toList());
    }

    /**
     * ê°ì²´ ë°˜í™˜ íŒ¨í„´ í…œí”Œë¦¿ ìƒì„± (hasPermission ë°©ì‹)
     */
    private List<AutoGeneratedTemplate> generateObjectReturnTemplates(MethodAnalysisResult analysis) {
        String entityType = (String) analysis.getMetadata().get("entityType");
        String methodId = analysis.getMethodIdentifier();

        // ğŸ”„ ê°œì„ : í•œêµ­ì–´ ì¹œí™”ì ì¸ ì¡°ê±´ëª… ìƒì„±
        String koreanEntityName = getKoreanEntityName(entityType);
        String methodName = extractMethodName(methodId);

        return Arrays.asList(
                new AutoGeneratedTemplate(
                        String.format("íŠ¹ì • %s ì½ê¸° ê¶Œí•œ", koreanEntityName),
                        String.format("ì¡°íšŒëœ íŠ¹ì • %s ê°ì²´ì— ëŒ€í•œ ê°œë³„ ì½ê¸° ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤ [ë©”ì„œë“œ: %s]", koreanEntityName, methodName),
                        "hasPermission(#returnObject, 'READ')",
                        "object_return", methodId, false),

                new AutoGeneratedTemplate(
                        String.format("íŠ¹ì • %s ìˆ˜ì • ê¶Œí•œ", koreanEntityName),
                        String.format("ì¡°íšŒëœ íŠ¹ì • %s ê°ì²´ì— ëŒ€í•œ ê°œë³„ ìˆ˜ì • ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤ [ë©”ì„œë“œ: %s]", koreanEntityName, methodName),
                        "hasPermission(#returnObject, 'UPDATE')",
                        "object_return", methodId, false),

                new AutoGeneratedTemplate(
                        String.format("íŠ¹ì • %s ì‚­ì œ ê¶Œí•œ", koreanEntityName),
                        String.format("ì¡°íšŒëœ íŠ¹ì • %s ê°ì²´ì— ëŒ€í•œ ê°œë³„ ì‚­ì œ ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤ [ë©”ì„œë“œ: %s]", koreanEntityName, methodName),
                        "hasPermission(#returnObject, 'DELETE')",
                        "object_return", methodId, false)
        );
    }

    /**
     * ID íŒŒë¼ë¯¸í„° íŒ¨í„´ í…œí”Œë¦¿ ìƒì„± (hasPermission ë°©ì‹)
     */
    private List<AutoGeneratedTemplate> generateIdParameterTemplates(MethodAnalysisResult analysis) {
        String entityType = (String) analysis.getMetadata().get("entityType");
        String idParamName = (String) analysis.getMetadata().get("idParameterName");
        String methodId = analysis.getMethodIdentifier();

        // ğŸ”„ ê°œì„ : í•œêµ­ì–´ ì¹œí™”ì ì¸ ì¡°ê±´ëª… ìƒì„±
        String koreanEntityName = getKoreanEntityName(entityType);
        String actionName = extractActionFromMethod(methodId);

        return Arrays.asList(
                new AutoGeneratedTemplate(
                        String.format("ê°œë³„ %s %s ê¶Œí•œ", koreanEntityName, actionName),
                        String.format("íŠ¹ì • IDì˜ %s ê°ì²´ì— ëŒ€í•œ ê°œë³„ %s ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤", koreanEntityName, actionName),
                        String.format("hasPermission(#%s, '%s', 'UPDATE')", idParamName, entityType.toUpperCase()),
                        "id_parameter", methodId, false),

                new AutoGeneratedTemplate(
                        String.format("ê°œë³„ %s ì‚­ì œ ê¶Œí•œ", koreanEntityName),
                        String.format("íŠ¹ì • IDì˜ %s ê°ì²´ì— ëŒ€í•œ ê°œë³„ ì‚­ì œ ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤", koreanEntityName),
                        String.format("hasPermission(#%s, '%s', 'DELETE')", idParamName, entityType.toUpperCase()),
                        "id_parameter", methodId, false)
        );
    }

    /**
     * ğŸ”„ ê°œì„ : ì—”í‹°í‹° íƒ€ì…ì„ í•œêµ­ì–´ë¡œ ë³€í™˜
     */
    private String getKoreanEntityName(String entityType) {
        if (entityType == null) return "ë¦¬ì†ŒìŠ¤";

        Map<String, String> entityNames = Map.of(
                "User", "ì‚¬ìš©ì",
                "Document", "ë¬¸ì„œ",
                "Group", "ê·¸ë£¹",
                "Role", "ì—­í• ",
                "Permission", "ê¶Œí•œ",
                "Policy", "ì •ì±…",
                "Resource", "ë¦¬ì†ŒìŠ¤",
                "File", "íŒŒì¼",
                "Project", "í”„ë¡œì íŠ¸",
                "Organization", "ì¡°ì§"
        );

        return entityNames.getOrDefault(entityType, entityType.toLowerCase());
    }

    /**
     * ğŸ”„ ê°œì„ : ë©”ì„œë“œëª…ì—ì„œ ì•¡ì…˜ íƒ€ì… ì¶”ì¶œ
     */
    private String extractActionFromMethod(String methodName) {
        if (methodName == null) return "ì²˜ë¦¬";

        String lowerMethod = methodName.toLowerCase();

        if (lowerMethod.contains("update") || lowerMethod.contains("modify") || lowerMethod.contains("edit")) {
            return "ìˆ˜ì •";
        } else if (lowerMethod.contains("delete") || lowerMethod.contains("remove")) {
            return "ì‚­ì œ";
        } else if (lowerMethod.contains("create") || lowerMethod.contains("add") || lowerMethod.contains("insert")) {
            return "ìƒì„±";
        } else if (lowerMethod.contains("read") || lowerMethod.contains("get") || lowerMethod.contains("find") || lowerMethod.contains("view")) {
            return "ì¡°íšŒ";
        } else if (lowerMethod.contains("approve")) {
            return "ìŠ¹ì¸";
        } else if (lowerMethod.contains("reject")) {
            return "ê±°ë¶€";
        } else if (lowerMethod.contains("assign")) {
            return "í• ë‹¹";
        } else if (lowerMethod.contains("revoke")) {
            return "ì·¨ì†Œ";
        }

        return "ì²˜ë¦¬";
    }

    /**
     * ğŸ”„ ê°œì„ : ë©”ì„œë“œ IDì—ì„œ ë©”ì„œë“œëª…ë§Œ ì¶”ì¶œ
     */
    private String extractMethodName(String methodId) {
        if (methodId == null) return "unknown";

        String[] parts = methodId.split("\\.");
        return parts.length > 0 ? parts[parts.length - 1] : methodId;
    }

    /**
     * ë©”ì„œë“œ IDì—ì„œ ê³ ìœ í•œ ì ‘ë¯¸ì‚¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
     */
    private String generateMethodSuffix(String methodId) {
        // ë©”ì„œë“œ IDì—ì„œ í´ë˜ìŠ¤ëª…ê³¼ ë©”ì„œë“œëª…ì„ ì¶”ì¶œí•˜ì—¬ ì§§ì€ ì ‘ë¯¸ì‚¬ ìƒì„±
        if (methodId == null) return "AUTO";

        String[] parts = methodId.split("\\.");
        if (parts.length >= 2) {
            String className = parts[parts.length - 2];
            String methodName = parts[parts.length - 1];

            // í´ë˜ìŠ¤ëª…ì˜ ì²« ê¸€ì + ë©”ì„œë“œëª…ì˜ ì²« 3ê¸€ì
            String classPrefix = className.length() > 0 ? className.substring(0, 1).toUpperCase() : "X";
            String methodPrefix = methodName.length() >= 3 ? methodName.substring(0, 3).toUpperCase() : methodName.toUpperCase();

            return classPrefix + methodPrefix;
        }

        // í•´ì‹œ ì½”ë“œë¥¼ ì‚¬ìš©í•œ ê³ ìœ  ì ‘ë¯¸ì‚¬
        return String.valueOf(Math.abs(methodId.hashCode()) % 10000);
    }

    /**
     * AutoGeneratedTemplateì„ ConditionTemplate ì—”í‹°í‹°ë¡œ ë³€í™˜
     * ğŸ”„ 2ë‹¨ê³„: ìë™ ë¶„ë¥˜ ì‹œìŠ¤í…œ ì ìš©
     */
    private ConditionTemplate convertToConditionTemplate(AutoGeneratedTemplate template) {
        ConditionTemplate entity = new ConditionTemplate();
        entity.setName(template.getName());
        entity.setDescription(template.getDescription());
        entity.setSpelTemplate(template.getSpelTemplate());
        entity.setIsAutoGenerated(true);
        entity.setTemplateType(template.getTemplateType());
        entity.setSourceMethod(template.getSourceMethod());
        entity.setIsUniversal(template.isUniversal());
        entity.setCreatedAt(LocalDateTime.now());
        entity.setUpdatedAt(LocalDateTime.now());

        // ğŸ”„ 2ë‹¨ê³„: ìë™ ìƒì„± í…œí”Œë¦¿ì˜ ë¶„ë¥˜ ê²°ì •
        if (template.isUniversal()) {
            // ë²”ìš© ì¡°ê±´
            entity.setClassification(ConditionTemplate.ConditionClassification.UNIVERSAL);
            entity.setRiskLevel(ConditionTemplate.RiskLevel.LOW);
            entity.setComplexityScore(1);
            entity.setApprovalRequired(false);
            entity.setContextDependent(false);
        } else {
            // í…œí”Œë¦¿ íƒ€ì…ì— ë”°ë¥¸ ë¶„ë¥˜
            switch (template.getTemplateType()) {
                case "object_return", "id_parameter", "ownership" -> {
                    entity.setClassification(ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT);
                    entity.setRiskLevel(ConditionTemplate.RiskLevel.MEDIUM);
                    entity.setComplexityScore(calculateAutoTemplateComplexity(template.getSpelTemplate()));
                    entity.setApprovalRequired(false); // AI ê²€ì¦ë§Œ í•„ìš”
                    entity.setContextDependent(true);
                }
                case "self_check" -> {
                    entity.setClassification(ConditionTemplate.ConditionClassification.UNIVERSAL);
                    entity.setRiskLevel(ConditionTemplate.RiskLevel.LOW);
                    entity.setComplexityScore(2);
                    entity.setApprovalRequired(false);
                    entity.setContextDependent(false);
                }
                default -> {
                    entity.setClassification(ConditionTemplate.ConditionClassification.CUSTOM_COMPLEX);
                    entity.setRiskLevel(ConditionTemplate.RiskLevel.HIGH);
                    entity.setComplexityScore(calculateAutoTemplateComplexity(template.getSpelTemplate()));
                    entity.setApprovalRequired(true);
                    entity.setContextDependent(true);
                }
            }
        }

        return entity;
    }

    /**
     * ìë™ ìƒì„± í…œí”Œë¦¿ì˜ ë³µì¡ë„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
     */
    private int calculateAutoTemplateComplexity(String spelTemplate) {
        if (spelTemplate == null) return 1;

        int score = 1;
        String spel = spelTemplate.toLowerCase();

        // hasPermission ì‚¬ìš© ì‹œ +2ì 
        if (spel.contains("haspermission")) score += 2;

        // ë³€ìˆ˜ ê°œìˆ˜ì— ë”°ë¥¸ ì ìˆ˜
        score += (spel.length() - spel.replace("#", "").length());

        // ë…¼ë¦¬ ì—°ì‚°ì
        if (spel.contains("&&") || spel.contains("||")) score += 1;

        return Math.min(score, 10);
    }

    /**
     * ğŸ”§ ê°œì„ : ì¤‘ë³µì„ ì œê±°í•˜ê³  DBì— ì €ì¥ (ê³ ìœ  ì´ë¦„ ë³´ì¥)
     * ì´ë¦„ê³¼ SpEL í…œí”Œë¦¿ ëª¨ë‘ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µ ì²´í¬í•˜ë©°, í•„ìš”ì‹œ ì´ë¦„ì— ì ‘ë¯¸ì‚¬ ì¶”ê°€
     */
    @Transactional
    public List<ConditionTemplate> saveDedupedTemplates(List<ConditionTemplate> templates) {
        // ì „ì²´ ê¸°ì¡´ í…œí”Œë¦¿ë“¤ ì¡°íšŒ (ìë™/ìˆ˜ë™ ìƒì„± ëª¨ë‘)
        List<ConditionTemplate> allExistingTemplates = conditionTemplateRepository.findAll();

        // ì¤‘ë³µ ì²´í¬ë¥¼ ìœ„í•œ Set ìƒì„± (ì´ë¦„ê³¼ SpEL í…œí”Œë¦¿ ëª¨ë‘)
        Set<String> existingNames = allExistingTemplates.stream()
                .map(ConditionTemplate::getName)
                .collect(Collectors.toSet());

        Set<String> existingSpelTemplates = allExistingTemplates.stream()
                .map(ConditionTemplate::getSpelTemplate)
                .collect(Collectors.toSet());

        // ì²˜ë¦¬ ì¤‘ì¸ í…œí”Œë¦¿ë“¤ì˜ ì´ë¦„ë„ ì¶”ì  (ë°°ì¹˜ ë‚´ì—ì„œ ì¤‘ë³µ ë°©ì§€)
        Set<String> processingNames = new HashSet<>();

        // ìƒˆ í…œí”Œë¦¿ë“¤ì„ í•„í„°ë§í•˜ê³  ì¤‘ë³µ ì‹œ ì´ë¦„ ìˆ˜ì •
        List<ConditionTemplate> newTemplates = templates.stream()
                .filter(template -> {
                    // SpEL ì¤‘ë³µ ì²´í¬ (SpELì´ ì¤‘ë³µë˜ë©´ ì™„ì „íˆ ì œì™¸)
                    if (existingSpelTemplates.contains(template.getSpelTemplate())) {
                        log.debug("âš ï¸ SpEL ì¤‘ë³µìœ¼ë¡œ ê±´ë„ˆëœ€: {} -> {}", template.getName(), template.getSpelTemplate());
                        return false;
                    }

                    // ì´ë¦„ ì¤‘ë³µ ì²´í¬ ë° í•´ê²°
                    String originalName = template.getName();
                    String uniqueName = makeUniqueName(originalName, existingNames, processingNames);

                    if (!originalName.equals(uniqueName)) {
                        log.info("ğŸ”„ ì´ë¦„ ì¤‘ë³µ í•´ê²°: '{}' -> '{}'", originalName, uniqueName);
                        template.setName(uniqueName);
                    }

                    // ì²˜ë¦¬ ì¤‘ì¸ ì´ë¦„ì— ì¶”ê°€
                    processingNames.add(uniqueName);
                    existingNames.add(uniqueName); // ë‹¤ìŒ í…œí”Œë¦¿ ì²˜ë¦¬ ì‹œ ê³ ë ¤ë˜ë„ë¡

                    return true;
                })
                .collect(Collectors.toList());

        log.info("ğŸ’¾ ìƒˆë¡œìš´ í…œí”Œë¦¿ ì €ì¥: {} ê°œ (ì „ì²´: {} ê°œ, SpEL ì¤‘ë³µ ì œì™¸: {} ê°œ)",
                newTemplates.size(), templates.size(), templates.size() - newTemplates.size());

        return newTemplates.isEmpty() ? new ArrayList<>() : conditionTemplateRepository.saveAll(newTemplates);
    }

    /**
     * ğŸ”§ ê³ ìœ í•œ ì´ë¦„ ìƒì„± (ì¤‘ë³µ ì‹œ ì ‘ë¯¸ì‚¬ ì¶”ê°€)
     */
    private String makeUniqueName(String baseName, Set<String> existingNames, Set<String> processingNames) {
        if (!existingNames.contains(baseName) && !processingNames.contains(baseName)) {
            return baseName;
        }

        // ì¤‘ë³µ ì‹œ ì ‘ë¯¸ì‚¬ ì¶”ê°€ ì‹œë„
        for (int i = 2; i <= 100; i++) {
            String candidateName = baseName + " (" + i + ")";
            if (!existingNames.contains(candidateName) && !processingNames.contains(candidateName)) {
                return candidateName;
            }
        }

        // ìµœí›„ ìˆ˜ë‹¨: íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
        String timestampName = baseName + " (" + System.currentTimeMillis() % 10000 + ")";
        log.warn("âš ï¸ ê³ ìœ  ì´ë¦„ ìƒì„±ì„ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ì‚¬ìš©: {}", timestampName);
        return timestampName;
    }

    /**
     * ğŸ”§ í†µí•©: ë¦¬ì†ŒìŠ¤ì™€ ê¶Œí•œì„ ëª¨ë‘ ê³ ë ¤í•œ í†µí•© ì¡°ê±´ í…œí”Œë¦¿ ìƒì„±
     */
    @Transactional
    public List<ConditionTemplate> generateConditionTemplates() {
        log.info("ğŸ¯ AI ê¸°ë°˜ METHOD ë¦¬ì†ŒìŠ¤ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì‹œì‘");

        // ABACëŠ” ì„œë¹„ìŠ¤ ë ˆì´ì–´ì—ì„œë§Œ ì²´í¬ - METHOD íƒ€ì… ë¦¬ì†ŒìŠ¤ë§Œ ëŒ€ìƒ
        List<ManagedResource> methodResources = managedResourceRepository.findAll()
                .stream()
                .filter(resource -> resource.getResourceType() == ManagedResource.ResourceType.METHOD)
                .filter(resource -> resource.getStatus() != ManagedResource.Status.EXCLUDED)
                .collect(Collectors.toList());

        if (methodResources.isEmpty()) {
            log.warn("âš ï¸ METHOD íƒ€ì… ë¦¬ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì¡°ê±´ í…œí”Œë¦¿ì„ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return new ArrayList<>();
        }

        log.info("ğŸ“‹ AI ë¶„ì„ ëŒ€ìƒ METHOD ë¦¬ì†ŒìŠ¤: {} ê°œ", methodResources.size());

        List<ConditionTemplate> templates = new ArrayList<>();

        // 1. ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ (AIë¡œ ìƒì„±)
        templates.addAll(generateAIUniversalTemplates());

        // 2. METHOD ë¦¬ì†ŒìŠ¤ë³„ AI íŠ¹í™” ì¡°ê±´ í…œí”Œë¦¿
        for (ManagedResource resource : methodResources) {
            try {
                templates.addAll(generateAISpecificTemplates(resource));
            } catch (Exception e) {
                log.warn("âš ï¸ AI ë©”ì„œë“œ ë¶„ì„ ì‹¤íŒ¨: {} - {}", resource.getResourceIdentifier(), e.getMessage());
            }
        }

        // ì¤‘ë³µ ì œê±° ë° ì €ì¥
        List<ConditionTemplate> savedTemplates = saveDedupedTemplates(templates);

        log.info("ğŸ‰ AI ê¸°ë°˜ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì™„ë£Œ: {} ê°œ", savedTemplates.size());
        return savedTemplates;
    }

    /**
     * AIë¥¼ í†µí•œ ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ ìƒì„±
     */
    private List<ConditionTemplate> generateAIUniversalTemplates() {
        log.info("ğŸ¤– AI ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì‹œì‘");

        try {
            // AINativeIAMAdvisorì˜ ê°œì„ ëœ ë©”ì„œë“œ í˜¸ì¶œ
            String aiResponse = aiAdvisor.generateUniversalConditionTemplates();
            return parseAITemplateResponse(aiResponse, "UNIVERSAL");
        } catch (Exception e) {
            log.error("ğŸ”¥ AI ë²”ìš© í…œí”Œë¦¿ ìƒì„± ì‹¤íŒ¨", e);
            return generateFallbackUniversalAbacTemplates();
        }
    }

    /**
     * AIë¥¼ í†µí•œ ë©”ì„œë“œë³„ ABAC ì¡°ê±´ í…œí”Œë¦¿ ìƒì„±
     */
    private List<ConditionTemplate> generateAISpecificTemplates(ManagedResource resource) {
        log.debug("ğŸ¤– AI íŠ¹í™” ABAC ì¡°ê±´ ìƒì„±: {}", resource.getResourceIdentifier());

        // íŒŒë¼ë¯¸í„°ê°€ ì—†ëŠ” ë©”ì„œë“œëŠ” ê±´ë„ˆë›°ê¸°
        if (resource.getParameterTypes() == null ||
                resource.getParameterTypes().isEmpty() ||
                resource.getParameterTypes().equals("ì—†ìŒ") ||
                resource.getParameterTypes().equals("()")) {
            log.info("â­ï¸ íŒŒë¼ë¯¸í„°ê°€ ì—†ëŠ” ë©”ì„œë“œ ê±´ë„ˆë›°ê¸°: {}", resource.getResourceIdentifier());
            return new ArrayList<>();
        }

        // ë©”ì„œë“œëª…ì—ì„œ ì˜ë¯¸ìˆëŠ” ì •ë³´ ì¶”ì¶œ
        String methodName = extractMethodName(resource.getResourceIdentifier());
        String entityType = extractEntityType(resource);

        String methodInfo = String.format("""
            ë©”ì„œë“œ ì •ë³´:
            - ë©”ì„œë“œëª…: %s
            - ì—”í‹°í‹° íƒ€ì…: %s
            - íŒŒë¼ë¯¸í„°: %s
            - ë°˜í™˜ íƒ€ì…: %s
            
            ì´ ë©”ì„œë“œì— ì í•©í•œ hasPermission ì¡°ê±´ì„ ìƒì„±í•˜ì„¸ìš”.
            ì˜ˆì‹œ:
            - create ë©”ì„œë“œ â†’ hasPermission(#entity, 'CREATE')
            - get ë©”ì„œë“œ â†’ hasPermission(#id, 'ENTITY', 'READ')
            - update ë©”ì„œë“œ â†’ hasPermission(#entity, 'UPDATE')
            - delete ë©”ì„œë“œ â†’ hasPermission(#id, 'ENTITY', 'DELETE')
            """,
                methodName,
                entityType,
                resource.getParameterTypes(),
                resource.getReturnType() != null ? resource.getReturnType() : "void");

        try {
            String aiResponse = aiAdvisor.generateSpecificConditionTemplates(
                    resource.getResourceIdentifier(), methodInfo);

            log.info("ğŸ” AI ì‘ë‹µ (ë¦¬ì†ŒìŠ¤: {}): {}", resource.getResourceIdentifier(), aiResponse);

            List<ConditionTemplate> templates = parseAITemplateResponse(aiResponse, resource.getResourceIdentifier());

            if (templates.isEmpty()) {
                log.warn("âš ï¸ AIê°€ ë¹ˆ ì‘ë‹µ ë°˜í™˜ (íŒŒë¼ë¯¸í„° ì—†ëŠ” ë©”ì„œë“œì¼ ê°€ëŠ¥ì„±): {}", resource.getResourceIdentifier());
            }

            return templates;
        } catch (Exception e) {
            log.warn("ğŸ”¥ AI íŠ¹í™” ABAC í…œí”Œë¦¿ ìƒì„± ì‹¤íŒ¨: {}", resource.getResourceIdentifier(), e);

            // fallback ì£¼ì„ ì²˜ë¦¬ - AI ì‘ë‹µ ë¶„ì„ í•„ìš”
            // return generateMethodBasedAbacConditions(resource);
            return new ArrayList<>();
        }
    }

    /**
     * ë©”ì„œë“œëª…ì—ì„œ ì—”í‹°í‹° íƒ€ì… ì¶”ì¶œ
     */
    private String extractEntityType(ManagedResource resource) {
        String identifier = resource.getResourceIdentifier();

        // ì¼ë°˜ì ì¸ ì—”í‹°í‹° íŒ¨í„´
        if (identifier.contains("User")) return "ì‚¬ìš©ì";
        if (identifier.contains("Document")) return "ë¬¸ì„œ";
        if (identifier.contains("Group")) return "ê·¸ë£¹";
        if (identifier.contains("Role")) return "ì—­í• ";
        if (identifier.contains("Permission")) return "ê¶Œí•œ";
        if (identifier.contains("Policy")) return "ì •ì±…";
        if (identifier.contains("Project")) return "í”„ë¡œì íŠ¸";
        if (identifier.contains("File")) return "íŒŒì¼";

        // friendlyNameì—ì„œ ì¶”ì¶œ ì‹œë„
        if (resource.getFriendlyName() != null) {
            String[] words = resource.getFriendlyName().split(" ");
            if (words.length > 0) {
                return words[0];
            }
        }

        return "ê°ì²´";
    }

    /**
     * AI ì‘ë‹µì„ ConditionTemplate ê°ì²´ë¡œ íŒŒì‹±
     */
    private List<ConditionTemplate> parseAITemplateResponse(String aiResponse, String sourceMethod) {
        List<ConditionTemplate> templates = new ArrayList<>();

        try {
            // JSON ì •ì œ - ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±° ë° ë¶ˆí•„ìš”í•œ í…ìŠ¤íŠ¸ ì œê±°
            String cleanedJson = extractAndCleanJson(aiResponse);
            log.debug("ğŸ” ì •ì œëœ JSON: {}", cleanedJson);

            // ë¹ˆ ë°°ì—´ì¸ ê²½ìš° ë°”ë¡œ ë¦¬í„´
            if (cleanedJson.trim().equals("[]")) {
                log.info("âœ… AIê°€ ë¹ˆ ë°°ì—´ ë°˜í™˜ (íŒŒë¼ë¯¸í„° ì—†ëŠ” ë©”ì„œë“œ): {}", sourceMethod);
                return templates;
            }

            // JSON ë°°ì—´ íŒŒì‹± ì‹œë„
            List<Map<String, Object>> rawTemplates = objectMapper.readValue(
                    cleanedJson, new TypeReference<List<Map<String, Object>>>() {});

            for (Map<String, Object> raw : rawTemplates) {
                try {
                    ConditionTemplate template = ConditionTemplate.builder()
                            .name((String) raw.get("name"))
                            .description((String) raw.get("description"))
                            .spelTemplate((String) raw.get("spelTemplate"))
                            .category((String) raw.getOrDefault("category", "AI ìƒì„±"))
                            .classification(parseClassification((String) raw.get("classification")))
                            .sourceMethod(sourceMethod)
                            .isAutoGenerated(true)
                            .templateType("ai_generated")
                            .createdAt(LocalDateTime.now())
                            .build();

                    // SpEL í…œí”Œë¦¿ì´ ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°ë§Œ ì¶”ê°€
                    if (template.getSpelTemplate() != null && !template.getSpelTemplate().trim().isEmpty()) {
                        log.info("ğŸ“Œ íŒŒì‹±ëœ ì¡°ê±´: {} -> {}", template.getName(), template.getSpelTemplate());
                        templates.add(template);
                    } else {
                        log.warn("âš ï¸ SpEL í…œí”Œë¦¿ì´ ë¹„ì–´ìˆì–´ ê±´ë„ˆëœ€: {}", template.getName());
                    }
                } catch (Exception itemError) {
                    log.warn("ğŸ”¥ í…œí”Œë¦¿ í•­ëª© íŒŒì‹± ì‹¤íŒ¨: {}", raw, itemError);
                }
            }

            log.info("âœ… AI ì‘ë‹µ íŒŒì‹± ì„±ê³µ: {} ê°œ í…œí”Œë¦¿", templates.size());

        } catch (Exception e) {
            log.error("ğŸ”¥ AI ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: {}", aiResponse, e);
            // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜ (fallbackì€ ì£¼ì„ ì²˜ë¦¬ë¨)
        }

        return templates;
    }

    /**
     * AI ì‘ë‹µì—ì„œ JSON ë¶€ë¶„ë§Œ ì¶”ì¶œí•˜ê³  ì •ì œ
     */
    private String extractAndCleanJson(String aiResponse) {
        if (aiResponse == null || aiResponse.trim().isEmpty()) {
            return "[]";
        }

        // ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±°
        String cleaned = aiResponse.replaceAll("```json\\s*", "").replaceAll("```\\s*", "");

        // JSON ë°°ì—´ ì‹œì‘ê³¼ ë ì°¾ê¸°
        int startIdx = cleaned.indexOf('[');
        int endIdx = cleaned.lastIndexOf(']');

        if (startIdx != -1 && endIdx != -1 && startIdx < endIdx) {
            return cleaned.substring(startIdx, endIdx + 1).trim();
        }

        // JSON ê°ì²´ í˜•íƒœì¸ ê²½ìš° ë°°ì—´ë¡œ ê°ì‹¸ê¸°
        startIdx = cleaned.indexOf('{');
        endIdx = cleaned.lastIndexOf('}');

        if (startIdx != -1 && endIdx != -1 && startIdx < endIdx) {
            String jsonObject = cleaned.substring(startIdx, endIdx + 1).trim();
            return "[" + jsonObject + "]";
        }

        // íŒŒì‹±í•  ìˆ˜ ìˆëŠ” JSONì´ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜
        log.warn("ğŸ”¥ AI ì‘ë‹µì—ì„œ ìœ íš¨í•œ JSONì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: {}", aiResponse.substring(0, Math.min(100, aiResponse.length())));
        return "[]";
    }

    private ConditionTemplate.ConditionClassification parseClassification(String classification) {
        if (classification == null) return ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT;

        try {
            return ConditionTemplate.ConditionClassification.valueOf(classification.toUpperCase());
        } catch (Exception e) {
            return ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT;
        }
    }

    /**
     * AI ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ë²”ìš© hasPermission í…œí”Œë¦¿ë“¤ - ì£¼ì„ ì²˜ë¦¬
     */
    private List<ConditionTemplate> generateFallbackUniversalAbacTemplates() {
        log.info("ğŸ”„ AI ì‹¤íŒ¨ë¡œ ì¸í•œ ê¸°ë³¸ ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ ìƒì„±");

        // fallback ì£¼ì„ ì²˜ë¦¬ - AI ì‘ë‹µ ë¶„ì„ í•„ìš”
        /*
        List<ConditionTemplate> templates = new ArrayList<>();

        // 1. ì½ê¸° ê¶Œí•œ í™•ì¸ (ë²”ìš©)
        templates.add(ConditionTemplate.builder()
            .name("ê°ì²´ ì½ê¸° ì¡°ê±´")
            .description("ê°ì²´ì— ëŒ€í•œ ì½ê¸° ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ë²”ìš© ì¡°ê±´")
            .category("ê¶Œí•œ í™•ì¸")
            .classification(ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT)
            .spelTemplate("hasPermission(#returnObject, 'READ')")
            .sourceMethod("UNIVERSAL")
            .isAutoGenerated(true)
            .templateType("fallback")
            .riskLevel(ConditionTemplate.RiskLevel.LOW)
            .complexityScore(2)
            .approvalRequired(false)
            .contextDependent(true)
            .createdAt(LocalDateTime.now())
            .build());

        // 2. ì“°ê¸° ê¶Œí•œ í™•ì¸ (ë²”ìš©)
        templates.add(ConditionTemplate.builder()
            .name("ê°ì²´ ìˆ˜ì • ì¡°ê±´")
            .description("ê°ì²´ì— ëŒ€í•œ ìˆ˜ì • ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ë²”ìš© ì¡°ê±´")
            .category("ê¶Œí•œ í™•ì¸")
            .classification(ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT)
            .spelTemplate("hasPermission(#returnObject, 'UPDATE')")
            .sourceMethod("UNIVERSAL")
            .isAutoGenerated(true)
            .templateType("fallback")
            .riskLevel(ConditionTemplate.RiskLevel.MEDIUM)
            .complexityScore(2)
            .approvalRequired(false)
            .contextDependent(true)
            .createdAt(LocalDateTime.now())
            .build());

        // 3. ì‚­ì œ ê¶Œí•œ í™•ì¸ (ë²”ìš©)
        templates.add(ConditionTemplate.builder()
            .name("ê°ì²´ ì‚­ì œ ì¡°ê±´")
            .description("ê°ì²´ì— ëŒ€í•œ ì‚­ì œ ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ë²”ìš© ì¡°ê±´")
            .category("ê¶Œí•œ í™•ì¸")
            .classification(ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT)
            .spelTemplate("hasPermission(#returnObject, 'DELETE')")
            .sourceMethod("UNIVERSAL")
            .isAutoGenerated(true)
            .templateType("fallback")
            .riskLevel(ConditionTemplate.RiskLevel.HIGH)
            .complexityScore(2)
            .approvalRequired(false)
            .contextDependent(true)
            .createdAt(LocalDateTime.now())
            .build());

        // 4. ì¸ì¦ í™•ì¸ (ë²”ìš©)
        templates.add(ConditionTemplate.builder()
            .name("ì¸ì¦ ìƒíƒœ í™•ì¸")
            .description("ì‚¬ìš©ìê°€ ì¸ì¦ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë²”ìš© ì¡°ê±´")
            .category("ì¸ì¦ í™•ì¸")
            .classification(ConditionTemplate.ConditionClassification.UNIVERSAL)
            .spelTemplate("isAuthenticated()")
            .sourceMethod("UNIVERSAL")
            .isAutoGenerated(true)
            .templateType("fallback")
            .riskLevel(ConditionTemplate.RiskLevel.LOW)
            .complexityScore(1)
            .approvalRequired(false)
            .contextDependent(false)
            .createdAt(LocalDateTime.now())
            .build());

        return templates;
        */

        return new ArrayList<>(); // ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
    }

    /**
     * ë©”ì„œë“œ íŒ¨í„´ ê¸°ë°˜ hasPermission ì¡°ê±´ ìƒì„± - ì£¼ì„ ì²˜ë¦¬
     */
    private List<ConditionTemplate> generateMethodBasedAbacConditions(ManagedResource resource) {
        // fallback ì£¼ì„ ì²˜ë¦¬ - AI ì‘ë‹µ ë¶„ì„ í•„ìš”
        /*
        List<ConditionTemplate> templates = new ArrayList<>();
        String methodName = extractMethodName(resource.getResourceIdentifier());
        String entityType = extractEntityType(resource);
        String entityTypeUpper = entityType.toUpperCase();

        // íŒŒë¼ë¯¸í„° íƒ€ì… ë¶„ì„
        boolean hasIdParam = resource.getParameterTypes() != null &&
            (resource.getParameterTypes().contains("Long") || resource.getParameterTypes().contains("id"));
        boolean hasObjectParam = resource.getParameterTypes() != null &&
            resource.getParameterTypes().toLowerCase().contains(entityType.toLowerCase());

        // 1. CREATE íŒ¨í„´ - hasPermission(#object, 'CREATE')
        if (methodName.contains("create") || methodName.contains("add") || methodName.contains("insert")) {
            if (hasObjectParam) {
                templates.add(ConditionTemplate.builder()
                    .name(String.format("%s ìƒì„± ì¡°ê±´", entityType))
                    .description(String.format("%së¥¼ ìƒì„±í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ì¡°ê±´", entityType))
                    .category("ê¶Œí•œ í™•ì¸")
                    .classification(ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT)
                    .spelTemplate(String.format("hasPermission(#%s, 'CREATE')", entityType.toLowerCase()))
                    .sourceMethod(resource.getResourceIdentifier())
                    .isAutoGenerated(true)
                    .templateType("method_based")
                    .riskLevel(ConditionTemplate.RiskLevel.MEDIUM)
                    .complexityScore(2)
                    .contextDependent(true)
                    .createdAt(LocalDateTime.now())
                    .build());
            }
        }

        // 2. READ íŒ¨í„´ - hasPermission(#id, 'TYPE', 'READ')
        else if (methodName.contains("get") || methodName.contains("find") || methodName.contains("read") || methodName.contains("view")) {
            if (hasIdParam) {
                templates.add(ConditionTemplate.builder()
                    .name(String.format("%s ì¡°íšŒ ì¡°ê±´", entityType))
                    .description(String.format("%së¥¼ ì¡°íšŒí•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ì¡°ê±´", entityType))
                    .category("ê¶Œí•œ í™•ì¸")
                    .classification(ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT)
                    .spelTemplate(String.format("hasPermission(#id, '%s', 'READ')", entityTypeUpper))
                    .sourceMethod(resource.getResourceIdentifier())
                    .isAutoGenerated(true)
                    .templateType("method_based")
                    .riskLevel(ConditionTemplate.RiskLevel.LOW)
                    .complexityScore(2)
                    .contextDependent(true)
                    .createdAt(LocalDateTime.now())
                    .build());
            }
        }

        // 3. UPDATE íŒ¨í„´ - hasPermission(#object, 'UPDATE')
        else if (methodName.contains("update") || methodName.contains("modify") || methodName.contains("edit")) {
            if (hasObjectParam) {
                templates.add(ConditionTemplate.builder()
                    .name(String.format("%s ìˆ˜ì • ì¡°ê±´", entityType))
                    .description(String.format("%së¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ì¡°ê±´", entityType))
                    .category("ê¶Œí•œ í™•ì¸")
                    .classification(ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT)
                    .spelTemplate(String.format("hasPermission(#%s, 'UPDATE')", entityType.toLowerCase()))
                    .sourceMethod(resource.getResourceIdentifier())
                    .isAutoGenerated(true)
                    .templateType("method_based")
                    .riskLevel(ConditionTemplate.RiskLevel.MEDIUM)
                    .complexityScore(2)
                    .contextDependent(true)
                    .createdAt(LocalDateTime.now())
                    .build());
            } else if (hasIdParam) {
                templates.add(ConditionTemplate.builder()
                    .name(String.format("%s ìˆ˜ì • ì¡°ê±´", entityType))
                    .description(String.format("%së¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ì¡°ê±´", entityType))
                    .category("ê¶Œí•œ í™•ì¸")
                    .classification(ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT)
                    .spelTemplate(String.format("hasPermission(#id, '%s', 'UPDATE')", entityTypeUpper))
                    .sourceMethod(resource.getResourceIdentifier())
                    .isAutoGenerated(true)
                    .templateType("method_based")
                    .riskLevel(ConditionTemplate.RiskLevel.MEDIUM)
                    .complexityScore(2)
                    .contextDependent(true)
                    .createdAt(LocalDateTime.now())
                    .build());
            }
        }

        // 4. DELETE íŒ¨í„´ - hasPermission(#id, 'TYPE', 'DELETE')
        else if (methodName.contains("delete") || methodName.contains("remove")) {
            if (hasIdParam) {
                templates.add(ConditionTemplate.builder()
                    .name(String.format("%s ì‚­ì œ ì¡°ê±´", entityType))
                    .description(String.format("%së¥¼ ì‚­ì œí•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ì¡°ê±´", entityType))
                    .category("ê¶Œí•œ í™•ì¸")
                    .classification(ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT)
                    .spelTemplate(String.format("hasPermission(#id, '%s', 'DELETE')", entityTypeUpper))
                    .sourceMethod(resource.getResourceIdentifier())
                    .isAutoGenerated(true)
                    .templateType("method_based")
                    .riskLevel(ConditionTemplate.RiskLevel.HIGH)
                    .complexityScore(2)
                    .contextDependent(true)
                    .createdAt(LocalDateTime.now())
                    .build());
            }
        }

        return templates;
        */

        return new ArrayList<>(); // ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
    }
}