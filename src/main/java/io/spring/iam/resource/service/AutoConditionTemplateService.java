package io.spring.iam.resource.service;

import com.fasterxml.jackson.databind.ObjectMapper;
import io.spring.iam.aiam.operations.AINativeIAMOperations;
import io.spring.iam.domain.dto.AutoGeneratedTemplate;
import io.spring.iam.domain.entity.ConditionTemplate;
import io.spring.iam.domain.entity.ManagedResource;
import io.spring.iam.repository.ConditionTemplateRepository;
import io.spring.iam.repository.ManagedResourceRepository;
import io.spring.iam.repository.PermissionRepository;
import io.spring.iam.resource.MethodPatternAnalyzer;
import io.spring.iam.resource.MethodPatternAnalyzer.MethodAnalysisResult;
import io.spring.redis.RedisEventPublisher;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Lazy;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

/**
 * ğŸ”§ ìë™ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì„œë¹„ìŠ¤ (ìˆœí™˜ ì˜ì¡´ì„± @Lazyë¡œ í•´ê²°)
 * 
 * âœ… í•´ê²° ë°©ë²•:
 * - AINativeIAMOperationsì— @Lazy ì–´ë…¸í…Œì´ì…˜ ì ìš©
 * - ì‹¤ì œ ì‚¬ìš© ì‹œì ì— ë¹ˆ ì´ˆê¸°í™”
 * - ì´ë²¤íŠ¸ ê¸°ë°˜ ë³µì¡ì„± ì œê±°
 */
@Service
@Slf4j
public class AutoConditionTemplateService {

    private final ConditionTemplateRepository conditionTemplateRepository;
    private final MethodPatternAnalyzer methodPatternAnalyzer;
    private final PermissionRepository permissionRepository;
    private final ManagedResourceRepository managedResourceRepository;
    private final AINativeIAMOperations aiNativeIAMOperations;
    private final ObjectMapper objectMapper;
    private final RedisEventPublisher eventPublisher;

    public AutoConditionTemplateService(ConditionTemplateRepository conditionTemplateRepository,
                                      MethodPatternAnalyzer methodPatternAnalyzer,
                                      PermissionRepository permissionRepository,
                                      ManagedResourceRepository managedResourceRepository,
                                      @Lazy AINativeIAMOperations aiNativeIAMOperations,
                                      ObjectMapper objectMapper,
                                      RedisEventPublisher eventPublisher) {
        this.conditionTemplateRepository = conditionTemplateRepository;
        this.methodPatternAnalyzer = methodPatternAnalyzer;
        this.permissionRepository = permissionRepository;
        this.managedResourceRepository = managedResourceRepository;
        this.aiNativeIAMOperations = aiNativeIAMOperations;
        this.objectMapper = objectMapper;
        this.eventPublisher = eventPublisher;
    }

    /**
     * ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ ì •ë³´ë¥¼ ë‹´ëŠ” í´ë˜ìŠ¤
     */
    public static class MethodSignature {
        public final String methodName;
        public final String parameterInfo;
        public final String resourceType;
        
        public MethodSignature(String methodName, String parameterInfo, String resourceType) {
            this.methodName = methodName;
            this.parameterInfo = parameterInfo;
            this.resourceType = resourceType;
        }
    }

    /**
     * ë©”ì„œë“œ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¡°ê±´ í…œí”Œë¦¿ì„ ìë™ ìƒì„±í•©ë‹ˆë‹¤.
     */
    @Transactional
    public List<ConditionTemplate> generateTemplatesFromAnalysis(List<MethodAnalysisResult> analysisResults) {
        log.info("ğŸ”„ ìë™ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì‹œì‘: {} ê°œ ë¶„ì„ ê²°ê³¼", analysisResults.size());

        List<ConditionTemplate> generatedTemplates = new ArrayList<>();

        // 1. ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± (í•œ ë²ˆë§Œ)
        List<ConditionTemplate> universalTemplates = generateUniversalTemplates();
        generatedTemplates.addAll(universalTemplates);

        // 2. ë©”ì„œë“œë³„ íŠ¹í™” í…œí”Œë¦¿ ìƒì„±
        for (MethodAnalysisResult analysis : analysisResults) {
            List<ConditionTemplate> methodTemplates = generateMethodSpecificTemplates(analysis);
            generatedTemplates.addAll(methodTemplates);
        }

        // 3. ì¤‘ë³µ ì œê±° ë° DB ì €ì¥
        List<ConditionTemplate> savedTemplates = saveDedupedTemplates(generatedTemplates);

        log.info("âœ… ìë™ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì™„ë£Œ: {} ê°œ í…œí”Œë¦¿ ì €ì¥", savedTemplates.size());
        return savedTemplates;
    }

    /**
     * ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ë“¤ì„ ìƒì„±í•©ë‹ˆë‹¤. (hasPermission ë°©ì‹)
     */
    private List<ConditionTemplate> generateUniversalTemplates() {
        log.info("ğŸŒ ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì‹œì‘");

        List<AutoGeneratedTemplate> universalTemplates = Arrays.asList(
            new AutoGeneratedTemplate(
                "ë²”ìš© ê¶Œí•œ í™•ì¸",
                "ì‚¬ìš©ìê°€ íŠ¹ì • ê¶Œí•œì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸",
                "hasPermission(authentication, #targetObject, 'READ')",
                "universal",
                null,
                true
            ),
            new AutoGeneratedTemplate(
                "ë²”ìš© ì†Œìœ ì í™•ì¸", 
                "í˜„ì¬ ì‚¬ìš©ìê°€ ëŒ€ìƒ ê°ì²´ì˜ ì†Œìœ ìì¸ì§€ í™•ì¸",
                "#targetObject.owner == authentication.name",
                "universal",
                null,
                true
            ),
            new AutoGeneratedTemplate(
                "ë²”ìš© ê´€ë¦¬ì ê¶Œí•œ",
                "í˜„ì¬ ì‚¬ìš©ìê°€ ê´€ë¦¬ì ê¶Œí•œì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸", 
                "hasRole('ADMIN') or hasRole('SUPER_ADMIN')",
                "universal",
                null,
                true
            ),
            new AutoGeneratedTemplate(
                "ë²”ìš© ì—…ë¬´ì‹œê°„ ì œí•œ",
                "ì—…ë¬´ ì‹œê°„(09:00-18:00) ë‚´ì—ì„œë§Œ ì ‘ê·¼ í—ˆìš©",
                "#isBusinessHours()",
                "universal", 
                null,
                true
            ),
            new AutoGeneratedTemplate(
                "ë²”ìš© IP ì œí•œ",
                "ì‚¬ë‚´ IP ëŒ€ì—­ì—ì„œë§Œ ì ‘ê·¼ í—ˆìš©",
                "#isInternalIP(request.remoteAddr)",
                "universal",
                null,
                true
            )
        );

        return universalTemplates.stream()
            .map(this::convertToConditionTemplate)
            .collect(Collectors.toList());
    }

    /**
     * ë©”ì„œë“œë³„ íŠ¹í™” ì¡°ê±´ í…œí”Œë¦¿ì„ ìƒì„±í•©ë‹ˆë‹¤.
     */
    private List<ConditionTemplate> generateMethodSpecificTemplates(MethodAnalysisResult analysis) {
        log.debug("ğŸ”§ ë©”ì„œë“œ íŠ¹í™” í…œí”Œë¦¿ ìƒì„±: {}", analysis.getMethodName());

        List<AutoGeneratedTemplate> templates = new ArrayList<>();

        // 1. ë©”ì„œë“œ íŒ¨í„´ë³„ í…œí”Œë¦¿ ìƒì„±
        String returnType = analysis.getReturnType().getSimpleName();
        if (returnType.contains("List") || returnType.contains("Collection")) {
            // ì»¬ë ‰ì…˜ ë°˜í™˜ ë©”ì„œë“œ
            templates.add(createCollectionAccessTemplate(analysis));
        } else if (hasIdParameter(analysis)) {
            // ID íŒŒë¼ë¯¸í„°ê°€ ìˆëŠ” ë©”ì„œë“œ
            templates.add(createIdBasedAccessTemplate(analysis)); 
        } else {
            // ì¼ë°˜ ë©”ì„œë“œ
            templates.add(createGeneralAccessTemplate(analysis));
        }

        // 2. AI ê¸°ë°˜ ì¶”ê°€ í…œí”Œë¦¿ ìƒì„± (í•„ìš”ì‹œ)
        try {
            List<AutoGeneratedTemplate> aiTemplates = generateAITemplates(analysis);
            templates.addAll(aiTemplates);
        } catch (Exception e) {
            log.warn("âš ï¸ AI í…œí”Œë¦¿ ìƒì„± ì‹¤íŒ¨: {} - {}", analysis.getMethodName(), e.getMessage());
        }

        return templates.stream()
            .map(this::convertToConditionTemplate)
            .collect(Collectors.toList());
    }

    /**
     * AI ê¸°ë°˜ í…œí”Œë¦¿ ìƒì„± (ê°„ë‹¨í™”)
     */
    private List<AutoGeneratedTemplate> generateAITemplates(MethodAnalysisResult analysis) {
        // ê°„ë‹¨í•œ AI ìš”ì²­ìœ¼ë¡œ ëŒ€ì²´
        return Collections.emptyList(); // í˜„ì¬ëŠ” ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
    }

    /**
     * ID íŒŒë¼ë¯¸í„° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
     */
    private boolean hasIdParameter(MethodAnalysisResult analysis) {
        return analysis.getParameters().stream()
            .anyMatch(param -> param.getName().toLowerCase().contains("id"));
    }

    /**
     * ManagedResourceë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¡°ê±´ í…œí”Œë¦¿ì„ ìƒì„±í•©ë‹ˆë‹¤.
     */
    public List<ConditionTemplate> generateConditionTemplates() {
        log.info("ğŸ”„ ManagedResource ê¸°ë°˜ ì¡°ê±´ í…œí”Œë¦¿ ìë™ ìƒì„± ì‹œì‘");

        List<ManagedResource> resources = managedResourceRepository.findAll();
        if (resources.isEmpty()) {
            log.warn("âš ï¸ ManagedResourceê°€ ì—†ì–´ì„œ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„±ì„ ê±´ë„ˆëœë‹ˆë‹¤");
            return Collections.emptyList();
        }

        log.info("ğŸ“Š {}ê°œì˜ ManagedResourceë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„±", resources.size());

        List<ConditionTemplate> allTemplates = new ArrayList<>();

        // 1. ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ (í•œ ë²ˆë§Œ)
        List<ConditionTemplate> universalTemplates = generateUniversalTemplates();
        allTemplates.addAll(universalTemplates);

        // 2. ë¦¬ì†ŒìŠ¤ë³„ íŠ¹í™” í…œí”Œë¦¿
        for (ManagedResource resource : resources) {
            List<ConditionTemplate> resourceTemplates = generateResourceSpecificTemplates(resource);
            allTemplates.addAll(resourceTemplates);
        }

        // 3. ì¤‘ë³µ ì œê±° ë° ì €ì¥
        List<ConditionTemplate> savedTemplates = saveDedupedTemplates(allTemplates);

        log.info("âœ… ì¡°ê±´ í…œí”Œë¦¿ ìë™ ìƒì„± ì™„ë£Œ: {}ê°œ í…œí”Œë¦¿ ì €ì¥", savedTemplates.size());
        return savedTemplates;
    }

    /**
     * ë¦¬ì†ŒìŠ¤ë³„ íŠ¹í™” ì¡°ê±´ í…œí”Œë¦¿ì„ ìƒì„±í•©ë‹ˆë‹¤.
     */
    private List<ConditionTemplate> generateResourceSpecificTemplates(ManagedResource resource) {
        List<AutoGeneratedTemplate> templates = new ArrayList<>();

        String resourceId = resource.getResourceIdentifier();
        String friendlyName = resource.getFriendlyName();

        // 1. ì½ê¸° ê¶Œí•œ í…œí”Œë¦¿
        templates.add(new AutoGeneratedTemplate(
            String.format("%s ì½ê¸° ê¶Œí•œ", friendlyName),
            String.format("%s ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì½ê¸° ê¶Œí•œ í™•ì¸", friendlyName),
            String.format("hasPermission(authentication, '%s', 'READ')", resourceId),
            "resource_read",
            resourceId,
            false
        ));

        // 2. ì“°ê¸° ê¶Œí•œ í…œí”Œë¦¿  
        templates.add(new AutoGeneratedTemplate(
            String.format("%s ì“°ê¸° ê¶Œí•œ", friendlyName),
            String.format("%s ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì“°ê¸° ê¶Œí•œ í™•ì¸", friendlyName),
            String.format("hasPermission(authentication, '%s', 'WRITE')", resourceId),
            "resource_write", 
            resourceId,
            false
        ));

        // 3. ê´€ë¦¬ì ê¶Œí•œ í…œí”Œë¦¿
        templates.add(new AutoGeneratedTemplate(
            String.format("%s ê´€ë¦¬ì ê¶Œí•œ", friendlyName),
            String.format("%s ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ê´€ë¦¬ì ê¶Œí•œ í™•ì¸", friendlyName),
            String.format("hasPermission(authentication, '%s', 'ADMIN') or hasRole('ADMIN')", resourceId),
            "resource_admin",
            resourceId,
            false
        ));

        return templates.stream()
            .map(this::convertToConditionTemplate)
            .collect(Collectors.toList());
    }

    private ConditionTemplate convertToConditionTemplate(AutoGeneratedTemplate template) {
        ConditionTemplate entity = new ConditionTemplate();
        entity.setName(template.getName());
        entity.setDescription(template.getDescription());
        entity.setSpelTemplate(template.getSpelTemplate());
        entity.setIsAutoGenerated(true);
        entity.setTemplateType(template.getTemplateType());
        entity.setSourceMethod(template.getSourceMethod());
        entity.setIsUniversal(template.isUniversal());
        entity.setCreatedAt(LocalDateTime.now());
        entity.setUpdatedAt(LocalDateTime.now());

        // ğŸ”„ 2ë‹¨ê³„: ìë™ ìƒì„± í…œí”Œë¦¿ì˜ ë¶„ë¥˜ ê²°ì •
        if (template.isUniversal()) {
            // ë²”ìš© ì¡°ê±´
            entity.setClassification(ConditionTemplate.ConditionClassification.UNIVERSAL);
            entity.setRiskLevel(ConditionTemplate.RiskLevel.LOW);
            entity.setComplexityScore(1);
            entity.setApprovalRequired(false);
            entity.setContextDependent(false);
        } else {
            // íŠ¹í™” ì¡°ê±´
            entity.setClassification(ConditionTemplate.ConditionClassification.UNIVERSAL); // ì„ì‹œë¡œ UNIVERSAL ì‚¬ìš©
            entity.setRiskLevel(ConditionTemplate.RiskLevel.MEDIUM);
            entity.setComplexityScore(3);
            entity.setApprovalRequired(true);
            entity.setContextDependent(true);
        }

        // ì¹´í…Œê³ ë¦¬ ì„¤ì •
        if (template.getTemplateType().contains("universal")) {
            entity.setCategory("ë²”ìš©");
        } else if (template.getTemplateType().contains("resource")) {
            entity.setCategory("ë¦¬ì†ŒìŠ¤ë³„");
        } else {
            entity.setCategory("ë©”ì„œë“œë³„");
        }

        return entity;
    }

    private AutoGeneratedTemplate createCollectionAccessTemplate(MethodAnalysisResult analysis) {
        return new AutoGeneratedTemplate(
            String.format("%s ì»¬ë ‰ì…˜ ì ‘ê·¼", analysis.getMethodName()),
            String.format("%s ë©”ì„œë“œì˜ ì»¬ë ‰ì…˜ ê²°ê³¼ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œ", analysis.getMethodName()),
            String.format("hasPermission(authentication, '%s', 'READ')", analysis.getMethodName()),
            "collection_access",
            analysis.getMethodName(),
            false
        );
    }

    private AutoGeneratedTemplate createIdBasedAccessTemplate(MethodAnalysisResult analysis) {
        return new AutoGeneratedTemplate(
            String.format("%s ID ê¸°ë°˜ ì ‘ê·¼", analysis.getMethodName()),
            String.format("%s ë©”ì„œë“œì˜ ID íŒŒë¼ë¯¸í„° ê¸°ë°˜ ì ‘ê·¼ ê¶Œí•œ", analysis.getMethodName()),
            String.format("hasPermission(authentication, #id, 'READ') or #id == authentication.name", analysis.getMethodName()),
            "id_parameter",
            analysis.getMethodName(),
            false
        );
    }

    private AutoGeneratedTemplate createGeneralAccessTemplate(MethodAnalysisResult analysis) {
        return new AutoGeneratedTemplate(
            String.format("%s ì¼ë°˜ ì ‘ê·¼", analysis.getMethodName()),
            String.format("%s ë©”ì„œë“œì— ëŒ€í•œ ì¼ë°˜ ì ‘ê·¼ ê¶Œí•œ", analysis.getMethodName()),
            String.format("hasPermission(authentication, '%s', 'EXECUTE')", analysis.getMethodName()),
            "general_access",
            analysis.getMethodName(),
            false
        );
    }

    private List<ConditionTemplate> saveDedupedTemplates(List<ConditionTemplate> templates) {
        // ì´ë¦„ ê¸°ë°˜ ì¤‘ë³µ ì œê±°
        Map<String, ConditionTemplate> uniqueTemplates = templates.stream()
            .collect(Collectors.toMap(
                ConditionTemplate::getName,
                template -> template,
                (existing, replacement) -> existing // ê¸°ì¡´ ê²ƒì„ ìœ ì§€
            ));

        List<ConditionTemplate> savedTemplates = conditionTemplateRepository.saveAll(uniqueTemplates.values());
        log.info("ğŸ“Š ì¤‘ë³µ ì œê±° í›„ ì €ì¥: ì›ë³¸ {}ê°œ â†’ ì €ì¥ {}ê°œ", templates.size(), savedTemplates.size());

        return savedTemplates;
    }
}