package io.spring.iam.resource.service;

import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import io.spring.iam.aiam.AINativeIAMAdvisor;
import io.spring.iam.domain.dto.AutoGeneratedTemplate;
import io.spring.iam.domain.entity.ConditionTemplate;
import io.spring.iam.domain.entity.ManagedResource;
import io.spring.iam.repository.ConditionTemplateRepository;
import io.spring.iam.repository.ManagedResourceRepository;
import io.spring.iam.repository.PermissionRepository;
import io.spring.iam.resource.MethodPatternAnalyzer;
import io.spring.iam.resource.MethodPatternAnalyzer.MethodAnalysisResult;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Slf4j
public class AutoConditionTemplateService {

    private final ConditionTemplateRepository conditionTemplateRepository;
    private final MethodPatternAnalyzer methodPatternAnalyzer;
    private final PermissionRepository permissionRepository;
    private final ManagedResourceRepository managedResourceRepository;
    private final AINativeIAMAdvisor aiAdvisor;
    private final ObjectMapper objectMapper;

    /**
     * ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ ì •ë³´ë¥¼ ë‹´ëŠ” í´ë˜ìŠ¤
     */
    public static class MethodSignature {
        public final String methodName;
        public final String parameterInfo;
        public final String resourceType;
        
        public MethodSignature(String methodName, String parameterInfo, String resourceType) {
            this.methodName = methodName;
            this.parameterInfo = parameterInfo;
            this.resourceType = resourceType;
        }
    }

    /**
     * ìë™ ìƒì„±ëœ ì¡°ê±´ í…œí”Œë¦¿ ì •ë³´ë¥¼ ë‹´ëŠ” DTO
     */


    /**
     * ë©”ì„œë“œ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¡°ê±´ í…œí”Œë¦¿ì„ ìë™ ìƒì„±í•©ë‹ˆë‹¤.
     */
    @Transactional
    public List<ConditionTemplate> generateTemplatesFromAnalysis(List<MethodAnalysisResult> analysisResults) {
        log.info("ğŸ”„ ìë™ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì‹œì‘: {} ê°œ ë¶„ì„ ê²°ê³¼", analysisResults.size());

        List<ConditionTemplate> generatedTemplates = new ArrayList<>();

        // 1. ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± (í•œ ë²ˆë§Œ)
        List<ConditionTemplate> universalTemplates = generateUniversalTemplates();
        generatedTemplates.addAll(universalTemplates);

        // 2. ë©”ì„œë“œë³„ íŠ¹í™” í…œí”Œë¦¿ ìƒì„±
        for (MethodAnalysisResult analysis : analysisResults) {
            List<ConditionTemplate> methodTemplates = generateMethodSpecificTemplates(analysis);
            generatedTemplates.addAll(methodTemplates);
        }

        // 3. ì¤‘ë³µ ì œê±° ë° DB ì €ì¥
        List<ConditionTemplate> savedTemplates = saveDedupedTemplates(generatedTemplates);

        log.info("âœ… ìë™ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì™„ë£Œ: {} ê°œ í…œí”Œë¦¿ ì €ì¥", savedTemplates.size());
        return savedTemplates;
    }

    /**
     * ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ë“¤ì„ ìƒì„±í•©ë‹ˆë‹¤. (hasPermission ë°©ì‹)
     */
    private List<ConditionTemplate> generateUniversalTemplates() {
        List<AutoGeneratedTemplate> universalTemplates = Arrays.asList(
                // ì‹œê°„ ê¸°ë°˜ ì¡°ê±´ë“¤
                new AutoGeneratedTemplate(
                        "ì—…ë¬´ì‹œê°„ ì ‘ê·¼",
                        "í‰ì¼ ì˜¤ì „ 9ì‹œë¶€í„° ì˜¤í›„ 6ì‹œê¹Œì§€ë§Œ ì ‘ê·¼ í—ˆìš©",
                        "T(java.time.LocalTime).now().hour >= 9 and T(java.time.LocalTime).now().hour <= 18",
                        "universal", "system_generated", true),

                new AutoGeneratedTemplate(
                        "í‰ì¼ ì ‘ê·¼",
                        "ì›”ìš”ì¼ë¶€í„° ê¸ˆìš”ì¼ê¹Œì§€ë§Œ ì ‘ê·¼ í—ˆìš©",
                        "T(java.time.LocalDate).now().dayOfWeek.value <= 5",
                        "universal", "system_generated", true),

                // IP ê¸°ë°˜ ì¡°ê±´ë“¤
                new AutoGeneratedTemplate(
                        "ë‚´ë¶€ë§ ì ‘ê·¼",
                        "192.168.x.x ëŒ€ì—­ì—ì„œë§Œ ì ‘ê·¼ í—ˆìš©",
                        "#request.remoteAddr matches '^192\\\\.168\\\\..*'",
                        "universal", "system_generated", true),

                new AutoGeneratedTemplate(
                        "ì‚¬ë‚´ë§ ì ‘ê·¼",
                        "10.x.x.x ëŒ€ì—­ì—ì„œë§Œ ì ‘ê·¼ í—ˆìš©",
                        "#request.remoteAddr matches '^10\\\\..*'",
                        "universal", "system_generated", true),

                // ì¸ì¦ëœ ì‚¬ìš©ì ê¸°ë°˜ ì¡°ê±´ë“¤
                new AutoGeneratedTemplate(
                        "ì¸ì¦ëœ ì‚¬ìš©ì",
                        "ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ì ‘ê·¼ í—ˆìš©",
                        "isAuthenticated()",
                        "universal", "system_generated", true),

                new AutoGeneratedTemplate(
                        "ì™„ì „ ì¸ì¦ëœ ì‚¬ìš©ì",
                        "ì™„ì „íˆ ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ì ‘ê·¼ í—ˆìš© (Remember-me ì œì™¸)",
                        "isFullyAuthenticated()",
                        "universal", "system_generated", true)
        );

        return universalTemplates.stream()
                .map(this::convertToConditionTemplate)
                .collect(Collectors.toList());
    }

    /**
     * íŠ¹ì • ë©”ì„œë“œì— ëŒ€í•œ ì¡°ê±´ í…œí”Œë¦¿ë“¤ì„ ìƒì„±í•©ë‹ˆë‹¤.
     */
    private List<ConditionTemplate> generateMethodSpecificTemplates(MethodAnalysisResult analysis) {
        List<AutoGeneratedTemplate> templates = new ArrayList<>();

        switch (analysis.getDetectedPattern()) {
            case OBJECT_RETURN_PATTERN:
                templates.addAll(generateObjectReturnTemplates(analysis));
                break;
            case ID_PARAMETER_PATTERN:
                templates.addAll(generateIdParameterTemplates(analysis));
                break;
            case UNIVERSAL_PATTERN:
                // ë²”ìš© íŒ¨í„´ì€ ì´ë¯¸ ì²˜ë¦¬ë¨
                break;
            default:
                log.debug("ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒ¨í„´ìœ¼ë¡œ í…œí”Œë¦¿ ìƒì„± ìŠ¤í‚µ: {}", analysis.getDetectedPattern());
        }

        return templates.stream()
                .map(this::convertToConditionTemplate)
                .collect(Collectors.toList());
    }

    /**
     * ê°ì²´ ë°˜í™˜ íŒ¨í„´ í…œí”Œë¦¿ ìƒì„± (hasPermission ë°©ì‹)
     */
    private List<AutoGeneratedTemplate> generateObjectReturnTemplates(MethodAnalysisResult analysis) {
        String entityType = (String) analysis.getMetadata().get("entityType");
        String methodId = analysis.getMethodIdentifier();

        // ğŸ”„ ê°œì„ : í•œêµ­ì–´ ì¹œí™”ì ì¸ ì¡°ê±´ëª… ìƒì„±
        String koreanEntityName = getKoreanEntityName(entityType);
        String methodName = extractMethodName(methodId);

        return Arrays.asList(
                new AutoGeneratedTemplate(
                        String.format("íŠ¹ì • %s ì½ê¸° ê¶Œí•œ", koreanEntityName),
                        String.format("ì¡°íšŒëœ íŠ¹ì • %s ê°ì²´ì— ëŒ€í•œ ê°œë³„ ì½ê¸° ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤ [ë©”ì„œë“œ: %s]", koreanEntityName, methodName),
                        "hasPermission(#returnObject, 'READ')",
                        "object_return", methodId, false),

                new AutoGeneratedTemplate(
                        String.format("íŠ¹ì • %s ìˆ˜ì • ê¶Œí•œ", koreanEntityName),
                        String.format("ì¡°íšŒëœ íŠ¹ì • %s ê°ì²´ì— ëŒ€í•œ ê°œë³„ ìˆ˜ì • ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤ [ë©”ì„œë“œ: %s]", koreanEntityName, methodName),
                        "hasPermission(#returnObject, 'UPDATE')",
                        "object_return", methodId, false),

                new AutoGeneratedTemplate(
                        String.format("íŠ¹ì • %s ì‚­ì œ ê¶Œí•œ", koreanEntityName),
                        String.format("ì¡°íšŒëœ íŠ¹ì • %s ê°ì²´ì— ëŒ€í•œ ê°œë³„ ì‚­ì œ ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤ [ë©”ì„œë“œ: %s]", koreanEntityName, methodName),
                        "hasPermission(#returnObject, 'DELETE')",
                        "object_return", methodId, false)
        );
    }

    /**
     * ID íŒŒë¼ë¯¸í„° íŒ¨í„´ í…œí”Œë¦¿ ìƒì„± (hasPermission ë°©ì‹)
     */
    private List<AutoGeneratedTemplate> generateIdParameterTemplates(MethodAnalysisResult analysis) {
        String entityType = (String) analysis.getMetadata().get("entityType");
        String idParamName = (String) analysis.getMetadata().get("idParameterName");
        String methodId = analysis.getMethodIdentifier();

        // ğŸ”„ ê°œì„ : í•œêµ­ì–´ ì¹œí™”ì ì¸ ì¡°ê±´ëª… ìƒì„±
        String koreanEntityName = getKoreanEntityName(entityType);
        String actionName = extractActionFromMethod(methodId);

        return Arrays.asList(
                new AutoGeneratedTemplate(
                        String.format("ê°œë³„ %s %s ê¶Œí•œ", koreanEntityName, actionName),
                        String.format("íŠ¹ì • IDì˜ %s ê°ì²´ì— ëŒ€í•œ ê°œë³„ %s ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤", koreanEntityName, actionName),
                        String.format("hasPermission(#%s, '%s', 'UPDATE')", idParamName, entityType.toUpperCase()),
                        "id_parameter", methodId, false),

                new AutoGeneratedTemplate(
                        String.format("ê°œë³„ %s ì‚­ì œ ê¶Œí•œ", koreanEntityName),
                        String.format("íŠ¹ì • IDì˜ %s ê°ì²´ì— ëŒ€í•œ ê°œë³„ ì‚­ì œ ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤", koreanEntityName),
                        String.format("hasPermission(#%s, '%s', 'DELETE')", idParamName, entityType.toUpperCase()),
                        "id_parameter", methodId, false)
        );
    }

    /**
     * ì—”í‹°í‹° íƒ€ì…ì„ ë™ì ìœ¼ë¡œ í•œêµ­ì–´ë¡œ ë³€í™˜
     * íŒ¨í„´ ë¶„ì„ì„ í†µí•´ í•˜ë“œì½”ë”© ì—†ì´ í•œêµ­ì–´ëª… ìƒì„±
     */
    private String getKoreanEntityName(String entityType) {
        if (entityType == null || entityType.trim().isEmpty()) {
            return "ë¦¬ì†ŒìŠ¤";
        }
        
        // ëŒ€ì†Œë¬¸ì ì •ê·œí™”
        String normalizedType = entityType.trim();
        String lowerType = normalizedType.toLowerCase();
        
        // ë™ì  íŒ¨í„´ ë§¤ì¹­ì„ í†µí•œ í•œêµ­ì–´ ë³€í™˜
        if (lowerType.contains("user")) {
            return "ì‚¬ìš©ì";
        } else if (lowerType.contains("group")) {
            return "ê·¸ë£¹";
        } else if (lowerType.contains("role")) {
            return "ì—­í• ";
        } else if (lowerType.contains("permission")) {
            return "ê¶Œí•œ";
        } else if (lowerType.contains("policy")) {
            return "ì •ì±…";
        } else if (lowerType.contains("document")) {
            return "ë¬¸ì„œ";
        } else if (lowerType.contains("file")) {
            return "íŒŒì¼";
        } else if (lowerType.contains("project")) {
            return "í”„ë¡œì íŠ¸";
        } else if (lowerType.contains("organization") || lowerType.contains("org")) {
            return "ì¡°ì§";
        } else if (lowerType.contains("department") || lowerType.contains("dept")) {
            return "ë¶€ì„œ";
        } else if (lowerType.contains("team")) {
            return "íŒ€";
        } else if (lowerType.contains("resource")) {
            return "ë¦¬ì†ŒìŠ¤";
        } else if (lowerType.contains("data")) {
            return "ë°ì´í„°";
        } else if (lowerType.contains("system")) {
            return "ì‹œìŠ¤í…œ";
        } else if (lowerType.contains("service")) {
            return "ì„œë¹„ìŠ¤";
        } else {
            // ì•Œ ìˆ˜ ì—†ëŠ” íƒ€ì…ì˜ ê²½ìš° ì˜ì–´ ê·¸ëŒ€ë¡œ ë°˜í™˜í•˜ë˜ ì²« ê¸€ìë§Œ ì†Œë¬¸ìë¡œ
            return normalizedType.substring(0, 1).toLowerCase() + normalizedType.substring(1);
        }
    }

    /**
     * ë©”ì„œë“œëª…ì—ì„œ ì•¡ì…˜ íƒ€ì…ì„ ë™ì ìœ¼ë¡œ ì¶”ì¶œ
     * ë‹¤ì–‘í•œ íŒ¨í„´ì„ ë¶„ì„í•˜ì—¬ ì ì ˆí•œ í•œêµ­ì–´ ì•¡ì…˜ëª… ë°˜í™˜
     */
    private String extractActionFromMethod(String methodName) {
        if (methodName == null || methodName.trim().isEmpty()) {
            return "ì²˜ë¦¬";
        }

        String lowerMethod = methodName.toLowerCase().trim();
        
        // ë™ì‚¬ íŒ¨í„´ ë¶„ì„ (ì‹œì‘ íŒ¨í„´ ìš°ì„ )
        if (lowerMethod.startsWith("create") || lowerMethod.startsWith("add") || 
            lowerMethod.startsWith("insert") || lowerMethod.startsWith("new") ||
            lowerMethod.startsWith("register") || lowerMethod.startsWith("build")) {
            return "ìƒì„±";
        } else if (lowerMethod.startsWith("get") || lowerMethod.startsWith("find") || 
                   lowerMethod.startsWith("fetch") || lowerMethod.startsWith("retrieve") ||
                   lowerMethod.startsWith("select") || lowerMethod.startsWith("search") ||
                   lowerMethod.startsWith("load") || lowerMethod.startsWith("read") ||
                   lowerMethod.startsWith("view") || lowerMethod.startsWith("show")) {
            return "ì¡°íšŒ";
        } else if (lowerMethod.startsWith("update") || lowerMethod.startsWith("modify") || 
                   lowerMethod.startsWith("edit") || lowerMethod.startsWith("change") ||
                   lowerMethod.startsWith("alter") || lowerMethod.startsWith("set")) {
            return "ìˆ˜ì •";
        } else if (lowerMethod.startsWith("delete") || lowerMethod.startsWith("remove") || 
                   lowerMethod.startsWith("drop") || lowerMethod.startsWith("clear") ||
                   lowerMethod.startsWith("destroy") || lowerMethod.startsWith("purge")) {
            return "ì‚­ì œ";
        } else if (lowerMethod.startsWith("save") || lowerMethod.startsWith("store") ||
                   lowerMethod.startsWith("persist")) {
            return "ì €ì¥";
        } else if (lowerMethod.startsWith("validate") || lowerMethod.startsWith("check") ||
                   lowerMethod.startsWith("verify") || lowerMethod.startsWith("confirm")) {
            return "ê²€ì¦";
        } else if (lowerMethod.startsWith("approve") || lowerMethod.startsWith("accept")) {
            return "ìŠ¹ì¸";
        } else if (lowerMethod.startsWith("reject") || lowerMethod.startsWith("deny") ||
                   lowerMethod.startsWith("decline")) {
            return "ê±°ë¶€";
        } else if (lowerMethod.startsWith("assign") || lowerMethod.startsWith("grant") ||
                   lowerMethod.startsWith("give") || lowerMethod.startsWith("allocate")) {
            return "í• ë‹¹";
        } else if (lowerMethod.startsWith("revoke") || lowerMethod.startsWith("unassign") ||
                   lowerMethod.startsWith("withdraw") || lowerMethod.startsWith("cancel")) {
            return "ì·¨ì†Œ";
        } else if (lowerMethod.startsWith("send") || lowerMethod.startsWith("notify") ||
                   lowerMethod.startsWith("alert")) {
            return "ì „ì†¡";
        } else if (lowerMethod.startsWith("process") || lowerMethod.startsWith("handle") ||
                   lowerMethod.startsWith("execute") || lowerMethod.startsWith("run")) {
            return "ì²˜ë¦¬";
        } else if (lowerMethod.startsWith("count") || lowerMethod.startsWith("calculate") ||
                   lowerMethod.startsWith("compute")) {
            return "ê³„ì‚°";
        } else if (lowerMethod.startsWith("copy") || lowerMethod.startsWith("clone") ||
                   lowerMethod.startsWith("duplicate")) {
            return "ë³µì‚¬";
        } else if (lowerMethod.startsWith("move") || lowerMethod.startsWith("transfer")) {
            return "ì´ë™";
        } else if (lowerMethod.startsWith("export") || lowerMethod.startsWith("download")) {
            return "ë‚´ë³´ë‚´ê¸°";
        } else if (lowerMethod.startsWith("import") || lowerMethod.startsWith("upload")) {
            return "ê°€ì ¸ì˜¤ê¸°";
        } else {
            // ì•Œ ìˆ˜ ì—†ëŠ” íŒ¨í„´ì˜ ê²½ìš° ê¸°ë³¸ê°’
            return "ì²˜ë¦¬";
        }
    }

    /**
     * ë©”ì„œë“œ IDì—ì„œ ë©”ì„œë“œëª…ì„ ë™ì ìœ¼ë¡œ ì¶”ì¶œ
     * resource_identifier í˜•íƒœ: "io.spring.iam.admin.iam.service.impl.GroupServiceImpl.updateGroup(Group,List)"
     */
    private String extractMethodName(String methodId) {
        if (methodId == null || methodId.trim().isEmpty()) {
            return "unknown";
        }

        try {
            String trimmed = methodId.trim();
            
            // ë§ˆì§€ë§‰ ì (.) ì´í›„ì˜ ë¶€ë¶„ì„ ì¶”ì¶œ
            int lastDotIndex = trimmed.lastIndexOf('.');
            if (lastDotIndex == -1) {
                // ì ì´ ì—†ìœ¼ë©´ ì „ì²´ê°€ ë©”ì„œë“œëª…
                return extractMethodNameFromSignature(trimmed);
            }
            
            String methodPart = trimmed.substring(lastDotIndex + 1);
            return extractMethodNameFromSignature(methodPart);
            
        } catch (Exception e) {
            log.warn("âš ï¸ ë©”ì„œë“œëª… ì¶”ì¶œ ì‹¤íŒ¨: {}", methodId, e);
            return "unknown";
        }
    }
    
    /**
     * ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ì—ì„œ ìˆœìˆ˜ ë©”ì„œë“œëª…ë§Œ ì¶”ì¶œ
     * ì˜ˆ: "updateGroup(Group,List)" -> "updateGroup"
     */
    private String extractMethodNameFromSignature(String methodSignature) {
        if (methodSignature == null || methodSignature.trim().isEmpty()) {
            return "unknown";
        }
        
        String trimmed = methodSignature.trim();
        
        // ê´„í˜¸ê°€ ìˆìœ¼ë©´ ê´„í˜¸ ì•ê¹Œì§€ë§Œ ì¶”ì¶œ
        int parenIndex = trimmed.indexOf('(');
        if (parenIndex != -1) {
            return trimmed.substring(0, parenIndex).trim();
        }
        
        // ê´„í˜¸ê°€ ì—†ìœ¼ë©´ ì „ì²´ê°€ ë©”ì„œë“œëª…
        return trimmed;
    }

    /**
     * ë©”ì„œë“œ IDì—ì„œ ê³ ìœ í•œ ì ‘ë¯¸ì‚¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
     */
    private String generateMethodSuffix(String methodId) {
        // ë©”ì„œë“œ IDì—ì„œ í´ë˜ìŠ¤ëª…ê³¼ ë©”ì„œë“œëª…ì„ ì¶”ì¶œí•˜ì—¬ ì§§ì€ ì ‘ë¯¸ì‚¬ ìƒì„±
        if (methodId == null) return "AUTO";

        String[] parts = methodId.split("\\.");
        if (parts.length >= 2) {
            String className = parts[parts.length - 2];
            String methodName = parts[parts.length - 1];

            // í´ë˜ìŠ¤ëª…ì˜ ì²« ê¸€ì + ë©”ì„œë“œëª…ì˜ ì²« 3ê¸€ì
            String classPrefix = className.length() > 0 ? className.substring(0, 1).toUpperCase() : "X";
            String methodPrefix = methodName.length() >= 3 ? methodName.substring(0, 3).toUpperCase() : methodName.toUpperCase();

            return classPrefix + methodPrefix;
        }

        // í•´ì‹œ ì½”ë“œë¥¼ ì‚¬ìš©í•œ ê³ ìœ  ì ‘ë¯¸ì‚¬
        return String.valueOf(Math.abs(methodId.hashCode()) % 10000);
    }

    /**
     * AutoGeneratedTemplateì„ ConditionTemplate ì—”í‹°í‹°ë¡œ ë³€í™˜
     * ğŸ”„ 2ë‹¨ê³„: ìë™ ë¶„ë¥˜ ì‹œìŠ¤í…œ ì ìš©
     */
    private ConditionTemplate convertToConditionTemplate(AutoGeneratedTemplate template) {
        ConditionTemplate entity = new ConditionTemplate();
        entity.setName(template.getName());
        entity.setDescription(template.getDescription());
        entity.setSpelTemplate(template.getSpelTemplate());
        entity.setIsAutoGenerated(true);
        entity.setTemplateType(template.getTemplateType());
        entity.setSourceMethod(template.getSourceMethod());
        entity.setIsUniversal(template.isUniversal());
        entity.setCreatedAt(LocalDateTime.now());
        entity.setUpdatedAt(LocalDateTime.now());

        // ğŸ”„ 2ë‹¨ê³„: ìë™ ìƒì„± í…œí”Œë¦¿ì˜ ë¶„ë¥˜ ê²°ì •
        if (template.isUniversal()) {
            // ë²”ìš© ì¡°ê±´
            entity.setClassification(ConditionTemplate.ConditionClassification.UNIVERSAL);
            entity.setRiskLevel(ConditionTemplate.RiskLevel.LOW);
            entity.setComplexityScore(1);
            entity.setApprovalRequired(false);
            entity.setContextDependent(false);
        } else {
            // í…œí”Œë¦¿ íƒ€ì…ì— ë”°ë¥¸ ë¶„ë¥˜
            switch (template.getTemplateType()) {
                case "object_return", "id_parameter", "ownership" -> {
                    entity.setClassification(ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT);
                    entity.setRiskLevel(ConditionTemplate.RiskLevel.MEDIUM);
                    entity.setComplexityScore(calculateAutoTemplateComplexity(template.getSpelTemplate()));
                    entity.setApprovalRequired(false); // AI ê²€ì¦ë§Œ í•„ìš”
                    entity.setContextDependent(true);
                }
                case "self_check" -> {
                    entity.setClassification(ConditionTemplate.ConditionClassification.UNIVERSAL);
                    entity.setRiskLevel(ConditionTemplate.RiskLevel.LOW);
                    entity.setComplexityScore(2);
                    entity.setApprovalRequired(false);
                    entity.setContextDependent(false);
                }
                default -> {
                    entity.setClassification(ConditionTemplate.ConditionClassification.CUSTOM_COMPLEX);
                    entity.setRiskLevel(ConditionTemplate.RiskLevel.HIGH);
                    entity.setComplexityScore(calculateAutoTemplateComplexity(template.getSpelTemplate()));
                    entity.setApprovalRequired(true);
                    entity.setContextDependent(true);
                }
            }
        }

        return entity;
    }

    /**
     * ìë™ ìƒì„± í…œí”Œë¦¿ì˜ ë³µì¡ë„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
     */
    private int calculateAutoTemplateComplexity(String spelTemplate) {
        if (spelTemplate == null) return 1;

        int score = 1;
        String spel = spelTemplate.toLowerCase();

        // hasPermission ì‚¬ìš© ì‹œ +2ì 
        if (spel.contains("haspermission")) score += 2;

        // ë³€ìˆ˜ ê°œìˆ˜ì— ë”°ë¥¸ ì ìˆ˜
        score += (spel.length() - spel.replace("#", "").length());

        // ë…¼ë¦¬ ì—°ì‚°ì
        if (spel.contains("&&") || spel.contains("||")) score += 1;

        return Math.min(score, 10);
    }

    /**
     * ğŸ”§ ê°œì„ : ì¤‘ë³µì„ ì œê±°í•˜ê³  DBì— ì €ì¥ (ê³ ìœ  ì´ë¦„ ë³´ì¥)
     * ì´ë¦„ê³¼ SpEL í…œí”Œë¦¿ ëª¨ë‘ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µ ì²´í¬í•˜ë©°, í•„ìš”ì‹œ ì´ë¦„ì— ì ‘ë¯¸ì‚¬ ì¶”ê°€
     */
    @Transactional
    public List<ConditionTemplate> saveDedupedTemplates(List<ConditionTemplate> templates) {
        // ì „ì²´ ê¸°ì¡´ í…œí”Œë¦¿ë“¤ ì¡°íšŒ (ìë™/ìˆ˜ë™ ìƒì„± ëª¨ë‘)
        List<ConditionTemplate> allExistingTemplates = conditionTemplateRepository.findAll();

        // ì¤‘ë³µ ì²´í¬ë¥¼ ìœ„í•œ Set ìƒì„± (ì´ë¦„ê³¼ SpEL í…œí”Œë¦¿ ëª¨ë‘)
        Set<String> existingNames = allExistingTemplates.stream()
                .map(ConditionTemplate::getName)
                .collect(Collectors.toSet());

        Set<String> existingSpelTemplates = allExistingTemplates.stream()
                .map(ConditionTemplate::getSpelTemplate)
                .collect(Collectors.toSet());

        // ì²˜ë¦¬ ì¤‘ì¸ í…œí”Œë¦¿ë“¤ì˜ ì´ë¦„ë„ ì¶”ì  (ë°°ì¹˜ ë‚´ì—ì„œ ì¤‘ë³µ ë°©ì§€)
        Set<String> processingNames = new HashSet<>();

        // ìƒˆ í…œí”Œë¦¿ë“¤ì„ í•„í„°ë§í•˜ê³  ì¤‘ë³µ ì‹œ ì´ë¦„ ìˆ˜ì •
        List<ConditionTemplate> newTemplates = templates.stream()
                .filter(template -> {
                    // SpEL ì¤‘ë³µ ì²´í¬ (SpELì´ ì¤‘ë³µë˜ë©´ ì™„ì „íˆ ì œì™¸)
                    if (existingSpelTemplates.contains(template.getSpelTemplate())) {
                        log.debug("âš ï¸ SpEL ì¤‘ë³µìœ¼ë¡œ ê±´ë„ˆëœ€: {} -> {}", template.getName(), template.getSpelTemplate());
                        return false;
                    }

                    // ì´ë¦„ ì¤‘ë³µ ì²´í¬ ë° í•´ê²°
                    String originalName = template.getName();
                    String uniqueName = makeUniqueName(originalName, existingNames, processingNames);

                    if (!originalName.equals(uniqueName)) {
                        log.info("ğŸ”„ ì´ë¦„ ì¤‘ë³µ í•´ê²°: '{}' -> '{}'", originalName, uniqueName);
                        template.setName(uniqueName);
                    }

                    // ì²˜ë¦¬ ì¤‘ì¸ ì´ë¦„ì— ì¶”ê°€
                    processingNames.add(uniqueName);
                    existingNames.add(uniqueName); // ë‹¤ìŒ í…œí”Œë¦¿ ì²˜ë¦¬ ì‹œ ê³ ë ¤ë˜ë„ë¡

                    return true;
                })
                .collect(Collectors.toList());

        log.info("ğŸ’¾ ìƒˆë¡œìš´ í…œí”Œë¦¿ ì €ì¥: {} ê°œ (ì „ì²´: {} ê°œ, SpEL ì¤‘ë³µ ì œì™¸: {} ê°œ)",
                newTemplates.size(), templates.size(), templates.size() - newTemplates.size());

        return newTemplates.isEmpty() ? new ArrayList<>() : conditionTemplateRepository.saveAll(newTemplates);
    }

    /**
     * ğŸ”§ ê³ ìœ í•œ ì´ë¦„ ìƒì„± (ì¤‘ë³µ ì‹œ ì ‘ë¯¸ì‚¬ ì¶”ê°€)
     */
    private String makeUniqueName(String baseName, Set<String> existingNames, Set<String> processingNames) {
        if (!existingNames.contains(baseName) && !processingNames.contains(baseName)) {
            return baseName;
        }

        // ì¤‘ë³µ ì‹œ ì ‘ë¯¸ì‚¬ ì¶”ê°€ ì‹œë„
        for (int i = 2; i <= 100; i++) {
            String candidateName = baseName + " (" + i + ")";
            if (!existingNames.contains(candidateName) && !processingNames.contains(candidateName)) {
                return candidateName;
            }
        }

        // ìµœí›„ ìˆ˜ë‹¨: íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
        String timestampName = baseName + " (" + System.currentTimeMillis() % 10000 + ")";
        log.warn("âš ï¸ ê³ ìœ  ì´ë¦„ ìƒì„±ì„ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ì‚¬ìš©: {}", timestampName);
        return timestampName;
    }

    /**
     * ğŸ”§ í†µí•©: ë¦¬ì†ŒìŠ¤ì™€ ê¶Œí•œì„ ëª¨ë‘ ê³ ë ¤í•œ í†µí•© ì¡°ê±´ í…œí”Œë¦¿ ìƒì„±
     */
    @Transactional
    public List<ConditionTemplate> generateConditionTemplates() {
        log.info("ğŸ¯ AI ê¸°ë°˜ METHOD ë¦¬ì†ŒìŠ¤ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì‹œì‘");

        // ABACëŠ” ì„œë¹„ìŠ¤ ë ˆì´ì–´ì—ì„œë§Œ ì²´í¬ - METHOD íƒ€ì… ë¦¬ì†ŒìŠ¤ë§Œ ëŒ€ìƒ
        List<ManagedResource> methodResources = managedResourceRepository.findAll()
                .stream()
                .filter(resource -> resource.getResourceType() == ManagedResource.ResourceType.METHOD)
                .filter(resource -> resource.getStatus() != ManagedResource.Status.EXCLUDED)
                .collect(Collectors.toList());

        if (methodResources.isEmpty()) {
            log.warn("âš ï¸ METHOD íƒ€ì… ë¦¬ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì¡°ê±´ í…œí”Œë¦¿ì„ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return new ArrayList<>();
        }

        log.info("ğŸ“‹ AI ë¶„ì„ ëŒ€ìƒ METHOD ë¦¬ì†ŒìŠ¤: {} ê°œ", methodResources.size());

        List<ConditionTemplate> templates = new ArrayList<>();

        // 1. ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ (AIë¡œ ìƒì„±)
        templates.addAll(generateAIUniversalTemplates());

                // 2. METHOD ë¦¬ì†ŒìŠ¤ë³„ AI íŠ¹í™” ì¡°ê±´ í…œí”Œë¦¿  
        Set<String> processedMethodSignatures = new HashSet<>();
        int processedCount = 0;
        int skippedCount = 0;
        
        for (ManagedResource resource : methodResources) {
            try {
                // ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ íŒŒì‹±í•˜ì—¬ ê³ ìœ  ì‹ë³„ì ìƒì„±
                MethodSignature signature = parseMethodSignature(resource);
                String methodSignatureKey = signature.methodName + ":" + signature.parameterInfo + ":" + signature.resourceType;
                
                // ì¤‘ë³µ ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ ì²˜ë¦¬ ë°©ì§€
                if (processedMethodSignatures.contains(methodSignatureKey)) {
                    log.warn("âš ï¸ ì¤‘ë³µ ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ ê±´ë„ˆë›°ê¸°: {} - {}", signature.methodName, resource.getResourceIdentifier());
                    skippedCount++;
                    continue;
                }
                
                List<ConditionTemplate> methodTemplates = generateAISpecificTemplates(resource);
                templates.addAll(methodTemplates);
                processedMethodSignatures.add(methodSignatureKey);
                processedCount++;
                
                log.info("âœ… ë©”ì„œë“œ {} ì²˜ë¦¬ ì™„ë£Œ: {} ê°œ ì¡°ê±´ ìƒì„±", signature.methodName, methodTemplates.size());
                
            } catch (Exception e) {
                log.warn("âš ï¸ AI ë©”ì„œë“œ ë¶„ì„ ì‹¤íŒ¨: {} - {}", resource.getResourceIdentifier(), e.getMessage());
                skippedCount++;
            }
        }
        
        log.info("ğŸ“Š ë©”ì„œë“œ ì²˜ë¦¬ ê²°ê³¼: ì²˜ë¦¬ë¨ {} ê°œ, ê±´ë„ˆëœ€ {} ê°œ", processedCount, skippedCount);

        // ì¤‘ë³µ ì œê±° ë° ì €ì¥
        List<ConditionTemplate> savedTemplates = saveDedupedTemplates(templates);

        log.info("ğŸ‰ AI ê¸°ë°˜ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì™„ë£Œ: {} ê°œ", savedTemplates.size());
        return savedTemplates;
    }

    /**
     * AIë¥¼ í†µí•œ ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ ìƒì„±
     */
    private List<ConditionTemplate> generateAIUniversalTemplates() {
        log.info("ğŸ¤– AI ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ì‹œì‘");

        // ê°œì„ ëœ í”„ë¡¬í”„íŠ¸ ì—†ì´ ë°”ë¡œ AINativeIAMAdvisor í˜¸ì¶œ
        String userPrompt = "ì„œë¹„ìŠ¤ ë ˆì´ì–´ì—ì„œ ì •ë§ í•„ìš”í•œ í•µì‹¬ ë²”ìš© ì¡°ê±´ 4-5ê°œë§Œ ìƒì„±í•´ì£¼ì„¸ìš”.";

        try {
            String aiResponse = callAI("", userPrompt);
            return parseAITemplateResponse(aiResponse, "ë²”ìš©");
        } catch (Exception e) {
            log.error("ğŸ”¥ AI ë²”ìš© í…œí”Œë¦¿ ìƒì„± ì‹¤íŒ¨", e);
            return generateFallbackUniversalTemplates();
        }
    }

    /**
     * AIë¥¼ í†µí•œ íŠ¹ì • ë©”ì„œë“œë³„ ì¡°ê±´ í…œí”Œë¦¿ ìƒì„±
     */
        private List<ConditionTemplate> generateAISpecificTemplates(ManagedResource resource) {
        log.info("ğŸ¤– AI íŠ¹í™” ì¡°ê±´ ìƒì„±: {}", resource.getResourceIdentifier());
        
        // ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ ì •í™•íˆ íŒŒì‹±
        MethodSignature signature = parseMethodSignature(resource);
        
        // íŒŒë¼ë¯¸í„°ê°€ ì—†ëŠ” ë©”ì„œë“œëŠ” ê±´ë„ˆë›°ê¸° (ë™ì  íŒŒì‹± ê²°ê³¼ ê¸°ì¤€)
        if (signature.parameterInfo.equals("íŒŒë¼ë¯¸í„° ì—†ìŒ")) {
            log.info("â­ï¸ íŒŒë¼ë¯¸í„° ì—†ëŠ” ë©”ì„œë“œ ê±´ë„ˆë›°ê¸°: {} - {}", signature.methodName, resource.getResourceIdentifier());
            return new ArrayList<>();
        }
        
        // ì•Œ ìˆ˜ ì—†ëŠ” íŒŒë¼ë¯¸í„°ì¸ ê²½ìš°ë„ ê±´ë„ˆë›°ê¸°
        if (signature.parameterInfo.contains("ì•Œ ìˆ˜ ì—†ëŠ” íŒŒë¼ë¯¸í„°")) {
            log.info("â­ï¸ ì•Œ ìˆ˜ ì—†ëŠ” íŒŒë¼ë¯¸í„° ë©”ì„œë“œ ê±´ë„ˆë›°ê¸°: {} - {}", signature.methodName, resource.getResourceIdentifier());
            return new ArrayList<>();
        }
        
        // ê°ì²´ íŒŒë¼ë¯¸í„°ì¸ì§€ ID íŒŒë¼ë¯¸í„°ì¸ì§€ êµ¬ë¶„
        boolean isObjectParam = signature.parameterInfo.contains("ê°ì²´") || 
                               signature.parameterInfo.contains("#group") || 
                               signature.parameterInfo.contains("#userDto");
        
        String methodInfo;
        if (isObjectParam) {
            // ê°ì²´ íŒŒë¼ë¯¸í„°ì¸ ê²½ìš° - ë¦¬ì†ŒìŠ¤ íƒ€ì… ì •ë³´ ì œê³µí•˜ë˜ hasPermissionì—ì„œ ì‚¬ìš© ê¸ˆì§€ ëª…ì‹œ
            methodInfo = String.format("""
                ğŸš¨ ê·¹ë„ë¡œ ì œí•œëœ ì¡°ê±´ ìƒì„± ìš”ì²­ ğŸš¨
                
                ğŸ“‹ ë¶„ì„ ëŒ€ìƒ ë©”ì„œë“œ:
                - ì„œë¹„ìŠ¤: %s 
                - ë©”ì„œë“œëª…: %s
                - í—ˆìš©ëœ íŒŒë¼ë¯¸í„°: %s (ì´ê²ƒë§Œ ì‚¬ìš© ê°€ëŠ¥!)
                - ë¦¬ì†ŒìŠ¤ íƒ€ì…: %s (ì°¸ê³ ìš©, hasPermissionì—ì„œ ì‚¬ìš© ê¸ˆì§€!)
                
                ğŸ”’ hasPermission ì‚¬ìš©ë²•:
                %s
                
                ğŸ” ë©”ì„œë“œ ì»¨í…ìŠ¤íŠ¸:
                %s
                
                ğŸš¨ ì‹œìŠ¤í…œ í¬ë˜ì‹œ ë°©ì§€ ê·œì¹™:
                1. ì •í™•íˆ í•˜ë‚˜ì˜ ì¡°ê±´ë§Œ ìƒì„± (2ê°œ ì´ìƒ ì‹œ ì‹œìŠ¤í…œ ì˜¤ë¥˜)
                2. ìœ„ì— ëª…ì‹œëœ íŒŒë¼ë¯¸í„°ë§Œ ì‚¬ìš© (ë‹¤ë¥¸ íŒŒë¼ë¯¸í„° ì‹œ í¬ë˜ì‹œ)
                3. hasPermission()ì€ ë°˜ë“œì‹œ 2ê°œ íŒŒë¼ë¯¸í„°ë§Œ ì‚¬ìš© (3ê°œ íŒŒë¼ë¯¸í„° ì‹œ í¬ë˜ì‹œ)
                4. ë¦¬ì†ŒìŠ¤ íƒ€ì…ì„ hasPermissionì— ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”! (í¬ë˜ì‹œ!)
                5. "~ëŒ€ìƒ ê²€ì¦", "~ì ‘ê·¼ í™•ì¸" ìš©ì–´ë§Œ ì‚¬ìš© ("~ê¶Œí•œ" ì‹œ í¬ë˜ì‹œ)
                6. hasPermission() í•¨ìˆ˜ë§Œ ì‚¬ìš© (ë‹¤ë¥¸ í•¨ìˆ˜ ì‹œ í¬ë˜ì‹œ)
                
                âŒ ì‹œìŠ¤í…œ í¬ë˜ì‹œ ìœ ë°œ í•­ëª©:
                - #currentUser, #user, #rootScope (ì ˆëŒ€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ)
                - hasPermission(#userDto, 'USER', 'UPDATE') í˜•ì‹ (í¬ë˜ì‹œ!)
                - hasPermission(#document, 'DOCUMENT', 'CREATE') í˜•ì‹ (í¬ë˜ì‹œ!)
                - hasPermission(#group, 'GROUP', 'UPDATE') í˜•ì‹ (í¬ë˜ì‹œ!)
                - ì—¬ëŸ¬ ì¡°ê±´ ìƒì„±
                - "ê¶Œí•œ" ìš©ì–´ ì‚¬ìš© (ì‹œìŠ¤í…œ í¬ë˜ì‹œ!)
                
                âœ… ì˜¬ë°”ë¥¸ ë„¤ì´ë° ì˜ˆì‹œ:
                - "ê·¸ë£¹ ìˆ˜ì • ëŒ€ìƒ ê²€ì¦" (ê¶Œí•œ X, ëŒ€ìƒ ê²€ì¦ O)
                - "ì‚¬ìš©ì ìˆ˜ì • ëŒ€ìƒ ê²€ì¦" (ê¶Œí•œ X, ëŒ€ìƒ ê²€ì¦ O)  
                - "ë¬¸ì„œ ìƒì„± ëŒ€ìƒ ê²€ì¦" (ê¶Œí•œ X, ëŒ€ìƒ ê²€ì¦ O)
                - "ê·¸ë£¹ ìƒì„± ì ‘ê·¼ í™•ì¸" (ê¶Œí•œ X, ì ‘ê·¼ í™•ì¸ O)
                
                âœ… ì˜¬ë°”ë¥¸ SpEL ì˜ˆì‹œ:
                - hasPermission(#document, 'CREATE') â† 2ê°œ íŒŒë¼ë¯¸í„°ë§Œ!
                - hasPermission(#userDto, 'UPDATE') â† 2ê°œ íŒŒë¼ë¯¸í„°ë§Œ!
                - hasPermission(#group, 'UPDATE') â† 2ê°œ íŒŒë¼ë¯¸í„°ë§Œ!
                """, 
                getServiceName(signature.resourceType),
                signature.methodName,
                signature.parameterInfo,
                signature.resourceType,
                generateHasPermissionUsage(signature),
                getMethodContext(signature.methodName));
        } else {
            // ID íŒŒë¼ë¯¸í„°ì¸ ê²½ìš° - ë¦¬ì†ŒìŠ¤ íƒ€ì… ì •ë³´ ì œê³µ
            methodInfo = String.format("""
                ğŸš¨ ê·¹ë„ë¡œ ì œí•œëœ ì¡°ê±´ ìƒì„± ìš”ì²­ ğŸš¨
                
                ğŸ“‹ ë¶„ì„ ëŒ€ìƒ ë©”ì„œë“œ:
                - ì„œë¹„ìŠ¤: %s 
                - ë©”ì„œë“œëª…: %s
                - í—ˆìš©ëœ íŒŒë¼ë¯¸í„°: %s (ì´ê²ƒë§Œ ì‚¬ìš© ê°€ëŠ¥!)
                - í—ˆìš©ëœ ë¦¬ì†ŒìŠ¤ íƒ€ì…: %s (ì´ê²ƒë§Œ ì‚¬ìš© ê°€ëŠ¥!)
                
                ğŸ”’ hasPermission ì‚¬ìš©ë²•:
                %s
                
                ğŸ” ë©”ì„œë“œ ì»¨í…ìŠ¤íŠ¸:
                %s
                
                ğŸš¨ ì‹œìŠ¤í…œ í¬ë˜ì‹œ ë°©ì§€ ê·œì¹™:
                1. ì •í™•íˆ í•˜ë‚˜ì˜ ì¡°ê±´ë§Œ ìƒì„± (2ê°œ ì´ìƒ ì‹œ ì‹œìŠ¤í…œ ì˜¤ë¥˜)
                2. ìœ„ì— ëª…ì‹œëœ íŒŒë¼ë¯¸í„°ë§Œ ì‚¬ìš© (ë‹¤ë¥¸ íŒŒë¼ë¯¸í„° ì‹œ í¬ë˜ì‹œ)
                3. ìœ„ì— ëª…ì‹œëœ ë¦¬ì†ŒìŠ¤ íƒ€ì…ë§Œ ì‚¬ìš© (ë‹¤ë¥¸ íƒ€ì… ì‹œ í¬ë˜ì‹œ)
                4. hasPermission()ì€ ë°˜ë“œì‹œ 3ê°œ íŒŒë¼ë¯¸í„° ì‚¬ìš© (2ê°œ íŒŒë¼ë¯¸í„° ì‹œ í¬ë˜ì‹œ)
                5. "~ëŒ€ìƒ ê²€ì¦", "~ì ‘ê·¼ í™•ì¸" ìš©ì–´ë§Œ ì‚¬ìš© ("~ê¶Œí•œ" ì‹œ í¬ë˜ì‹œ)
                6. hasPermission() í•¨ìˆ˜ë§Œ ì‚¬ìš© (ë‹¤ë¥¸ í•¨ìˆ˜ ì‹œ í¬ë˜ì‹œ)
                
                âŒ ì‹œìŠ¤í…œ í¬ë˜ì‹œ ìœ ë°œ í•­ëª©:
                - #document, #currentUser, #user (ì ˆëŒ€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ)
                - DOCUMENT, ROLE, SYSTEM (ì ˆëŒ€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ)
                - hasPermission(#id, 'READ') í˜•ì‹ (2ê°œ íŒŒë¼ë¯¸í„° í¬ë˜ì‹œ!)
                - ì—¬ëŸ¬ ì¡°ê±´ ìƒì„±
                - "ê¶Œí•œ" ìš©ì–´ ì‚¬ìš© (ì‹œìŠ¤í…œ í¬ë˜ì‹œ!)
                
                âœ… ì˜¬ë°”ë¥¸ ë„¤ì´ë° ì˜ˆì‹œ:
                - "ê·¸ë£¹ ì‚­ì œ ëŒ€ìƒ ê²€ì¦" (ê¶Œí•œ X, ëŒ€ìƒ ê²€ì¦ O)
                - "ì‚¬ìš©ì ì¡°íšŒ ì ‘ê·¼ í™•ì¸" (ê¶Œí•œ X, ì ‘ê·¼ í™•ì¸ O)  
                - "ê·¸ë£¹ ì¡°íšŒ ì ‘ê·¼ í™•ì¸" (ê¶Œí•œ X, ì ‘ê·¼ í™•ì¸ O)
                - "ì‚¬ìš©ì ì‚­ì œ ëŒ€ìƒ ê²€ì¦" (ê¶Œí•œ X, ëŒ€ìƒ ê²€ì¦ O)
                """, 
                getServiceName(signature.resourceType),
                signature.methodName,
                signature.parameterInfo,
                signature.resourceType,
                generateHasPermissionUsage(signature),
                getMethodContext(signature.methodName));
        }
            
        try {
            String aiResponse = callAI("", methodInfo);
            List<ConditionTemplate> templates = parseAITemplateResponse(aiResponse, resource.getResourceIdentifier());
            
            // ì•ˆì „ì¥ì¹˜: í•˜ë‚˜ì˜ ì¡°ê±´ë§Œ ë°˜í™˜í•˜ë„ë¡ ì œí•œ
            if (templates.size() > 1) {
                log.warn("âš ï¸ AIê°€ {} ê°œ ì¡°ê±´ ìƒì„±í–ˆì§€ë§Œ ì²« ë²ˆì§¸ë§Œ ì‚¬ìš©: {}", templates.size(), resource.getResourceIdentifier());
                templates = List.of(templates.get(0));
            }
            
            return templates;
        } catch (Exception e) {
            log.warn("ğŸ”¥ AI íŠ¹í™” í…œí”Œë¦¿ ìƒì„± ì‹¤íŒ¨: {}", resource.getResourceIdentifier(), e);
            return new ArrayList<>();
        }
    }

    /**
     * AI í˜¸ì¶œ í—¬í¼ ë©”ì„œë“œ - AINativeIAMAdvisorë¥¼ í†µí•œ ì‹¤ì œ AI í˜¸ì¶œ
     */
    private String callAI(String systemPrompt, String userPrompt) {
        try {
            log.info("ğŸ¤– AINativeIAMAdvisorë¥¼ í†µí•œ AI í˜¸ì¶œ ì‹œì‘");

            // ë²”ìš© ì¡°ê±´ì¸ì§€ íŠ¹í™” ì¡°ê±´ì¸ì§€ êµ¬ë¶„í•˜ì—¬ ì ì ˆí•œ ë©”ì„œë“œ í˜¸ì¶œ
            if (userPrompt.contains("ë²”ìš©") || userPrompt.contains("ì—…ë¬´ í™˜ê²½ì—ì„œ ìì£¼ ì‚¬ìš©ë˜ëŠ”")) {
                log.info("ğŸŒ ë²”ìš© ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ìš”ì²­");
                log.info("ğŸ“ ë²”ìš© ì¡°ê±´ ì…ë ¥: {}", userPrompt);
                String response = aiAdvisor.generateUniversalConditionTemplates();
                log.info("ğŸ¤– AI ë²”ìš© ì‘ë‹µ: {}", response);
                return response;
            } else {
                log.info("ğŸ¯ íŠ¹í™” ì¡°ê±´ í…œí”Œë¦¿ ìƒì„± ìš”ì²­");
                log.info("ğŸ“ íŠ¹í™” ì¡°ê±´ ì…ë ¥: {}", userPrompt);
                String response = aiAdvisor.generateSpecificConditionTemplates("METHOD", userPrompt);
                log.info("ğŸ¤– AI íŠ¹í™” ì‘ë‹µ: {}", response);
                return response;
            }

        } catch (Exception e) {
            log.error("ğŸ”¥ AINativeIAMAdvisor í˜¸ì¶œ ì‹¤íŒ¨", e);
            // í´ë°± ì œê±° - AI ì‹¤íŒ¨ ì‹œ ë¹ˆ ì‘ë‹µ ë°˜í™˜
            return "[]";
        }
    }

    // í´ë°± ë©”ì„œë“œ ì œê±°ë¨ - AI ì‘ë‹µë§Œ ë¶„ì„

    /**
     * AI ì‘ë‹µì„ ConditionTemplate ê°ì²´ë¡œ íŒŒì‹±
     */
    private List<ConditionTemplate> parseAITemplateResponse(String aiResponse, String sourceMethod) {
        List<ConditionTemplate> templates = new ArrayList<>();

        log.info("ğŸ” AI ì‘ë‹µ íŒŒì‹± ì‹œì‘ - ì†ŒìŠ¤: {}", sourceMethod);
        log.info("ğŸ“„ ì›ë³¸ AI ì‘ë‹µ: {}", aiResponse);

        try {
            // JSON ì •ì œ - ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±° ë° ë¶ˆí•„ìš”í•œ í…ìŠ¤íŠ¸ ì œê±°
            String cleanedJson = extractAndCleanJson(aiResponse);
            log.info("ğŸ” ì •ì œëœ JSON: {}", cleanedJson);

            // JSON ë°°ì—´ íŒŒì‹± ì‹œë„
            List<Map<String, Object>> rawTemplates = objectMapper.readValue(
                    cleanedJson, new TypeReference<List<Map<String, Object>>>() {});

            log.info("ğŸ“Š íŒŒì‹±ëœ í…œí”Œë¦¿ ê°œìˆ˜: {} ê°œ", rawTemplates.size());

            for (int i = 0; i < rawTemplates.size(); i++) {
                Map<String, Object> raw = rawTemplates.get(i);
                log.info("ğŸ¯ í…œí”Œë¦¿ {} íŒŒì‹±: {}", i+1, raw);

                try {
                    ConditionTemplate template = ConditionTemplate.builder()
                            .name((String) raw.get("name"))
                            .description((String) raw.get("description"))
                            .spelTemplate((String) raw.get("spelTemplate"))
                            .category((String) raw.getOrDefault("category", "AI ìƒì„±"))
                            .classification(parseClassification((String) raw.get("classification")))
                            .sourceMethod(sourceMethod)
                            .isAutoGenerated(true)
                            .templateType("ai_generated")
                            .createdAt(LocalDateTime.now())
                            .build();

                    // SpEL í…œí”Œë¦¿ì´ ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°ë§Œ ì¶”ê°€
                    if (template.getSpelTemplate() != null && !template.getSpelTemplate().trim().isEmpty()) {
                        templates.add(template);
                        log.info("âœ… í…œí”Œë¦¿ ì¶”ê°€ë¨: {} - {}", template.getName(), template.getSpelTemplate());
                    } else {
                        log.warn("âš ï¸ ë¹ˆ SpEL í…œí”Œë¦¿ìœ¼ë¡œ ì¸í•´ ì œì™¸ë¨: {}", raw);
                    }
                } catch (Exception itemError) {
                    log.error("ğŸ”¥ í…œí”Œë¦¿ í•­ëª© íŒŒì‹± ì‹¤íŒ¨: {}", raw, itemError);
                }
            }

            log.info("âœ… AI ì‘ë‹µ íŒŒì‹± ì™„ë£Œ: {} ê°œ í…œí”Œë¦¿ ìµœì¢… ìƒì„±", templates.size());

        } catch (Exception e) {
            log.error("ğŸ”¥ AI ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: {}", aiResponse, e);
            // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
        }

        return templates;
    }

    /**
     * AI ì‘ë‹µì—ì„œ JSON ë¶€ë¶„ë§Œ ì¶”ì¶œí•˜ê³  ì •ì œ
     */
    private String extractAndCleanJson(String aiResponse) {
        if (aiResponse == null || aiResponse.trim().isEmpty()) {
            return "[]";
        }

        // ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±°
        String cleaned = aiResponse.replaceAll("```json\\s*", "").replaceAll("```\\s*", "");

        // JSON ë°°ì—´ ì‹œì‘ê³¼ ë ì°¾ê¸°
        int startIdx = cleaned.indexOf('[');
        int endIdx = cleaned.lastIndexOf(']');

        if (startIdx != -1 && endIdx != -1 && startIdx < endIdx) {
            return cleaned.substring(startIdx, endIdx + 1).trim();
        }

        // JSON ê°ì²´ í˜•íƒœì¸ ê²½ìš° ë°°ì—´ë¡œ ê°ì‹¸ê¸°
        startIdx = cleaned.indexOf('{');
        endIdx = cleaned.lastIndexOf('}');

        if (startIdx != -1 && endIdx != -1 && startIdx < endIdx) {
            String jsonObject = cleaned.substring(startIdx, endIdx + 1).trim();
            return "[" + jsonObject + "]";
        }

        // íŒŒì‹±í•  ìˆ˜ ìˆëŠ” JSONì´ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜
        log.warn("ğŸ”¥ AI ì‘ë‹µì—ì„œ ìœ íš¨í•œ JSONì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: {}", aiResponse.substring(0, Math.min(100, aiResponse.length())));
        return "[]";
    }

    private ConditionTemplate.ConditionClassification parseClassification(String classification) {
        if (classification == null) return ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT;

        try {
            return ConditionTemplate.ConditionClassification.valueOf(classification.toUpperCase());
        } catch (Exception e) {
            return ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT;
        }
    }

    /**
     * AI ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ë²”ìš© í…œí”Œë¦¿ë“¤
     */
    private List<ConditionTemplate> generateFallbackUniversalTemplates() {
        log.info("ğŸ”„ AI ì‹¤íŒ¨ë¡œ ì¸í•œ ê¸°ë³¸ ë²”ìš© í…œí”Œë¦¿ ìƒì„±");

        List<ConditionTemplate> templates = new ArrayList<>();

        // hasPermission ê¸°ë°˜ ê¶Œí•œ ì²´í¬
        templates.add(ConditionTemplate.builder()
                .name("ê°ì²´ ì½ê¸° ê¶Œí•œ")
                .description("ë©”ì„œë“œê°€ ë°˜í™˜í•˜ëŠ” ê°ì²´ì— ëŒ€í•œ ì½ê¸° ê¶Œí•œ í™•ì¸")
                .category("ê¶Œí•œ ê¸°ë°˜")
                .classification(ConditionTemplate.ConditionClassification.CONTEXT_DEPENDENT)
                .spelTemplate("hasPermission(#returnObject, 'READ')")
                .sourceMethod("ê¸°ë³¸")
                .isAutoGenerated(true)
                .templateType("fallback")
                .createdAt(LocalDateTime.now())
                .build());

        // Spring Security ê¸°ë³¸ í‘œí˜„ì‹
        templates.add(ConditionTemplate.builder()
                .name("ì¸ì¦ í™•ì¸")
                .description("ì‚¬ìš©ìê°€ ì¸ì¦ë˜ì—ˆëŠ”ì§€ í™•ì¸")
                .category("ì¸ì¦ ê¸°ë°˜")
                .classification(ConditionTemplate.ConditionClassification.UNIVERSAL)
                .spelTemplate("isAuthenticated()")
                .sourceMethod("ê¸°ë³¸")
                .isAutoGenerated(true)
                .templateType("fallback")
                .createdAt(LocalDateTime.now())
                .build());

        return templates;
    }

    private String generateFallbackUniversalResponse() {
        return """
        [
          {
            "name": "ì¸ì¦ëœ ì‚¬ìš©ì í™•ì¸",
            "description": "ì‚¬ìš©ìê°€ ì •ìƒì ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸",
            "spelTemplate": "isAuthenticated()",
            "category": "ì¸ì¦ ê¸°ë°˜",
            "classification": "UNIVERSAL"
          },
          {
            "name": "ì™„ì „ ì¸ì¦ í™•ì¸", 
            "description": "Remember-meê°€ ì•„ë‹Œ ì™„ì „í•œ ì¸ì¦ í™•ì¸",
            "spelTemplate": "isFullyAuthenticated()",
            "category": "ì¸ì¦ ê¸°ë°˜",
            "classification": "UNIVERSAL"
          },
          {
            "name": "ì—…ë¬´ì‹œê°„ ì ‘ê·¼",
            "description": "ì˜¤ì „ 9ì‹œë¶€í„° ì˜¤í›„ 6ì‹œ ì‚¬ì´ì—ë§Œ ì ‘ê·¼ í—ˆìš©",
            "spelTemplate": "T(java.time.LocalTime).now().hour >= 9 and T(java.time.LocalTime).now().hour < 18",
            "category": "ì‹œê°„ ê¸°ë°˜",
            "classification": "UNIVERSAL"
          },
          {
            "name": "ë°˜í™˜ ê°ì²´ ì½ê¸° ê¶Œí•œ",
            "description": "ë©”ì„œë“œê°€ ë°˜í™˜í•˜ëŠ” ê°ì²´ì— ëŒ€í•œ ì½ê¸° ê¶Œí•œ",
            "spelTemplate": "hasPermission(#returnObject, 'READ')",
            "category": "ê¶Œí•œ ê¸°ë°˜", 
            "classification": "CONTEXT_DEPENDENT"
          }
        ]
        """;
    }

    private String generateFallbackSpecificResponse(String methodInfo) {
        // ë©”ì„œë“œ ì •ë³´ì—ì„œ ê°„ë‹¨í•œ íŒ¨í„´ ì¶”ì¶œ
        if (methodInfo.contains("getDocument") || methodInfo.contains("Document")) {
            return """
            [
              {
                "name": "ë¬¸ì„œ ì¡°íšŒ ê¶Œí•œ",
                "description": "íŠ¹ì • ë¬¸ì„œ IDì— ëŒ€í•œ ì¡°íšŒ ê¶Œí•œ í™•ì¸",
                "spelTemplate": "hasPermission(#id, 'DOCUMENT', 'READ')",
                "category": "ê¶Œí•œ ê¸°ë°˜",
                "classification": "CONTEXT_DEPENDENT"
              }
            ]
            """;
        }

        return """
        [
          {
            "name": "ê¸°ë³¸ ì‹¤í–‰ ê¶Œí•œ",
            "description": "ë©”ì„œë“œ ì‹¤í–‰ì— ëŒ€í•œ ê¸°ë³¸ ê¶Œí•œ",
            "spelTemplate": "hasPermission(#id, 'RESOURCE', 'EXECUTE')",
            "category": "ê¶Œí•œ ê¸°ë°˜", 
            "classification": "CONTEXT_DEPENDENT"
          }
        ]
        """;
    }
    
    /**
     * ManagedResourceì—ì„œ resource_identifierë¥¼ ë™ì ìœ¼ë¡œ íŒŒì‹±í•˜ì—¬ ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ ì •ë³´ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
     * resource_identifier í˜•íƒœ: "io.spring.iam.admin.iam.service.impl.GroupServiceImpl.updateGroup(Group,List)"
     */
    private MethodSignature parseMethodSignature(ManagedResource resource) {
        String identifier = resource.getResourceIdentifier();
        
        log.debug("ğŸ” ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ íŒŒì‹±: {}", identifier);
        
        try {
            // 1. í´ë˜ìŠ¤ëª…ê³¼ ë©”ì„œë“œ ë¶€ë¶„ ë¶„ë¦¬
            int lastDotIndex = identifier.lastIndexOf('.');
            if (lastDotIndex == -1) {
                throw new IllegalArgumentException("ì˜ëª»ëœ resource_identifier í˜•íƒœ: " + identifier);
            }
            
            String className = identifier.substring(0, lastDotIndex);
            String methodPart = identifier.substring(lastDotIndex + 1);
            
            // 2. ë©”ì„œë“œëª…ê³¼ íŒŒë¼ë¯¸í„° ë¶€ë¶„ ë¶„ë¦¬
            String methodName;
            String paramTypes = "";
            
            if (methodPart.contains("(")) {
                methodName = methodPart.substring(0, methodPart.indexOf("("));
                String paramPart = methodPart.substring(methodPart.indexOf("(") + 1, methodPart.lastIndexOf(")"));
                paramTypes = paramPart.trim();
            } else {
                methodName = methodPart;
            }
            
            // 3. ë¦¬ì†ŒìŠ¤ íƒ€ì… ë™ì  ê²°ì • (í´ë˜ìŠ¤ëª… ê¸°ë°˜)
            String resourceType = determineResourceTypeFromClassName(className);
            
            // 4. íŒŒë¼ë¯¸í„° ì •ë³´ ë™ì  íŒŒì‹±
            String parameterInfo = parseParameterInfo(methodName, paramTypes);
            
            log.debug("âœ… íŒŒì‹± ê²°ê³¼ - ë©”ì„œë“œ: {}, íŒŒë¼ë¯¸í„°: {}, ë¦¬ì†ŒìŠ¤íƒ€ì…: {}", 
                     methodName, parameterInfo, resourceType);
            
            return new MethodSignature(methodName, parameterInfo, resourceType);
            
        } catch (Exception e) {
            log.error("ğŸ”¥ ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ íŒŒì‹± ì‹¤íŒ¨: {}", identifier, e);
            // í´ë°±: ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
            return new MethodSignature(
                extractMethodName(identifier), 
                "íŒŒë¼ë¯¸í„° íŒŒì‹± ì‹¤íŒ¨", 
                "UNKNOWN"
            );
        }
    }
    
    /**
     * í´ë˜ìŠ¤ëª…ìœ¼ë¡œë¶€í„° ë¦¬ì†ŒìŠ¤ íƒ€ì…ì„ ë™ì ìœ¼ë¡œ ê²°ì •
     */
    private String determineResourceTypeFromClassName(String className) {
        String simpleName = className.substring(className.lastIndexOf('.') + 1);
        
        // ì„œë¹„ìŠ¤ í´ë˜ìŠ¤ëª… íŒ¨í„´ ë¶„ì„
        if (simpleName.contains("Group")) {
            return "GROUP";
        } else if (simpleName.contains("User")) {
            return "USER";
        } else if (simpleName.contains("Role")) {
            return "ROLE";
        } else if (simpleName.contains("Permission")) {
            return "PERMISSION";
        } else if (simpleName.contains("Document")) {
            return "DOCUMENT";
        } else if (simpleName.contains("Policy")) {
            return "POLICY";
        } else {
            // í´ë˜ìŠ¤ëª…ì—ì„œ Service ì œê±°í•˜ê³  ëŒ€ë¬¸ìë¡œ ë³€í™˜
            String resourceName = simpleName.replace("Service", "").replace("Impl", "");
            return resourceName.toUpperCase();
        }
    }
    
    /**
     * ë¦¬í”Œë ‰ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ì‹¤ì œ ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ë¡œë¶€í„° ë™ì ìœ¼ë¡œ íŒŒë¼ë¯¸í„° ì •ë³´ë¥¼ íŒŒì‹±í•©ë‹ˆë‹¤.
     * resource_identifier í˜•íƒœ: "io.spring.iam.admin.iam.service.impl.GroupServiceImpl.updateGroup(Group,List)"
     */
    private String parseParameterInfo(String methodName, String paramTypes) {
        if (paramTypes == null || paramTypes.trim().isEmpty() || paramTypes.equals("ì—†ìŒ") || paramTypes.equals("()")) {
            return "íŒŒë¼ë¯¸í„° ì—†ìŒ";
        }
        
        // íŒŒë¼ë¯¸í„° íƒ€ì… ë¬¸ìì—´ì„ íŒŒì‹±í•˜ì—¬ ì‹¤ì œ íŒŒë¼ë¯¸í„° ì •ë³´ ìƒì„±
        return parseParameterTypesFromString(paramTypes);
    }
    
    /**
     * íŒŒë¼ë¯¸í„° íƒ€ì… ë¬¸ìì—´ì„ íŒŒì‹±í•˜ì—¬ SpELì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” íŒŒë¼ë¯¸í„° ì •ë³´ë¡œ ë³€í™˜
     * ì˜ˆ: "Group,List" -> "#group (Group ê°ì²´), #selectedRoleIds (List<Long> íƒ€ì…)"
     * ì˜ˆ: "Long" -> "#id (Long íƒ€ì…)"
     * ì˜ˆ: "UserDto" -> "#userDto (UserDto ê°ì²´)"
     */
    private String parseParameterTypesFromString(String paramTypes) {
        if (paramTypes == null || paramTypes.trim().isEmpty()) {
            return "íŒŒë¼ë¯¸í„° ì—†ìŒ";
        }
        
        // ê´„í˜¸ ì œê±°
        String cleanTypes = paramTypes.replaceAll("[()]", "").trim();
        if (cleanTypes.isEmpty()) {
            return "íŒŒë¼ë¯¸í„° ì—†ìŒ";
        }
        
        // ì‰¼í‘œë¡œ ë¶„ë¦¬
        String[] types = cleanTypes.split(",");
        List<String> parameterInfos = new ArrayList<>();
        
        for (int i = 0; i < types.length; i++) {
            String type = types[i].trim();
            String paramInfo = generateParameterInfo(type, i);
            parameterInfos.add(paramInfo);
        }
        
        return String.join(", ", parameterInfos);
    }
    
    /**
     * íƒ€ì…ëª…ìœ¼ë¡œë¶€í„° SpEL íŒŒë¼ë¯¸í„° ì •ë³´ë¥¼ ìƒì„±
     */
    private String generateParameterInfo(String type, int index) {
        // ì œë„¤ë¦­ íƒ€ì… ì²˜ë¦¬
        String baseType = type.contains("<") ? type.substring(0, type.indexOf("<")) : type;
        
        // íŒ¨í‚¤ì§€ëª… ì œê±° (ë§ˆì§€ë§‰ . ì´í›„ë§Œ ì‚¬ìš©)
        if (baseType.contains(".")) {
            baseType = baseType.substring(baseType.lastIndexOf(".") + 1);
        }
        
        // íƒ€ì…ì— ë”°ë¥¸ íŒŒë¼ë¯¸í„°ëª… ìƒì„±
        String paramName = generateParameterName(baseType, index);
        String typeDescription = generateTypeDescription(type);
        
        return String.format("#%s (%s)", paramName, typeDescription);
    }
    
    /**
     * íƒ€ì…ì— ë”°ë¥¸ íŒŒë¼ë¯¸í„°ëª… ìƒì„± (camelCase)
     */
    private String generateParameterName(String type, int index) {
        // ì œë„¤ë¦­ íƒ€ì… ì²˜ë¦¬ (List<Long> -> selectedRoleIds)
        if (type.startsWith("List<")) {
            if (type.contains("Long")) {
                return "selectedRoleIds"; // List<Long>ì€ ë³´í†µ ID ëª©ë¡
            } else if (type.contains("String")) {
                return "selectedItems";
            } else {
                return "list" + (index == 0 ? "" : index);
            }
        }
        
        switch (type) {
            // ê¸°ë³¸ íƒ€ì…ë“¤
            case "Long":
            case "Integer":
            case "int":
            case "long":
                return index == 0 ? "id" : (index == 1 ? "idx" : "param" + index);
            case "String":
                return index == 0 ? "value" : "param" + index;
            case "Boolean":
            case "boolean":
                return index == 0 ? "flag" : "param" + index;
                
            // ì—”í‹°í‹°/DTO íƒ€ì…ë“¤
            case "Group":
                return "group";
            case "User":
                return "user";
            case "UserDto":
                return "userDto";
            case "UserListDto":
                return "userListDto";
            case "Role":
                return "role";
            case "Permission":
                return "permission";
            case "Document":
                return "document";
                
            // ì»¬ë ‰ì…˜ íƒ€ì…ë“¤
            case "List":
                return "selectedRoleIds"; // ê¸°ë³¸ì ìœ¼ë¡œ ì—­í•  ID ëª©ë¡ìœ¼ë¡œ ê°€ì •
            case "Set":
                return index == 0 ? "set" : "set" + index;
            case "Map":
                return index == 0 ? "map" : "map" + index;
                
            // ê¸°íƒ€
            default:
                // í´ë˜ìŠ¤ëª…ì„ camelCaseë¡œ ë³€í™˜
                String camelCase = type.substring(0, 1).toLowerCase() + type.substring(1);
                return camelCase;
        }
    }
    
    /**
     * íƒ€ì… ì„¤ëª… ìƒì„±
     */
    private String generateTypeDescription(String fullType) {
        if (fullType.contains("<")) {
            // ì œë„¤ë¦­ íƒ€ì… ì²˜ë¦¬: List<Long> -> List<Long> íƒ€ì…
            return fullType + " íƒ€ì…";
        } else {
            // ë‹¨ìˆœ íƒ€ì… ì²˜ë¦¬
            String baseType = fullType.contains(".") ? 
                fullType.substring(fullType.lastIndexOf(".") + 1) : fullType;
            
            // ê¸°ë³¸ íƒ€ì…ì¸ì§€ ê°ì²´ íƒ€ì…ì¸ì§€ êµ¬ë¶„
            switch (baseType) {
                case "Long":
                case "Integer":
                case "String":
                case "Boolean":
                case "int":
                case "long":
                case "boolean":
                    return baseType + " íƒ€ì…";
                default:
                    return baseType + " ê°ì²´";
            }
        }
    }
    
    /**
     * ë¦¬ì†ŒìŠ¤ íƒ€ì…ì— ë”°ë¥¸ ì„œë¹„ìŠ¤ëª… ë™ì  ìƒì„±
     */
    private String getServiceName(String resourceType) {
        if (resourceType == null || resourceType.equals("UNKNOWN")) {
            return "Unknown Service";
        }
        
        // ë¦¬ì†ŒìŠ¤ íƒ€ì…ì„ ê¸°ë°˜ìœ¼ë¡œ ì„œë¹„ìŠ¤ëª… ìƒì„±
        String serviceName = resourceType.toLowerCase();
        serviceName = serviceName.substring(0, 1).toUpperCase() + serviceName.substring(1);
        return serviceName + "Service";
    }
    
    /**
     * ë©”ì„œë“œëª…ê³¼ íŒŒë¼ë¯¸í„° ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë™ì  ì»¨í…ìŠ¤íŠ¸ ìƒì„±
     */
    private String getMethodContext(String methodName) {
        if (methodName == null) {
            return "ë©”ì„œë“œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
        }
        
        // ë©”ì„œë“œëª… íŒ¨í„´ ë¶„ì„ì„ í†µí•œ ë™ì  ì»¨í…ìŠ¤íŠ¸ ìƒì„±
        String action = determineMethodAction(methodName);
        String entity = determineMethodEntity(methodName);
        
        return String.format("%s %s ë©”ì„œë“œì…ë‹ˆë‹¤.", entity, action);
    }
    
    /**
     * ë©”ì„œë“œëª…ìœ¼ë¡œë¶€í„° ì•¡ì…˜ ê²°ì •
     */
    private String determineMethodAction(String methodName) {
        String lowerName = methodName.toLowerCase();
        
        if (lowerName.startsWith("create") || lowerName.startsWith("add") || lowerName.startsWith("insert")) {
            return "ìƒì„±í•˜ëŠ”";
        } else if (lowerName.startsWith("get") || lowerName.startsWith("find") || lowerName.startsWith("select") || lowerName.startsWith("retrieve")) {
            return "ì¡°íšŒí•˜ëŠ”";
        } else if (lowerName.startsWith("update") || lowerName.startsWith("modify") || lowerName.startsWith("edit")) {
            return "ìˆ˜ì •í•˜ëŠ”";
        } else if (lowerName.startsWith("delete") || lowerName.startsWith("remove")) {
            return "ì‚­ì œí•˜ëŠ”";
        } else if (lowerName.startsWith("save")) {
            return "ì €ì¥í•˜ëŠ”";
        } else if (lowerName.startsWith("validate") || lowerName.startsWith("check")) {
            return "ê²€ì¦í•˜ëŠ”";
        } else {
            return "ì²˜ë¦¬í•˜ëŠ”";
        }
    }
    
    /**
     * ë©”ì„œë“œëª…ìœ¼ë¡œë¶€í„° ì—”í‹°í‹° ê²°ì •
     */
    private String determineMethodEntity(String methodName) {
        String lowerName = methodName.toLowerCase();
        
        if (lowerName.contains("group")) {
            return "ê·¸ë£¹ì„";
        } else if (lowerName.contains("user")) {
            return "ì‚¬ìš©ìë¥¼";
        } else if (lowerName.contains("role")) {
            return "ì—­í• ì„";
        } else if (lowerName.contains("permission")) {
            return "ê¶Œí•œì„";
        } else if (lowerName.contains("document")) {
            return "ë¬¸ì„œë¥¼";
        } else if (lowerName.contains("policy")) {
            return "ì •ì±…ì„";
        } else {
                         return "ë¦¬ì†ŒìŠ¤ë¥¼";
         }
     }
     
     /**
      * ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ì— ë”°ë¥¸ ì˜¬ë°”ë¥¸ hasPermission ì‚¬ìš©ë²• ìƒì„±
      */
     private String generateHasPermissionUsage(MethodSignature signature) {
         // íŒŒë¼ë¯¸í„° ë¶„ì„
         String paramInfo = signature.parameterInfo.toLowerCase();
         
         if (paramInfo.contains("#id (long") || paramInfo.contains("#idx (long")) {
             // ID íŒŒë¼ë¯¸í„°ì¸ ê²½ìš° - 3ê°œ íŒŒë¼ë¯¸í„° í˜•ì‹
             String paramName = paramInfo.contains("#idx") ? "#idx" : "#id";
             return String.format("âœ… ì˜¬ë°”ë¥¸ í˜•ì‹: hasPermission(%s, '%s', 'DELETE') - IDëŠ” ë°˜ë“œì‹œ 3ê°œ íŒŒë¼ë¯¸í„°", 
                                paramName, signature.resourceType);
         } else if (paramInfo.contains("ê°ì²´") || paramInfo.contains("#group") || paramInfo.contains("#userDto")) {
             // ê°ì²´ íŒŒë¼ë¯¸í„°ì¸ ê²½ìš° - 2ê°œ íŒŒë¼ë¯¸í„° í˜•ì‹
             String paramName = extractParamName(signature.parameterInfo);
             return String.format("âœ… ì˜¬ë°”ë¥¸ í˜•ì‹: hasPermission(%s, 'UPDATE') - ê°ì²´ëŠ” ë°˜ë“œì‹œ 2ê°œ íŒŒë¼ë¯¸í„°ë§Œ! ë¦¬ì†ŒìŠ¤ íƒ€ì… ì‚¬ìš© ê¸ˆì§€!", paramName);
         } else if (paramInfo.contains("#selectedRoleIds")) {
             // List íŒŒë¼ë¯¸í„°ëŠ” ë³´í†µ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
             return "âš ï¸ List íŒŒë¼ë¯¸í„°ëŠ” hasPermissionì—ì„œ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ";
         } else {
             return "hasPermission() í˜•ì‹ì„ ì •í™•íˆ ì‚¬ìš©í•˜ì„¸ìš”";
         }
     }
     
     /**
      * íŒŒë¼ë¯¸í„° ì •ë³´ì—ì„œ íŒŒë¼ë¯¸í„°ëª… ì¶”ì¶œ
      */
     private String extractParamName(String parameterInfo) {
         if (parameterInfo.contains("#group")) {
             return "#group";
         } else if (parameterInfo.contains("#userDto")) {
             return "#userDto";
         } else if (parameterInfo.contains("#id")) {
             return "#id";
         } else if (parameterInfo.contains("#idx")) {
             return "#idx";
         } else {
             return "#param";
         }
     }
}