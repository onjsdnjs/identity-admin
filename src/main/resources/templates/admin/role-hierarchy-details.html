<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <th:block th:replace="~{fragments/common-head :: head-elements(pageTitle=${hierarchy.id != null ? '역할 계층 수정' : '역할 계층 등록'})}"></th:block>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body class="flex flex-col min-h-screen font-sans">

<div th:insert="~{fragments/header :: header}"></div>
<div id="toast-container" class="fixed top-5 right-5 z-50"></div>

<div class="flex flex-1">
    <aside th:insert="~{fragments/admin-menu :: menu}"></aside>

    <main class="flex-1 p-6 md:p-10 flex items-center justify-center">
        <div class="w-full max-w-2xl p-8 sm:p-10 rounded-xl shadow-2xl dark-card">
            <div class="text-center mb-8">
                <h2 class="mt-4 text-3xl font-bold text-gradient" th:text="${hierarchy.id != null ? '역할 계층 수정' : '새 역할 계층 등록'}"></h2>
            </div>

            <form id="hierarchyForm" method="post" th:object="${hierarchy}" class="space-y-6">
                <input type="hidden" th:field="*{id}" th:if="${hierarchy.id != null}" />
                <input type="hidden" id="hierarchyString" th:field="*{hierarchyString}" />

                <div>
                    <label for="description" class="dark-label">설명:</label>
                    <input type="text" id="description" th:field="*{description}" class="dark-input" required />
                </div>

                <div>
                    <label class="dark-label">계층 구조 정의 (상위 역할 > 하위 역할):</label>
                    <div id="hierarchy-rows-container" class="space-y-3 mt-2 p-4 rounded-lg" style="background: rgba(30, 41, 59, 0.4);">
                        <div th:each="pair, stat : ${hierarchyPairs}" class="hierarchy-row grid grid-cols-12 gap-3 items-center">
                            <div class="col-span-5">
                                <select class="parent-role dark-select w-full">
                                    <option value="">상위 역할 선택</option>
                                    <option th:each="role : ${allRoles}" th:value="${role.roleName}" th:text="${role.roleName}" th:selected="${role.roleName == pair.parentRole}"></option>
                                </select>
                            </div>
                            <div class="col-span-1 text-center text-slate-400 font-bold text-lg">&gt;</div>
                            <div class="col-span-5">
                                <select class="child-role dark-select w-full">
                                    <option value="">하위 역할 선택</option>
                                    <option th:each="role : ${allRoles}" th:value="${role.roleName}" th:text="${role.roleName}" th:selected="${role.roleName == pair.childRole}"></option>
                                </select>
                            </div>
                            <div class="col-span-1 text-center">
                                <button type="button" onclick="removeRow(this)" class="text-xl text-slate-500 hover:text-red-400">&times;</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="add-row-btn" class="mt-3 text-sm font-medium text-indigo-400 hover:underline">+ 관계 추가</button>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="isActive" th:field="*{isActive}" class="dark-checkbox" />
                    <label for="isActive" class="ml-2 block text-sm text-slate-200">이 계층을 활성화합니다</label>
                </div>

                <div class="pt-4">
                    <button type="submit" class="dark-btn-primary w-full" th:text="${hierarchy.id != null ? '계층 저장' : '계층 등록'}"></button>
                </div>
            </form>
        </div>
    </main>
</div>

<div th:insert="~{fragments/footer :: footer}"></div>

<script th:inline="javascript">
    const allRoles = /*[[${allRoles}]]*/ [];
    const roleOptionsHtml = allRoles.map(role => `<option value="<span class="math-inline">\{role\.roleName\}"\></span>{role.roleName}</option>`).join('');

    function addRow() {
        const container = document.getElementById('hierarchy-rows-container');
        const newRow = document.createElement('div');
        newRow.className = 'hierarchy-row grid grid-cols-12 gap-3 items-center';
        newRow.innerHTML = `
            <div class="col-span-5">
                <select class="parent-role dark-select w-full">
                    <option value="">상위 역할 선택</option><span class="math-inline">\{roleOptionsHtml\}
</select>
</div>
<div class="col-span-1 text-center text-slate-400 font-bold text-lg">&gt;</div>
<div class="col-span-5">
<select class="child-role dark-select w-full">
<option value="">하위 역할 선택</option>{roleOptionsHtml}
</select>
</div>
<div class="col-span-1 text-center">
<button type="button" onclick="removeRow(this)" class="text-xl text-slate-500 hover:text-red-400">&times;</button>
</div>
`;
        container.appendChild(newRow);
    }

    function removeRow(button) {
        button.closest('.hierarchy-row').remove();
    }

    document.getElementById('add-row-btn').addEventListener('click', addRow);

    document.getElementById('hierarchyForm').addEventListener('submit', function(e) {
        // 폼 제출 전, UI의 모든 관계를 읽어 hidden input에 문자열로 변환하여 저장
        const rows = document.querySelectorAll('.hierarchy-row');
        const hierarchyPairs = [];
        let isValid = true;
        rows.forEach(row => {
            const parentRole = row.querySelector('.parent-role').value;
            const childRole = row.querySelector('.child-role').value;
            if (parentRole && childRole) {
                hierarchyPairs.push(`${parentRole} > ${childRole}`);
            } else if (parentRole || childRole) {
                // 둘 중 하나만 선택된 경우 경고
                isValid = false;
            }
        });

        if (!isValid) {
            e.preventDefault(); // 폼 제출 중단
            showToast('상위 역할과 하위 역할을 모두 선택해야 합니다.', 'error');
            return;
        }

        document.getElementById('hierarchyString').value = hierarchyPairs.join('\\n');
    });
</script>
</body>
</html>