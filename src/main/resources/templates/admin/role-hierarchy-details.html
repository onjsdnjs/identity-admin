<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <th:block th:replace="~{fragments/common-head :: head-elements(pageTitle=${hierarchy.id != null ? '역할 계층 수정' : '역할 계층 등록'})}"></th:block>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/role-hierarchy.css}">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        /* HTML 고유 스타일만 유지 (CSS 파일로 이동할 수 없는 것들) */
        #mermaid-container {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen font-sans">

<div th:insert="~{fragments/header :: header}"></div>
<div id="toast-container" class="fixed top-5 right-5 z-50"></div>
<div id="tooltip" class="tooltip"></div>

<div class="flex flex-1">
    <aside th:insert="~{fragments/admin-menu :: menu}"></aside>

    <main class="flex-1 p-6 md:p-10">
        <div class="dark-card p-6 rounded-xl">
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold text-gradient" th:text="${hierarchy.id != null ? '역할 계층 수정' : '새 역할 계층 등록'}"></h2>
                <p class="text-dark-muted mt-2">역할 간의 상하 관계를 시각적으로 정의하고 관리합니다</p>
            </div>

            <form id="hierarchyForm" method="post" th:object="${hierarchy}" class="space-y-6">
                <input type="hidden" th:field="*{id}" th:if="${hierarchy.id != null}" />
                <input type="hidden" id="hierarchyString" th:field="*{hierarchyString}" />

                <!-- 설명 입력 -->
                <div>
                    <label for="description" class="dark-label">계층 설명:</label>
                    <input type="text" id="description" th:field="*{description}"
                           class="dark-input"
                           placeholder="예: 기본 조직 계층 구조" required />
                </div>

                <!-- 메인 편집 영역: 3단 구조 -->
                <div class="grid grid-cols-12 gap-4">
                    <!-- 왼쪽: 역할 팔레트 -->
                    <div class="col-span-3">
                        <h3 class="text-lg font-bold text-slate-200 mb-3">역할 목록</h3>
                        <div class="role-palette">
                            <!-- 그룹별 역할 표시 -->
                            <div th:each="group : ${groupsWithRoles}" class="group-section">
                                <div class="group-header">
                                    <i class="fas fa-users mr-2"></i>
                                    <span th:text="${group.groupName}"></span>
                                </div>
                                <div th:each="role : ${group.roles}"
                                     class="role-item"
                                     th:data-role="${role.roleName}"
                                     th:data-desc="${role.roleDesc}"
                                     onmouseover="showTooltip(event, this)"
                                     onmouseout="hideTooltip()">
                                    <div class="role-item-name" th:text="${role.roleName}"></div>
                                    <div class="role-item-desc" th:text="${role.roleDesc}"></div>
                                    <div class="mt-1">
                                        <span th:each="perm : ${role.permissions}"
                                              class="permission-tag"
                                              th:text="${perm}"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- 그룹 미지정 역할 -->
                            <div th:if="${!#lists.isEmpty(ungroupedRoles)}" class="group-section">
                                <div class="group-header">
                                    <i class="fas fa-user mr-2"></i>
                                    <span>그룹 미지정</span>
                                </div>
                                <div th:each="role : ${ungroupedRoles}"
                                     class="role-item"
                                     th:data-role="${role.roleName}"
                                     th:data-desc="${role.roleDesc}">
                                    <div class="role-item-name" th:text="${role.roleName}"></div>
                                    <div class="role-item-desc" th:text="${role.roleDesc}"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 중앙: 시각화 캔버스 -->
                    <div class="col-span-5">
                        <h3 class="text-lg font-bold text-slate-200 mb-3">계층 구조 시각화</h3>
                        <div class="hierarchy-visualization">
                            <div id="mermaid-container" style="width: 100%; height: 100%;">
                                <div id="mermaid-diagram" class="mermaid">
                                    graph TD
                                    A[역할 관계를 설정하면<br/>여기에 시각화됩니다]
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 오른쪽: 관계 편집기 -->
                    <div class="col-span-4">
                        <h3 class="text-lg font-bold text-slate-200 mb-3">관계 편집</h3>

                        <!-- 검증 메시지 영역 -->
                        <div id="validation-error" class="validation-error"></div>
                        <div id="validation-warning" class="validation-warning"></div>

                        <div id="hierarchy-rows-container" class="space-y-2">
                            <div th:each="pair, stat : ${hierarchyPairs}" class="relation-row">
                                <div class="grid grid-cols-12 gap-2 items-center">
                                    <div class="col-span-5">
                                        <select class="parent-role dark-select w-full" onchange="validateAndUpdate()">
                                            <option value="">상위 역할 선택</option>
                                            <optgroup th:each="group : ${groupsWithRoles}" th:label="${group.groupName}">
                                                <option th:each="role : ${group.roles}"
                                                        th:value="${role.roleName}"
                                                        th:text="${role.roleDesc + ' (' + role.roleName + ')'}"
                                                        th:selected="${role.roleName == pair.parentRole}"></option>
                                            </optgroup>
                                            <optgroup th:if="${!#lists.isEmpty(ungroupedRoles)}" label="그룹 미지정">
                                                <option th:each="role : ${ungroupedRoles}"
                                                        th:value="${role.roleName}"
                                                        th:text="${role.roleDesc + ' (' + role.roleName + ')'}"
                                                        th:selected="${role.roleName == pair.parentRole}"></option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <div class="col-span-2 text-center">
                                        <span class="relation-arrow">→</span>
                                    </div>
                                    <div class="col-span-5">
                                        <select class="child-role dark-select w-full" onchange="validateAndUpdate()">
                                            <option value="">하위 역할 선택</option>
                                            <optgroup th:each="group : ${groupsWithRoles}" th:label="${group.groupName}">
                                                <option th:each="role : ${group.roles}"
                                                        th:value="${role.roleName}"
                                                        th:text="${role.roleDesc + ' (' + role.roleName + ')'}"
                                                        th:selected="${role.roleName == pair.childRole}"></option>
                                            </optgroup>
                                            <optgroup th:if="${!#lists.isEmpty(ungroupedRoles)}" label="그룹 미지정">
                                                <option th:each="role : ${ungroupedRoles}"
                                                        th:value="${role.roleName}"
                                                        th:text="${role.roleDesc + ' (' + role.roleName + ')'}"
                                                        th:selected="${role.roleName == pair.childRole}"></option>
                                            </optgroup>
                                        </select>
                                    </div>
                                </div>
                                <button type="button" onclick="removeRow(this)"
                                        class="mt-2 text-sm text-red-400 hover:text-red-600">
                                    <i class="fas fa-trash mr-1"></i> 관계 삭제
                                </button>
                            </div>
                        </div>

                        <button type="button" id="add-row-btn"
                                class="mt-3 text-sm font-medium text-indigo-400 hover:text-indigo-300">
                            <i class="fas fa-plus mr-1"></i> 관계 추가
                        </button>
                    </div>
                </div>

                <!-- 결과 미리보기 -->
                <div class="mt-6">
                    <h3 class="text-lg font-bold text-slate-200 mb-3">최종 계층 문자열 미리보기</h3>
                    <div id="result-preview" class="result-preview">
                        계층 관계를 설정하면 여기에 결과가 표시됩니다.
                    </div>
                </div>

                <!-- 활성화 옵션 -->
                <div class="flex items-center">
                    <input type="checkbox" id="isActive" th:field="*{isActive}" class="dark-checkbox" />
                    <label for="isActive" class="ml-2 block text-sm text-slate-200">
                        이 계층을 활성화합니다 (기존 활성 계층은 자동으로 비활성화됩니다)
                    </label>
                </div>

                <!-- 제출 버튼 -->
                <div class="pt-4 flex gap-4">
                    <button type="button" onclick="showConfirmDialog()"
                            class="flex-1 dark-btn-primary">
                        <i class="fas fa-save mr-2"></i>
                        <span th:text="${hierarchy.id != null ? '계층 수정' : '계층 등록'}"></span>
                    </button>
                    <a th:href="@{/admin/role-hierarchies}"
                       class="flex-1 text-center py-3 px-4 rounded-lg border border-slate-600 text-slate-300 hover:bg-slate-700">
                        <i class="fas fa-times mr-2"></i> 취소
                    </a>
                </div>
            </form>
        </div>
    </main>
</div>

<!-- 확인 다이얼로그 -->
<div id="confirm-dialog" class="confirm-dialog">
    <div class="confirm-dialog-content">
        <h3 class="text-2xl font-bold text-slate-200 mb-4">계층 구조 확인</h3>
        <p class="text-slate-400 mb-4">아래 계층 구조를 최종 확인해주세요:</p>

        <div class="hierarchy-visualization mb-6" style="height: 400px;">
            <div id="confirm-mermaid" class="mermaid"></div>
        </div>

        <div id="impact-analysis" class="mb-6">
            <!-- 영향 분석 결과가 여기에 표시됩니다 -->
        </div>

        <div class="flex gap-4">
            <button type="button" onclick="submitForm()"
                    class="flex-1 dark-btn-primary">
                <i class="fas fa-check mr-2"></i> 확인 및 저장
            </button>
            <button type="button" onclick="hideConfirmDialog()"
                    class="flex-1 py-3 px-4 rounded-lg border border-slate-600 text-slate-300 hover:bg-slate-700">
                <i class="fas fa-times mr-2"></i> 취소
            </button>
        </div>
    </div>
</div>

<div th:insert="~{fragments/footer :: footer}"></div>

<script th:inline="javascript">
    // Thymeleaf에서 전달된 데이터
    const groupsWithRoles = /*[[${groupsWithRoles}]]*/ [];
    const ungroupedRoles = /*[[${ungroupedRoles}]]*/ [];

    // Mermaid 초기화
    mermaid.initialize({
        startOnLoad: true,
        theme: 'dark',
        themeVariables: {
            primaryColor: '#6366f1',
            primaryTextColor: '#e2e8f0',
            primaryBorderColor: '#4f46e5',
            lineColor: '#60a5fa',
            secondaryColor: '#1e293b',
            tertiaryColor: '#334155',
            background: '#0f172a',
            mainBkg: '#1e293b',
            secondBkg: '#334155',
            tertiaryBkg: '#475569'
        }
    });

    // 전역 변수
    let relationshipGraph = new Map(); // 계층 관계 저장

    // 툴팁 표시
    function showTooltip(event, element) {
        const tooltip = document.getElementById('tooltip');
        const role = element.dataset.role;
        const desc = element.dataset.desc;
        const permissions = element.querySelectorAll('.permission-tag');

        let content = `<strong>${role}</strong><br/>${desc}`;
        if (permissions.length > 0) {
            content += '<br/><br/><strong>권한:</strong><br/>';
            permissions.forEach(p => {
                content += `• ${p.textContent}<br/>`;
            });
        }

        tooltip.innerHTML = content;
        tooltip.style.display = 'block';
        tooltip.style.left = event.pageX + 10 + 'px';
        tooltip.style.top = event.pageY + 10 + 'px';
    }

    function hideTooltip() {
        document.getElementById('tooltip').style.display = 'none';
    }

    // 관계 행 추가
    function addRow() {
        const container = document.getElementById('hierarchy-rows-container');
        const newRow = document.createElement('div');
        newRow.className = 'relation-row';

        let optionsHtml = '';
        groupsWithRoles.forEach(group => {
            optionsHtml += `<optgroup label="${group.groupName}">`;
            group.roles.forEach(role => {
                optionsHtml += `<option value="${role.roleName}">${role.roleDesc} (${role.roleName})</option>`;
            });
            optionsHtml += '</optgroup>';
        });

        if (ungroupedRoles && ungroupedRoles.length > 0) {
            optionsHtml += '<optgroup label="그룹 미지정">';
            ungroupedRoles.forEach(role => {
                optionsHtml += `<option value="${role.roleName}">${role.roleDesc} (${role.roleName})</option>`;
            });
            optionsHtml += '</optgroup>';
        }

        newRow.innerHTML = `
            <div class="grid grid-cols-12 gap-2 items-center">
                <div class="col-span-5">
                    <select class="parent-role dark-select w-full" onchange="validateAndUpdate()">
                        <option value="">상위 역할 선택</option>
                        ${optionsHtml}
                    </select>
                </div>
                <div class="col-span-2 text-center">
                    <span class="relation-arrow">→</span>
                </div>
                <div class="col-span-5">
                    <select class="child-role dark-select w-full" onchange="validateAndUpdate()">
                        <option value="">하위 역할 선택</option>
                        ${optionsHtml}
                    </select>
                </div>
            </div>
            <button type="button" onclick="removeRow(this)"
                    class="mt-2 text-sm text-red-400 hover:text-red-600">
                <i class="fas fa-trash mr-1"></i> 관계 삭제
            </button>
        `;

        container.appendChild(newRow);
    }

    // 관계 행 삭제
    function removeRow(button) {
        button.closest('.relation-row').remove();
        validateAndUpdate();
    }

    // 유효성 검증 및 업데이트
    function validateAndUpdate() {
        const rows = document.querySelectorAll('.relation-row');
        const relations = [];
        const graph = new Map();
        let hasError = false;
        let errorMessage = '';
        let warningMessage = '';

        // 관계 수집
        rows.forEach(row => {
            const parent = row.querySelector('.parent-role').value;
            const child = row.querySelector('.child-role').value;

            if (parent && child) {
                if (parent === child) {
                    hasError = true;
                    errorMessage = '상위 역할과 하위 역할이 동일할 수 없습니다.';
                    return;
                }

                relations.push({parent, child});

                if (!graph.has(parent)) {
                    graph.set(parent, new Set());
                }
                graph.get(parent).add(child);
            } else if (parent || child) {
                warningMessage = '상위 역할과 하위 역할을 모두 선택해주세요.';
            }
        });

        // 중복 검사
        const seen = new Set();
        for (const rel of relations) {
            const key = `${rel.parent}>${rel.child}`;
            if (seen.has(key)) {
                hasError = true;
                errorMessage = `중복된 관계가 있습니다: ${key}`;
                break;
            }
            seen.add(key);
        }

        // 역방향 관계 검사
        if (!hasError) {
            for (const rel of relations) {
                const reverseKey = `${rel.child}>${rel.parent}`;
                if (seen.has(reverseKey)) {
                    hasError = true;
                    errorMessage = `역방향 관계가 발견되었습니다: ${rel.parent} ↔ ${rel.child}`;
                    break;
                }
            }
        }

        // 순환 참조 검사
        if (!hasError && graph.size > 0) {
            for (const [node, ] of graph) {
                if (hasCycle(graph, node, new Set(), new Set())) {
                    hasError = true;
                    errorMessage = `순환 참조가 발견되었습니다. ${node}부터 시작하는 경로를 확인하세요.`;
                    break;
                }
            }
        }

        // 에러/경고 표시
        const errorDiv = document.getElementById('validation-error');
        const warningDiv = document.getElementById('validation-warning');

        if (hasError) {
            errorDiv.textContent = errorMessage;
            errorDiv.style.display = 'block';
        } else {
            errorDiv.style.display = 'none';
        }

        if (!hasError && warningMessage) {
            warningDiv.textContent = warningMessage;
            warningDiv.style.display = 'block';
        } else {
            warningDiv.style.display = 'none';
        }

        // 시각화 업데이트
        if (!hasError && relations.length > 0) {
            updateVisualization(relations);
            updateResultPreview(relations);
        }

        relationshipGraph = graph;
    }

    // 순환 참조 검사 (DFS)
    function hasCycle(graph, node, visited, recStack) {
        visited.add(node);
        recStack.add(node);

        const children = graph.get(node);
        if (children) {
            for (const child of children) {
                if (!visited.has(child)) {
                    if (hasCycle(graph, child, visited, recStack)) {
                        return true;
                    }
                } else if (recStack.has(child)) {
                    return true;
                }
            }
        }

        recStack.delete(node);
        return false;
    }

    // 시각화 업데이트
    function updateVisualization(relations) {
        if (relations.length === 0) return;

        let mermaidCode = 'graph TD\n';
        relations.forEach((rel, index) => {
            const parentNode = `P${index}["${rel.parent}"]`;
            const childNode = `C${index}["${rel.child}"]`;
            mermaidCode += `    ${parentNode} --> ${childNode}\n`;
        });

        const container = document.getElementById('mermaid-container');
        container.innerHTML = `<div id="mermaid-diagram" class="mermaid">${mermaidCode}</div>`;
        mermaid.init(undefined, document.getElementById('mermaid-diagram'));
    }

    // 결과 미리보기 업데이트
    function updateResultPreview(relations) {
        const preview = document.getElementById('result-preview');
        const hierarchyString = relations.map(rel => `${rel.parent} > ${rel.child}`).join('\n');
        preview.textContent = hierarchyString || '계층 관계를 설정하면 여기에 결과가 표시됩니다.';

        // hidden input 업데이트
        document.getElementById('hierarchyString').value = hierarchyString;
    }

    // 확인 다이얼로그 표시
    function showConfirmDialog() {
        const errorDiv = document.getElementById('validation-error');
        if (errorDiv.style.display === 'block') {
            showToast('유효성 검증 오류를 먼저 해결해주세요.', 'error');
            return;
        }

        const rows = document.querySelectorAll('.relation-row');
        const relations = [];

        rows.forEach(row => {
            const parent = row.querySelector('.parent-role').value;
            const child = row.querySelector('.child-role').value;
            if (parent && child) {
                relations.push({parent, child});
            }
        });

        if (relations.length === 0) {
            showToast('최소 하나 이상의 관계를 설정해주세요.', 'warning');
            return;
        }

        // 확인 다이얼로그에 시각화 표시
        let mermaidCode = 'graph TD\n';
        relations.forEach((rel, index) => {
            mermaidCode += `    ${rel.parent} --> ${rel.child}\n`;
        });

        const confirmMermaid = document.getElementById('confirm-mermaid');
        confirmMermaid.textContent = mermaidCode;
        mermaid.init(undefined, confirmMermaid);

        // 영향 분석
        const impactDiv = document.getElementById('impact-analysis');
        const allRoles = new Set();
        relations.forEach(rel => {
            allRoles.add(rel.parent);
            allRoles.add(rel.child);
        });

        impactDiv.innerHTML = `
            <div class="bg-slate-800 p-4 rounded-lg">
                <h4 class="font-bold text-slate-200 mb-2">영향 분석</h4>
                <p class="text-slate-400">• 총 ${relations.length}개의 관계가 설정됩니다.</p>
                <p class="text-slate-400">• ${allRoles.size}개의 역할이 계층 구조에 포함됩니다.</p>
                ${document.getElementById('isActive').checked ?
            '<p class="text-yellow-400 mt-2"><i class="fas fa-exclamation-triangle mr-1"></i> 이 계층이 활성화되면 기존 활성 계층은 비활성화됩니다.</p>' : ''}
            </div>
        `;

        document.getElementById('confirm-dialog').style.display = 'flex';
    }

    function hideConfirmDialog() {
        document.getElementById('confirm-dialog').style.display = 'none';
    }

    function submitForm() {
        document.getElementById('hierarchyForm').submit();
    }

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('add-row-btn').addEventListener('click', addRow);

        // 기존 데이터가 있으면 검증 및 시각화
        setTimeout(() => {
            validateAndUpdate();
        }, 500);
    });
</script>
</body>
</html>