<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <th:block th:replace="~{fragments/common-head :: head-elements(pageTitle='ì§€ëŠ¥í˜• ì •ì±… ë¹Œë”')}"></th:block>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-container {
            width: calc(100vw - 40px);
            height: calc(100vh - 40px);
            background: linear-gradient(135deg,
            rgba(5, 8, 16, 0.98) 0%,
            rgba(10, 15, 28, 0.95) 25%,
            rgba(15, 23, 42, 0.92) 50%,
            rgba(10, 15, 28, 0.95) 75%,
            rgba(5, 8, 16, 0.98) 100%);
            border-radius: 1.5rem;
            border: 1px solid rgba(99, 102, 241, 0.3);
            box-shadow:
                    0 32px 64px -12px rgba(0, 0, 0, 0.7),
                    0 0 80px rgba(99, 102, 241, 0.2);
            overflow: hidden;
            position: relative;
        }

        .modal-content {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 2rem;
        }

        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            font-size: 1rem;
            cursor: pointer;
            z-index: 10000;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .close-button:hover {
            background: rgba(220, 38, 38, 0.9);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6);
        }

        /* ì •ì±… ë¹Œë” ì»¨í…Œì´ë„ˆ - ëª¨ë‹¬ ë‚´ë¶€ìš© */
        .policy-builder-container {
            background: transparent;
            border-radius: 0;
            border: none;
            box-shadow: none;
            padding: 0;
            margin: 0;
        }

        /* AI ì…ë ¥ ì„¹ì…˜ - ë¯¸ë˜í˜• ë””ìì¸ */
        .ai-input-section {
            background: linear-gradient(135deg,
            rgba(99, 102, 241, 0.15) 0%,
            rgba(139, 92, 246, 0.10) 50%,
            rgba(79, 70, 229, 0.15) 100%);
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
        }

        .ai-input-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
            transparent,
            rgba(99, 102, 241, 0.3),
            transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .ai-textarea {
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(71, 85, 105, 0.4);
            border-radius: 1rem;
            padding: 1.5rem;
            color: #e2e8f0;
            font-size: 1rem;
            line-height: 1.6;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            resize: none;
        }

        .ai-textarea:focus {
            outline: none;
            border-color: #6366f1;
            background: rgba(15, 23, 42, 0.95);
            box-shadow:
                    0 0 0 4px rgba(99, 102, 241, 0.15),
                    0 0 30px rgba(99, 102, 241, 0.2);
            transform: translateY(-2px);
        }

        .ai-generate-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            border: none;
            border-radius: 1rem;
            padding: 1rem 2rem;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .ai-generate-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 35px rgba(99, 102, 241, 0.6);
        }

        .ai-generate-btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        /* íŒ”ë ˆíŠ¸ ì„¹ì…˜ - í˜„ëŒ€ì  ì¹´ë“œ ë””ìì¸ */
        .palette-section {
            background: linear-gradient(135deg,
            rgba(15, 23, 42, 0.9) 0%,
            rgba(30, 41, 59, 0.7) 100%);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 1.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            transition: all 0.3s ease;
        }

        .palette-section:hover {
            border-color: rgba(99, 102, 241, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .palette-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(71, 85, 105, 0.2);
        }

        .palette-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(79, 70, 229, 0.2));
            color: #a5b4fc;
            font-size: 1.125rem;
        }

        .palette-title {
            font-size: 1.125rem;
            font-weight: 700;
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* ğŸ”§ ê°œì„ : íŒ”ë ˆíŠ¸ ì»¨í…Œì´ë„ˆ - ê°€ë¡œ ìŠ¤í¬ë¡¤ ì§€ì› */
        .palette-container {
            max-height: 16rem; /* ì„¸ë¡œ ë†’ì´ ì œí•œ */
            overflow-x: auto; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ í™œì„±í™” */
            overflow-y: auto; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ ìœ ì§€ */
            padding-right: 0.5rem;
        }

        /* íŒ”ë ˆíŠ¸ ì»¨í…Œì´ë„ˆ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        .palette-container::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .palette-container::-webkit-scrollbar-track {
            background: rgba(71, 85, 105, 0.2);
            border-radius: 3px;
        }

        .palette-container::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.5);
            border-radius: 3px;
            transition: background 0.3s ease;
        }

        .palette-container::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.7);
        }

        .palette-container::-webkit-scrollbar-corner {
            background: rgba(71, 85, 105, 0.2);
        }

        /* íŒ”ë ˆíŠ¸ ì•„ì´í…œ - 3D íš¨ê³¼ (ê°€ë¡œ ìŠ¤í¬ë¡¤ ì œê±°) */
        .palette-item {
            background: linear-gradient(135deg,
            rgba(30, 41, 59, 0.8) 0%,
            rgba(51, 65, 85, 0.6) 100%);
            border: 2px solid rgba(71, 85, 105, 0.3);
            border-radius: 1rem;
            padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
            cursor: grab;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 0.875rem;
            position: relative;
            backdrop-filter: blur(10px);
            min-width: max-content; /* ğŸ”§ ì½˜í…ì¸  í¬ê¸°ì— ë§ê²Œ ìµœì†Œ ë„ˆë¹„ ì„¤ì • */
            white-space: nowrap; /* ğŸ”§ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }

        /* íŒ”ë ˆíŠ¸ ì•„ì´í…œ ë‚´ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .palette-item span {
            white-space: nowrap;
            flex-shrink: 0; /* í…ìŠ¤íŠ¸ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ */
        }

        /* íŒ”ë ˆíŠ¸ ì•„ì´í…œ ì•„ì´ì½˜ */
        .palette-item i {
            flex-shrink: 0; /* ì•„ì´ì½˜ì´ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ */
        }

        .palette-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg,
            rgba(99, 102, 241, 0.1),
            rgba(139, 92, 246, 0.05));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .palette-item:hover {
            background: linear-gradient(135deg,
            rgba(99, 102, 241, 0.2) 0%,
            rgba(139, 92, 246, 0.15) 100%);
            border-color: rgba(99, 102, 241, 0.5);
            transform: translateX(8px) translateY(-2px);
            box-shadow:
                    0 8px 25px rgba(99, 102, 241, 0.3),
                    -4px 0 15px rgba(99, 102, 241, 0.2);
        }

        .palette-item:hover::before {
            opacity: 1;
        }

        .palette-item:active {
            cursor: grabbing;
            transform: translateX(4px) translateY(-1px) scale(0.98);
        }

        .palette-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: rgba(30, 41, 59, 0.4);
            transform: none !important;
            filter: grayscale(0.7);
        }

        .palette-item.preselected {
            border: 2px solid rgba(34, 197, 94, 0.6);
            background: linear-gradient(135deg,
            rgba(34, 197, 94, 0.15) 0%,
            rgba(22, 163, 74, 0.1) 100%);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }

        /* AI ì„ íƒëœ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .palette-item.ai-selected {
            border: 2px solid rgba(34, 197, 94, 0.7) !important;
            background: linear-gradient(135deg,
            rgba(34, 197, 94, 0.2) 0%,
            rgba(16, 185, 129, 0.15) 50%,
            rgba(5, 150, 105, 0.2) 100%) !important;
            box-shadow: 
                0 0 25px rgba(34, 197, 94, 0.4),
                0 4px 15px rgba(34, 197, 94, 0.3) !important;
            animation: aiSelectedPulse 2s ease-in-out infinite;
            position: relative;
        }

        .palette-item.ai-selected::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, 
                rgba(34, 197, 94, 0.6), 
                rgba(16, 185, 129, 0.4), 
                rgba(34, 197, 94, 0.6));
            border-radius: 1rem;
            z-index: -1;
            opacity: 0.7;
            animation: aiSelectedBorder 3s linear infinite;
        }

        @keyframes aiSelectedPulse {
            0%, 100% {
                box-shadow: 
                    0 0 25px rgba(34, 197, 94, 0.4),
                    0 4px 15px rgba(34, 197, 94, 0.3);
            }
            50% {
                box-shadow: 
                    0 0 35px rgba(34, 197, 94, 0.6),
                    0 6px 20px rgba(34, 197, 94, 0.5);
            }
        }

        @keyframes aiSelectedBorder {
            0% {
                background: linear-gradient(45deg, 
                    rgba(34, 197, 94, 0.6), 
                    rgba(16, 185, 129, 0.4), 
                    rgba(34, 197, 94, 0.6));
            }
            33% {
                background: linear-gradient(45deg, 
                    rgba(16, 185, 129, 0.4), 
                    rgba(34, 197, 94, 0.6), 
                    rgba(16, 185, 129, 0.4));
            }
            66% {
                background: linear-gradient(45deg, 
                    rgba(34, 197, 94, 0.6), 
                    rgba(5, 150, 105, 0.5), 
                    rgba(34, 197, 94, 0.6));
            }
            100% {
                background: linear-gradient(45deg, 
                    rgba(34, 197, 94, 0.6), 
                    rgba(16, 185, 129, 0.4), 
                    rgba(34, 197, 94, 0.6));
            }
        }

        .palette-item.ai-selected:hover {
            transform: translateX(8px) translateY(-2px) scale(1.02) !important;
            box-shadow: 
                0 0 40px rgba(34, 197, 94, 0.6),
                0 8px 25px rgba(34, 197, 94, 0.4) !important;
        }

        /* ìº”ë²„ìŠ¤ ì˜ì—­ - ë“œë¡­ì¡´ ê°œì„  */
        .canvas-zone {
            min-height: 8rem;
            background: linear-gradient(135deg,
            rgba(15, 23, 42, 0.6) 0%,
            rgba(30, 41, 59, 0.4) 100%);
            border: 3px dashed rgba(71, 85, 105, 0.4);
            border-radius: 1.25rem;
            padding: 1.5rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            backdrop-filter: blur(15px);
        }

        .canvas-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center,
            rgba(99, 102, 241, 0.1) 0%,
            transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 1rem;
        }

        .canvas-zone.drag-over {
            background: linear-gradient(135deg,
            rgba(99, 102, 241, 0.2) 0%,
            rgba(139, 92, 246, 0.15) 100%);
            border-color: rgba(99, 102, 241, 0.8);
            border-style: solid;
            transform: scale(1.02);
            box-shadow:
                    0 0 40px rgba(99, 102, 241, 0.4),
                    inset 0 0 30px rgba(99, 102, 241, 0.1);
        }

        .canvas-zone.drag-over::before {
            opacity: 1;
        }

        .canvas-placeholder {
            text-align: center;
            color: #64748b;
            font-size: 0.925rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 5rem;
            gap: 0.5rem;
        }

        .canvas-placeholder i {
            font-size: 1.5rem;
            opacity: 0.6;
            animation: float 3s ease-in-out infinite;
        }

        /* ì •ì±… ì¹© - í˜„ëŒ€ì  ì•Œì•½ í˜•íƒœ */
        .policy-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.625rem;
            background: linear-gradient(135deg,
            rgba(99, 102, 241, 0.25) 0%,
            rgba(139, 92, 246, 0.2) 50%,
            rgba(79, 70, 229, 0.25) 100%);
            color: #c7d2fe;
            border: 1px solid rgba(99, 102, 241, 0.4);
            padding: 0.625rem 1.125rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 600;
            margin: 0.375rem;
            animation: chipSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2);
        }

        @keyframes chipSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .policy-chip:hover {
            background: linear-gradient(135deg,
            rgba(99, 102, 241, 0.35) 0%,
            rgba(139, 92, 246, 0.3) 50%,
            rgba(79, 70, 229, 0.35) 100%);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .remove-chip-btn {
            background: none;
            border: none;
            color: #f87171;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0;
            margin-left: 0.25rem;
            transition: all 0.2s ease;
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-chip-btn:hover {
            color: #fca5a5;
            background: rgba(239, 68, 68, 0.2);
            transform: scale(1.2);
        }

        /* ì†ì„± íŒ¨ë„ - í˜„ëŒ€ì  í¼ */
        .properties-panel {
            background: linear-gradient(135deg,
            rgba(15, 23, 42, 0.9) 0%,
            rgba(30, 41, 59, 0.8) 100%);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 1.5rem;
            padding: 2rem;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modern-input {
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(71, 85, 105, 0.4);
            border-radius: 0.875rem;
            padding: 0.875rem 1.125rem;
            color: #e2e8f0;
            font-size: 0.925rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .modern-input:focus {
            outline: none;
            border-color: #6366f1;
            background: rgba(15, 23, 42, 0.95);
            box-shadow:
                    0 0 0 3px rgba(99, 102, 241, 0.15),
                    0 4px 15px rgba(99, 102, 241, 0.2);
            transform: translateY(-1px);
        }

        .modern-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #cbd5e1, #94a3b8);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* AI í† ê¸€ - í˜„ëŒ€ì  ìŠ¤ìœ„ì¹˜ */
        .ai-toggle-container {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 1rem;
            padding: 1.25rem;
            margin: 1rem 0;
        }

        .modern-checkbox {
            appearance: none;
            width: 3rem;
            height: 1.5rem;
            background: rgba(71, 85, 105, 0.5);
            border-radius: 1rem;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modern-checkbox::before {
            content: '';
            position: absolute;
            top: 0.125rem;
            left: 0.125rem;
            width: 1.25rem;
            height: 1.25rem;
            background: white;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .modern-checkbox:checked {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
        }

        .modern-checkbox:checked::before {
            transform: translateX(1.5rem);
        }

        /* ìŠ¬ë¼ì´ë” - í˜„ëŒ€ì  ë””ìì¸ */
        .modern-slider {
            appearance: none;
            width: 100%;
            height: 0.5rem;
            background: rgba(71, 85, 105, 0.5);
            border-radius: 1rem;
            outline: none;
            margin: 1rem 0;
        }

        .modern-slider::-webkit-slider-thumb {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
            transition: all 0.3s ease;
        }

        .modern-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.6);
        }

        /* ì €ì¥ ë²„íŠ¼ - í˜„ëŒ€ì  CTA */
        .save-button {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            border: none;
            border-radius: 1rem;
            padding: 1rem 2rem;
            color: white;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
        }

        .save-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }

        .save-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(34, 197, 94, 0.6);
        }

        .save-button:hover::before {
            left: 100%;
        }

        /* í”„ë¦¬ë·° íŒ¨ë„ - í¬ê¸° í™•ëŒ€ */
        .preview-panel {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 1rem;
            padding: 2rem;
            margin-top: 1.5rem;
            backdrop-filter: blur(15px);
            min-height: 300px; /* ìµœì†Œ ë†’ì´ ì„¤ì • */
        }

        .preview-content {
            font-size: 1rem; /* í°íŠ¸ í¬ê¸° ì¦ê°€ */
            line-height: 1.8; /* ì¤„ ê°„ê²© ì¦ê°€ */
            color: #cbd5e1;
        }

        .preview-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 0.75rem;
            border-left: 4px solid rgba(99, 102, 241, 0.5);
        }

        .preview-label {
            font-weight: 700;
            color: #e2e8f0;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .policy-chip-preview {
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            padding: 0.25rem 0.625rem;
            border-radius: 1rem;
            font-size: 0.8125rem;
            font-weight: 500;
        }

        .policy-chip-preview.condition {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .policy-chip-preview.ai {
            background: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
        }

        /* ì»¨í…ìŠ¤íŠ¸ ì¸ë””ì¼€ì´í„° */
        .context-indicator {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(22, 163, 74, 0.2));
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.4);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.8125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            backdrop-filter: blur(10px);
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(34, 197, 94, 0.6);
            }
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 1024px) {
            .policy-builder-container {
                margin: 1rem;
                border-radius: 1.5rem;
            }

            .palette-section {
                padding: 1rem;
            }

            .properties-panel {
                padding: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .policy-builder-container {
                margin: 0.5rem;
                padding: 1rem;
            }

            .ai-input-section {
                padding: 1.5rem;
            }

            .palette-item {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }

            .canvas-zone {
                min-height: 6rem;
                padding: 1rem;
            }
        }

        /* ë¡œë”© ìƒíƒœ */
        .loading-state {
            pointer-events: none;
            opacity: 0.7;
        }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen font-sans">

<div th:insert="~{fragments/header :: header}"></div>

<!-- ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ -->
<div class="modal-overlay">
    <div class="modal-container">
        <!-- ë‹«ê¸° ë²„íŠ¼ -->
        <button class="close-button" title="ë‹«ê¸°">
            <i class="fas fa-times"></i>
        </button>

        <!-- ëª¨ë‹¬ ì½˜í…ì¸  -->
        <div class="modal-content">
            <div class="policy-builder-container relative">
                <div th:if="${resourceContext}" class="context-indicator">
                    <i class="fas fa-link"></i>
                    <span>ë¦¬ì†ŒìŠ¤ ì»¨í…ìŠ¤íŠ¸ ì¸ì§€ë¨</span>
                </div>

                <!-- í—¤ë” ì„¹ì…˜ -->
                <div class="mb-8">
                    <h1 class="text-4xl font-bold text-gradient mb-2">ì§€ëŠ¥í˜• ì •ì±… ë¹Œë”</h1>
                    <p class="text-lg text-dark-muted">AIì™€ ì‹œê°ì  ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì •êµí•œ ì ‘ê·¼ ì œì–´ ì •ì±…ì„ êµ¬ì„±í•©ë‹ˆë‹¤.</p>
                </div>

                <!-- AI ì…ë ¥ ì„¹ì…˜ -->
                <div class="ai-input-section">
                    <h2 class="text-2xl font-bold mb-4 text-gradient">
                        <i class="fas fa-magic mr-3"></i>AIë¡œ ì •ì±… ìƒì„±í•˜ê¸°
                    </h2>
                    <textarea
                            id="naturalLanguageInput"
                            class="ai-textarea w-full"
                            rows="3"
                            placeholder="ì˜ˆì‹œ) ê°œë°œíŒ€ì€ í‰ì¼ ì—…ë¬´ì‹œê°„ì—ë§Œ 'ê³ ê° ë°ì´í„° ì¡°íšŒ' ê¶Œí•œì„ ê°€ì§‘ë‹ˆë‹¤."></textarea>
                    <button id="generateByAiBtn" class="ai-generate-btn w-full mt-4">
                        <i class="fas fa-robot mr-3"></i>AIë¡œ ì •ì±… ì´ˆì•ˆ ìƒì„±
                    </button>
                </div>
                <div id="ai-thought-process-container" class="dark-card p-6 mb-6 hidden transition-all duration-500 ease-out">
                    <h3 class="font-semibold text-dark-secondary mb-3">
                        <i class="fas fa-brain mr-2 text-gradient"></i>AI ë¶„ì„ ê³¼ì • (ì‹¤ì‹œê°„ ë¡œê·¸)
                    </h3>
                    <pre id="ai-thought-process"
                         class="w-full h-48 bg-black/50 p-4 rounded-md text-xs text-slate-300 font-mono overflow-y-auto dark-scroll whitespace-pre-wrap"></pre>
                </div>
                <!-- ë©”ì¸ ì½˜í…ì¸  ê·¸ë¦¬ë“œ -->
                <div class="grid grid-cols-12 gap-6">
                    <!-- íŒ”ë ˆíŠ¸ ì˜ì—­ -->
                    <div class="col-span-12 lg:col-span-3 space-y-4">
                        <!-- ì£¼ì²´ íŒ”ë ˆíŠ¸ -->
                        <div class="palette-section">
                            <div class="palette-header">
                                <div class="palette-icon"><i class="fas fa-user-shield"></i></div>
                                <h3 class="palette-title">ì—­í•  (Who)</h3>
                            </div>
                            <div id="roles-palette" class="palette-container dark-scroll">
                                <div th:each="role : ${allRoles}"
                                     class="palette-item"
                                     draggable="true"
                                     th:data-info="${role.id + ':' + role.roleName}"
                                     data-type="role">
                                    <i class="fas fa-user-shield text-purple-400"></i>
                                    <span th:text="${role.roleName}"></span>
                                </div>
                            </div>
                        </div>

                        <!-- ê¶Œí•œ íŒ”ë ˆíŠ¸ -->
                        <div class="palette-section">
                            <div class="palette-header">
                                <div class="palette-icon">
                                    <i class="fas fa-key"></i>
                                </div>
                                <h3 class="palette-title">ê¶Œí•œ (What)</h3>
                            </div>
                            <div id="permissionsPalette" class="palette-container dark-scroll">
                                <div th:if="${preselectedPermission != null}"
                                     class="palette-item preselected"
                                     draggable="true"
                                     th:data-info="${preselectedPermission.id + ':' + preselectedPermission.friendlyName}"
                                     data-type="permission">
                                    <i class="fas fa-check-circle text-green-400"></i>
                                    <span class="text-green-400 font-semibold" th:text="${preselectedPermission.friendlyName}"></span>
                                </div>
                                <div th:each="perm : ${allPermissions}"
                                     th:if="${preselectedPermission == null or perm.id != preselectedPermission.id}"
                                     class="palette-item"
                                     draggable="true"
                                     th:data-info="${perm.id + ':' + perm.friendlyName}"
                                     data-type="permission">
                                    <i class="fas fa-key text-yellow-400"></i>
                                    <span th:text="${perm.friendlyName}"></span>
                                </div>
                            </div>
                        </div>

                        <!-- ì¡°ê±´ íŒ”ë ˆíŠ¸ -->
                        <div class="palette-section">
                            <div class="palette-header">
                                <div class="palette-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <h3 class="palette-title">ì¡°ê±´ (When)</h3>
                            </div>
                            <div id="conditionsPalette" class="palette-container dark-scroll">
                                <div th:each="cond : ${allConditions}"
                                     class="palette-item"
                                     th:classappend="${!cond.isCompatible} ? 'disabled' : ''"
                                     th:draggable="${cond.isCompatible}"
                                     th:data-info="${cond.id + ':' + cond.name}"
                                     th:data-spel="${cond.spelTemplate}" th:title="${!cond.isCompatible ? 'í˜„ì¬ ë¦¬ì†ŒìŠ¤ ì»¨í…ìŠ¤íŠ¸ì—ì„œëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ì¡°ê±´ì…ë‹ˆë‹¤.' : cond.description}"
                                     data-type="condition">
                                    <i class="fas fa-clock text-orange-400"></i>
                                    <span th:text="${cond.name}"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ìº”ë²„ìŠ¤ ì˜ì—­ -->
                    <div class="col-span-12 lg:col-span-6">
                        <div class="dark-card p-6">
                            <h2 class="text-2xl font-bold text-gradient mb-6">ì •ì±… êµ¬ì„±</h2>
                            <div class="space-y-6">
                                <div>
                                    <label class="modern-label">ì´ ì—­í• (ë“¤)ì€ (WHO)</label>
                                    <div id="roles-canvas" class="canvas-zone" data-canvas-type="role">
                                        <div class="canvas-placeholder">
                                            <i class="fas fa-hand-pointer"></i>
                                            <span>ì™¼ìª½ì—ì„œ ì—­í• ì„ ë“œë˜ê·¸í•˜ì—¬ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš”</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="modern-label">ì´ëŸ¬í•œ ê¶Œí•œìœ¼ë¡œ (WHAT)</label>
                                    <div id="permissions-canvas" class="canvas-zone" data-canvas-type="permission">
                                        <div class="canvas-placeholder">
                                            <i class="fas fa-hand-pointer"></i>
                                            <span>ì™¼ìª½ì—ì„œ ê¶Œí•œì„ ë“œë˜ê·¸í•˜ì—¬ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš”</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="modern-label">ì•„ë˜ ì¡°ê±´ì´ ë§Œì¡±ë  ë•Œ (WHEN)</label>
                                    <div id="conditions-canvas" class="canvas-zone" data-canvas-type="condition">
                                        <div class="canvas-placeholder">
                                            <i class="fas fa-hand-pointer"></i>
                                            <span>ì™¼ìª½ì—ì„œ ì¡°ê±´ì„ ë“œë˜ê·¸í•˜ì—¬ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš”</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì†ì„± ë° ì €ì¥ íŒ¨ë„ -->
                    <div class="col-span-12 lg:col-span-3">
                        <div class="properties-panel">
                            <h2 class="text-xl font-bold text-gradient mb-6">ì†ì„± ë° ì €ì¥</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="policyNameInput" class="modern-label">ì •ì±… ì´ë¦„</label>
                                    <input type="text" id="policyNameInput" class="modern-input w-full" placeholder="ì˜ˆ: ê°œë°œíŒ€ ì†ŒìŠ¤ì½”ë“œ ì ‘ê·¼ ì •ì±…">
                                </div>
                                <div>
                                    <label for="policyDescTextarea" class="modern-label">ì„¤ëª…</label>
                                    <textarea id="policyDescTextarea" class="modern-input w-full" rows="3" placeholder="ì •ì±…ì˜ ëª©ì ê³¼ ì ìš© ë²”ìœ„ë¥¼ ì„¤ëª…í•˜ì„¸ìš”"></textarea>
                                </div>
                                <div>
                                    <label for="policyEffectSelect" class="modern-label">íš¨ê³¼</label>
                                    <select id="policyEffectSelect" class="modern-input w-full">
                                        <option value="ALLOW">í—ˆìš© (ALLOW)</option>
                                        <option value="DENY">ê±°ë¶€ (DENY)</option>
                                    </select>
                                </div>

                                <!-- AI ë™ì  ë¶„ì„ ì„¹ì…˜ -->
                                <div class="ai-toggle-container">
                                    <h3 class="font-semibold text-dark-secondary mb-3">
                                        <i class="fas fa-robot mr-2 text-gradient"></i>AI ë™ì  ë¶„ì„
                                    </h3>
                                    <label for="aiEnabledCheckbox" class="flex items-center justify-between cursor-pointer">
                                        <span class="text-sm text-dark-primary">AI ì‹¤ì‹œê°„ ë¦¬ìŠ¤í¬ í‰ê°€</span>
                                        <input type="checkbox" id="aiEnabledCheckbox" class="modern-checkbox">
                                    </label>
                                    <div id="trustScoreContainer" class="hidden mt-4">
                                        <label for="trustScoreSlider" class="text-sm font-medium text-dark-muted mb-2 block">
                                            í—ˆìš© ì‹ ë¢°ë„: <span id="trustScoreValueSpan" class="font-bold text-indigo-400">70</span>ì  ì´ìƒ
                                        </label>
                                        <input type="range" id="trustScoreSlider" min="0" max="100" value="70" class="modern-slider">
                                    </div>
                                </div>

                                <div>
                                    <label for="customSpelInput" class="modern-label">
                                        <i class="fas fa-code mr-2"></i>ì¶”ê°€ ì¡°ê±´ (ì „ë¬¸ê°€ìš©)
                                    </label>
                                    <textarea id="customSpelInput" class="modern-input w-full font-mono text-xs" rows="2" placeholder="e.g., #request.remoteAddr == '1.2.3.4'"></textarea>
                                </div>
                            </div>

                            <button id="savePolicyBtn" class="save-button mt-6">
                                <i class="fas fa-save mr-2"></i>ì •ì±… ìƒì„±í•˜ê¸°
                            </button>
                        </div>

                        <!-- ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° -->
                        <div class="preview-panel">
                            <h3 class="font-semibold text-dark-secondary mb-4 text-lg">
                                <i class="fas fa-eye mr-2"></i>ì‹¤ì‹œê°„ ì •ì±… ë¯¸ë¦¬ë³´ê¸°
                            </h3>
                            <div id="policyPreview" class="preview-content">
                                <div class="text-center text-dark-muted py-8">
                                    <i class="fas fa-puzzle-piece text-4xl mb-4 opacity-50"></i>
                                    <div>ì •ì±… êµ¬ì„± ìš”ì†Œë¥¼ ì¶”ê°€í•˜ë©´</div>
                                    <div>ìƒì„¸í•œ ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </main>

                <div th:insert="~{fragments/footer :: footer}"></div>
                <script th:src="@{/js/toast.js}"></script>
                <script th:src="@{/js/toast.js}"></script>
                <script th:inline="javascript">
                    // ì „ì—­ ë³€ìˆ˜ ì„¤ì • (JavaScript ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
                    window.resourceContext = /*[[${resourceContext}]]*/ null;
                    window.preselectedPermission = /*[[${preselectedPermission}]]*/ null;

                    // ğŸ”¥ ì¤‘ìš”: ëª¨ë“  ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì •
                    window.allRoles = /*[[${allRoles}]]*/ [];
                    window.allPermissions = /*[[${allPermissions}]]*/ [];
                    window.allConditions = /*[[${allConditions}]]*/ [];

                    // ë””ë²„ê¹…ìš© ë¡œê·¸
                    console.log('ğŸŒŸ ì „ì—­ ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ:', {
                        allRoles: window.allRoles?.length || 0,
                        allPermissions: window.allPermissions?.length || 0,
                        allConditions: window.allConditions?.length || 0,
                        resourceContext: window.resourceContext,
                        preselectedPermission: window.preselectedPermission
                    });
                </script>
                <script th:src="@{/js/policy-builder.js}"></script>
            </div>
        </div>
    </div>
</div>
</body>
</html>