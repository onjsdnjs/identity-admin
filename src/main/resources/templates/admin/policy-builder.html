<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <th:block th:replace="~{fragments/common-head :: head-elements(pageTitle='지능형 정책 빌더')}"></th:block>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        /* 팔레트 아이템 - 다크 테마 스타일 */
        .palette-section {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .palette-item {
            background: rgba(30, 41, 59, 0.6);
            border: 2px solid rgba(71, 85, 105, 0.3);
            border-radius: 0.75rem;
            padding: 0.875rem 1rem;
            margin-bottom: 0.5rem;
            cursor: move;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .palette-item:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.3);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .palette-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(30, 41, 59, 0.3);
        }

        .palette-item.disabled:hover {
            transform: none;
            border-color: rgba(71, 85, 105, 0.3);
        }

        /* 캔버스 영역 - 워크벤치 스타일 매칭 */
        .canvas-zone {
            min-height: 10rem;
            background: rgba(30, 41, 59, 0.4);
            border: 2px dashed rgba(71, 85, 105, 0.5);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .canvas-zone.drag-over {
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.5);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }

        /* 정책 칩 - 현대적 스타일 */
        .policy-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(79, 70, 229, 0.2));
            color: #a5b4fc;
            border: 1px solid rgba(99, 102, 241, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            margin: 0.25rem;
            animation: chipFadeIn 0.3s ease-out;
            transition: all 0.3s ease;
        }

        @keyframes chipFadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .policy-chip:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(79, 70, 229, 0.3));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .policy-chip button {
            background: none;
            border: none;
            color: #f87171;
            font-size: 1.125rem;
            cursor: pointer;
            padding: 0 0 0 0.5rem;
            transition: all 0.2s;
        }

        .policy-chip button:hover {
            color: #fca5a5;
            transform: scale(1.2);
        }

        /* 컨텍스트 인지 표시 */
        .context-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.3);
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* 검색 입력 필드 */
        .search-input {
            width: 100%;
            background: rgba(30, 41, 59, 0.6);
            border: 2px solid rgba(71, 85, 105, 0.3);
            color: #e2e8f0;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #6366f1;
            background: rgba(30, 41, 59, 0.8);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* 섹션 헤더 */
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }

        .section-icon {
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.625rem;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(79, 70, 229, 0.2));
        }
    </style>
</head>
<body class="flex flex-col min-h-screen font-sans">

<div th:insert="~{fragments/header :: header}"></div>
<div id="toast-container" class="fixed top-5 right-5 z-50"></div>

<div class="flex flex-1 overflow-hidden">
    <aside th:insert="~{fragments/admin-menu :: menu}"></aside>

    <main class="flex-1 p-6 lg:p-8 overflow-y-auto">
        <div class="dark-card relative">
            <div th:if="${resourceContext}" class="context-indicator">
                <i class="fas fa-link"></i>
                <span>리소스 컨텍스트 인지됨</span>
            </div>

            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gradient">지능형 정책 빌더</h1>
                <p class="text-dark-muted mt-2">AI와 시각적 도구를 사용하여 정교한 접근 제어 정책을 구성합니다.</p>
            </div>

            <div class="dark-card p-6 mb-6">
                <h2 class="text-xl font-bold mb-4 text-gradient"><i class="fas fa-magic-sparkles mr-2"></i>AI로 정책 생성하기</h2>
                <textarea id="natural-language-input" class="dark-input w-full" rows="3" placeholder="예시) 개발팀은 평일 업무시간에만 '고객 데이터 조회' 권한을 가집니다."></textarea>
                <button id="generate-by-ai-btn" class="dark-btn-primary w-full mt-3"><i class="fas fa-cogs mr-2"></i>AI로 정책 초안 생성</button>
            </div>

            <div class="grid grid-cols-12 gap-6">
                <div class="col-span-3 space-y-4">
                    <div class="palette-section">
                        <h3 class="font-bold text-lg text-dark-primary mb-3">주체 (Who)</h3>
                        <div id="subjects-palette" class="max-h-60 overflow-y-auto dark-scroll pr-2">
                            <div th:each="user : ${allUsers}" class="palette-item" draggable="true" th:data-info="${'USER:' + user.id + ':' + user.name}" data-type="subject"><i class="fas fa-user text-blue-400"></i><span th:text="${user.name}"></span></div>
                            <div th:each="group : ${allGroups}" class="palette-item" draggable="true" th:data-info="${'GROUP:' + group.id + ':' + group.name}" data-type="subject"><i class="fas fa-users text-purple-400"></i><span th:text="${group.name}"></span></div>
                        </div>
                    </div>
                    <div class="palette-section">
                        <h3 class="font-bold text-lg text-dark-primary mb-3">권한 (What)</h3>
                        <div id="permissions-palette" class="max-h-60 overflow-y-auto dark-scroll pr-2">
                            <div th:if="${preselectedPermission != null}" class="palette-item border-2 border-green-500/50 bg-green-500/10" draggable="true" th:data-info="${preselectedPermission.id + ':' + preselectedPermission.friendlyName}" data-type="permission">
                                <i class="fas fa-check-circle text-green-400"></i><span class="text-green-400 font-semibold" th:text="${preselectedPermission.friendlyName}"></span>
                            </div>
                            <div th:each="perm : ${allPermissions}" th:if="${preselectedPermission == null or perm.id != preselectedPermission.id}" class="palette-item" draggable="true" th:data-info="${perm.id + ':' + perm.friendlyName}" data-type="permission">
                                <i class="fas fa-key text-yellow-400"></i><span th:text="${perm.friendlyName}"></span>
                            </div>
                        </div>
                    </div>
                    <div class="palette-section">
                        <h3 class="font-bold text-lg text-dark-primary mb-3">조건 (When)</h3>
                        <div id="conditions-palette" class="max-h-60 overflow-y-auto dark-scroll pr-2">
                            <div th:each="cond : ${allConditions}" class="palette-item" th:classappend="${!cond.isCompatible} ? 'disabled' : ''" th:draggable="${cond.isCompatible}" th:data-info="${cond.id + ':' + cond.name}" th:data-required-variables="${#strings.listJoin(cond.requiredVariables, ',')}" th:title="${!cond.isCompatible ? '현재 리소스 컨텍스트에서는 사용할 수 없는 조건입니다.' : cond.description}" data-type="condition">
                                <i class="fas fa-clock text-orange-400"></i><span th:text="${cond.name}"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-span-6 dark-card p-6">
                    <h2 class="text-xl font-bold text-gradient mb-6">정책 구성</h2>
                    <div class="space-y-6">
                        <div>
                            <label class="font-semibold text-dark-secondary mb-2">이 주체들이 (IF)</label>
                            <div id="subjects-canvas" class="canvas-zone" data-canvas-type="subject">
                            </div>
                        </div>
                        <div>
                            <label class="font-semibold text-dark-secondary mb-2">이러한 권한으로 (WHAT)</label>
                            <div id="permissions-canvas" class="canvas-zone" data-canvas-type="permission">
                            </div>
                        </div>
                        <div>
                            <label class="font-semibold text-dark-secondary mb-2">아래 조건이 만족될 때 (WHEN)</label>
                            <div id="conditions-canvas" class="canvas-zone" data-canvas-type="condition">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-span-3 dark-card p-6 flex flex-col">
                    <h2 class="text-xl font-bold text-gradient mb-6">속성 및 저장</h2>
                    <div class="space-y-4 flex-grow">
                        <div>
                            <label for="policy-name" class="dark-label">정책 이름</label>
                            <input type="text" id="policy-name" class="dark-input" placeholder="예: 개발팀 소스코드 접근 정책">
                        </div>
                        <div>
                            <label for="policy-desc" class="dark-label">설명</label>
                            <textarea id="policy-desc" class="dark-input" rows="3" placeholder="정책의 목적과 적용 범위를 설명하세요"></textarea>
                        </div>
                        <div>
                            <label class="dark-label">효과</label>
                            <select id="policy-effect" class="dark-select">
                                <option value="ALLOW">허용 (ALLOW)</option>
                                <option value="DENY">거부 (DENY)</option>
                            </select>
                        </div>

                        <div class="dark-divider"></div>

                        <div class="space-y-2">
                            <h3 class="font-semibold text-dark-secondary"><i class="fas fa-robot mr-2 text-gradient"></i>AI 동적 분석</h3>
                            <label for="ai-risk-assessment-enabled" class="flex items-center space-x-2 cursor-pointer text-sm">
                                <input type="checkbox" id="ai-risk-assessment-enabled" class="modern-checkbox">
                                <span class="text-dark-primary">AI 실시간 리스크 평가 활성화</span>
                            </label>
                            <div id="trust-score-slider-container" class="hidden pl-2 pt-2">
                                <label for="required-trust-score" class="text-xs font-medium text-dark-muted">
                                    허용 신뢰도: <span id="trust-score-value" class="font-bold text-indigo-400">70</span>점 이상
                                </label>
                                <input type="range" id="required-trust-score" min="0" max="100" value="70" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>

                        <div class="dark-divider"></div>

                        <div>
                            <label for="custom-condition-spel" class="font-semibold text-dark-secondary">
                                <i class="fas fa-code mr-2"></i>추가 조건 (전문가용)
                            </label>
                            <textarea id="custom-condition-spel" class="dark-input font-mono text-xs mt-1" rows="2" placeholder="e.g., #request.remoteAddr == '1.2.3.4'"></textarea>
                        </div>
                    </div>

                    <div class="mt-6">
                        <button id="save-policy-btn" class="dark-btn-primary w-full justify-center">
                            <i class="fas fa-save mr-2"></i>정책 생성하기
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div th:insert="~{fragments/footer :: footer}"></div>
<script th:src="@{/js/toast.js}"></script>
<script th:inline="javascript">
    const resourceContext = /*[[${resourceContext}]]*/ null;
    const preselectedPermission = /*[[${preselectedPermission}]]*/ null;
</script>
<script th:src="@{/js/policy-builder.js}"></script>
</body>
</html>