<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <th:block th:replace="~{fragments/common-head :: head-elements(pageTitle='기능 카탈로그 관리')}"></th:block>
    <style>
        .tech-identifier { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; }
        .details-box { display: none; background-color: #f9fafb; border-left: 3px solid #e5e7eb; }
        .toggle-switch { width: 40px; height: 24px; }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-app-light-gray">
<div th:insert="~{fragments/header :: header}"></div>
<div id="toast-container" class="fixed top-5 right-5 z-50"></div>

<div class="flex flex-1 overflow-hidden">
    <aside th:insert="~{fragments/admin-menu :: menu}"></aside>

    <main class="flex-1 p-6 lg:p-8 overflow-y-auto">
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-3xl font-bold text-app-primary">기능 카탈로그 관리</h1>
            <form th:action="@{/admin/catalog/refresh}" method="post">
                <button type="submit" class="px-4 py-2 bg-blue-100 text-blue-800 text-sm font-semibold rounded-lg hover:bg-blue-200">
                    기능 다시 스캔
                </button>
            </form>
        </div>
        <p class="text-slate-600 my-2 max-w-4xl">
            시스템의 기술 리소스를 관리자가 이해하기 쉬운 **기능 단위**로 정의합니다.
            여기서 '워크벤치에 공개'로 설정된 기능만 **통합 워크벤치**의 정책 생성 화면에 나타납니다.
        </p>
        <div class="mt-4 text-sm">
            <a th:href="@{/admin/resources}" class="text-slate-500 hover:text-slate-700 hover:underline">
                &raquo; (개발자용) 원본 기술 리소스 목록 보기
            </a>
        </div>


        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg mt-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <input type="checkbox" id="selectAllCheckbox" class="h-4 w-4 rounded border-gray-300 text-app-accent focus:ring-app-accent mr-2">
                    <label for="selectAllCheckbox" class="text-sm font-medium">전체 선택</label>
                </div>
                <div>
                    <button id="batch-manage-btn" class="px-3 py-1.5 bg-gray-600 text-white text-xs font-semibold rounded-md hover:bg-gray-700">선택 항목 워크벤치에 공개</button>
                    <button id="batch-unmanage-btn" class="px-3 py-1.5 bg-gray-200 text-gray-800 text-xs font-semibold rounded-md hover:bg-gray-300">선택 항목 숨기기</button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-app-secondary text-white">
                    <tr>
                        <th class="p-3 w-12 text-center">선택</th>
                        <th class="p-3 w-24 text-center">워크벤치 공개</th>
                        <th class="p-3 text-left w-1/3">기능 이름 및 설명</th>
                        <th class="p-3 text-left">연결된 시스템 리소스 (자동 탐지)</th>
                        <th class="p-3 text-left w-20">작업</th>
                    </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                    <th:block th:each="res : ${resources}">
                        <tr class="hover:bg-gray-50 align-top">
                            <form th:action="@{/admin/catalog/{id}/update(id=${res.id})}" method="post">
                                <td class="p-3 text-center">
                                    <input type="checkbox" name="resourceId" th:value="${res.id}" class="resource-checkbox h-4 w-4 rounded border-gray-300 text-app-accent focus:ring-app-accent">
                                </td>
                                <td class="p-3 text-center">
                                    <input type="hidden" name="managed" value="false" />
                                    <input type="checkbox" name="managed" value="true" th:checked="${res.isManaged}" class="toggle-switch">
                                </td>
                                <td class="p-3">
                                    <input type="text" name="friendlyName" th:value="${res.friendlyName}" class="form-input w-full font-semibold mb-1">
                                    <textarea name="description" class="form-input w-full text-xs" rows="2" th:text="${res.description}" placeholder="이 기능에 대한 설명을 입력하세요..."></textarea>
                                </td>
                                <td class="p-3">
                                    <div class="tech-identifier text-xs text-slate-700" th:text="${res.resourceIdentifier}"></div>
                                    <button type="button" class="text-xs text-blue-600 hover:underline mt-1" onclick="toggleDetails(this)">상세 정보 보기</button>
                                    <div class="details-box p-2 mt-1 text-xs">
                                        - Type: <span th:text="${res.resourceType}"></span><br>
                                        - Owner: <span th:text="${res.serviceOwner}"></span><br>
                                        - Params: <span th:text="${res.parameterTypes}"></span><br>
                                        - Returns: <span th:text="${res.returnType}"></span>
                                    </div>
                                </td>
                                <td class="p-3">
                                    <button type="submit" class="w-full px-3 py-2 bg-app-accent text-white font-medium rounded-md hover:bg-app-accent-hover">저장</button>
                                </td>
                            </form>
                        </tr>
                    </th:block>
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<script th:inline="javascript">
    function toggleDetails(button) {
        const detailsBox = button.nextElementSibling;
        if (detailsBox.style.display === 'none') {
            detailsBox.style.display = 'block';
            button.textContent = '상세 정보 숨기기';
        } else {
            detailsBox.style.display = 'none';
            button.textContent = '상세 정보 보기';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // CSRF 토큰 설정
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

        // 전체 선택 체크박스 로직
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const resourceCheckboxes = document.querySelectorAll('.resource-checkbox');

        selectAllCheckbox.addEventListener('change', (e) => {
            resourceCheckboxes.forEach(cb => cb.checked = e.target.checked);
        });

        // 일괄 처리 버튼 로직
        const handleBatchUpdate = (isManaged) => {
            const selectedIds = Array.from(resourceCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => parseInt(cb.value));

            if (selectedIds.length === 0) {
                showToast('항목을 먼저 선택해주세요.', 'info');
                return;
            }

            fetch('/admin/catalog/batch-update-managed', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({ ids: selectedIds, isManaged: isManaged })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast('오류: ' + data.error, 'error');
                    } else {
                        showToast(data.message, 'success');
                        setTimeout(() => window.location.reload(), 1500);
                    }
                })
                .catch(err => {
                    showToast('요청 처리 중 오류가 발생했습니다.', 'error');
                    console.error(err);
                });
        };

        document.getElementById('batch-manage-btn').addEventListener('click', () => handleBatchUpdate(true));
        document.getElementById('batch-unmanage-btn').addEventListener('click', () => handleBatchUpdate(false));

        // Flash 메시지 토스트로 표시
        const message = /*[[${message}]]*/ null;
        if (message) {
            showToast(message, 'success');
        }
        const errorMessage = /*[[${errorMessage}]]*/ null;
        if (errorMessage) {
            showToast(errorMessage, 'error');
        }
    });
</script>

<script th:src="@{/js/toast.js}"></script>
</body>
</html>